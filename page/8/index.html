<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.cjwind.idv.tw","root":"/","images":"/images","scheme":"Gemini","version":"8.2.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta property="og:type" content="website">
<meta property="og:title" content="cjwind&#39;s note">
<meta property="og:url" content="http://www.cjwind.idv.tw/page/8/index.html">
<meta property="og:site_name" content="cjwind&#39;s note">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="cjwind">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://www.cjwind.idv.tw/page/8/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>
<title>cjwind's note</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-62800351-2"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-62800351-2');
      }
    </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="cjwind's note" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">cjwind's note</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-projects"><a href="/projects/" rel="section"><i class="fa fa-code fa-fw"></i>Projects</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">cjwind</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">174</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/cjwind" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cjwind" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:cwentsai@gmail.com" title="E-Mail → mailto:cwentsai@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.youtube.com/channel/UCJCXRf8LQCjX8Ydlrd1i0vw" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCJCXRf8LQCjX8Ydlrd1i0vw" rel="noopener" target="_blank"><i class="fab fa-youtube fa-fw"></i>YouTube</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/chia-wen-tsai-b1605166/" title="Linkedin → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;chia-wen-tsai-b1605166&#x2F;" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i>Linkedin</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://ko-fi.com/C0C812X69" title="Donate → https:&#x2F;&#x2F;ko-fi.com&#x2F;C0C812X69" rel="noopener" target="_blank"><i class="fas fa-donate fa-fw"></i>Donate</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Dynamic-Linking-PIC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Dynamic-Linking-PIC/" class="post-title-link" itemprop="url">Dynamic Linking Position-independent Code（PIC）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-07 23:45:15" itemprop="dateCreated datePublished" datetime="2017-03-07T23:45:15+08:00">2017-03-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2017-03-18 22:47:00" itemprop="dateModified" datetime="2017-03-18T22:47:00+08:00">2017-03-18</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Dynamic-Linking-PIC/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Dynamic-Linking-PIC/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Dynamic-linking-遇到的問題"><a href="#Dynamic-linking-遇到的問題" class="headerlink" title="Dynamic linking 遇到的問題"></a>Dynamic linking 遇到的問題</h2><p>Dynamic linking 想解決的一大問題是 memory 浪費。直覺想法是如果能讓不同 process 都會使用到的 library 在 memory 只有一份就能節省空間。對不同 process 來說 library 的內容必須是相同的才能共用。library 主要是 instruction 以及 data （executable file 都是這樣辣），data 不可能在 process 間共用，因為每個 process 都需要它自己的 data，不然會互相干擾（好像有古代系統是共用的…），因此能共用的主要是 instruction。</p>
<p>excutable file、object file 以及 library 等 binary file 中 instruction 會以不同定址方式 access symbol，絕對定址模式會將 symbol 的 virtual address 寫進 instruction，相對定址模式則跟 instruction 及 data 之間的相對位置有關。也就是說，無論是 executable file 還是要共用的 library，instruction 都可能涉及 symbol 的 address 資訊。</p>
<p>不像 executable file，library 在 compile time 無法知道會被 load 到哪，因為系統裡會有多個 library，如果各自指定要 load 到哪可能會撞到，所以得等到 runtime 由系統決定，其中 symbol 位置也要到 runtime 才能決定。這使得 compile time 無法修改 instruction 內的 address 資訊，也就是 static linking 做的事。</p>
<p>另一方面，即使在 runtime 修改 library 的 instruction，也會造成不同 process 實際上有不同的 library instruction 而無法共用。例如 library A 使用某個外部 symbol <code>foo</code>，process 1 跟 process 2 都有使用 library A，但它們分別以 library B 跟 library C 來提供 symbol <code>foo</code> 給 library A。此時，process 1 的 <code>foo</code> 的 address 在 library B，process 2 則在 library C，runtime 修改 library A instruction 會有兩種版本。</p>
<h2 id="Position-independent-Code（PIC）"><a href="#Position-independent-Code（PIC）" class="headerlink" title="Position-independent Code（PIC）"></a>Position-independent Code（PIC）</h2><p>上面的問題基本上是因為 instruction 裡含有 symbol address 相關資訊，就出現 Position-independent Code（PIC）「與位置無關的程式碼」來解決。</p>
<p>由於 process 有各自的 data section 而且可以修改裡面的值，PIC 將 library 會被修改的部分（instruction 中的 address 相關資訊）放到 data section，讓 instruction 跟 address 無關而能共用。</p>
<p>library 的 address reference 可分為 library 內與跨 library，各自又再分成 reference 到資料或 instruction（function call 或 jump），處理方式主要依據 library 內或跨 library 而不同。</p>
<h3 id="library-內"><a href="#library-內" class="headerlink" title="library 內"></a>library 內</h3><p>同一 library 內的 instruction 跟資料間相對位置是固定的，所以可以用相對位置來 access 資料、call function 或 jump。</p>
<h3 id="跨-library"><a href="#跨-library" class="headerlink" title="跨 library"></a>跨 library</h3><p>ELF 在 data section 放一個指向其他 library 的 symbol 的 pointer array，稱為 Global Offset Table（GOT）。instruction 可以從 GOT 找到對應的 element 進行間接 reference。先找到 GOT（不同平台有不同作法，可以用相對定址也可以有特殊 register 記錄），再從 GOT 以及 instruction 所知道的「該 symbol 在 GOT 裡的 offset」得到 element，最後得到 symbol address。</p>
<p>GOT 由 linker 載入 library 時填填內容，同樣使用 relocation table 的 entry 標示需要修改的位置及如何修改。relocation table 不會管 offset 指向的位置是什麼，改那個地方的內容就對了，放 GOT element 就會改 GOT。至於變數與 call function 的差別在 GOT element 存的是變數還是 function 的 address，不過實際上 ELF 有區分變數跟 function，這部份下一篇再說。</p>
<p>雖然 GOT 可以達到 PIC，但代價是 access symbol 的速度會變慢，因為要先找到 GOT 再間接定址。</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight c"><figcaption><span>foo.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> sum;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span>* p = (<span class="keyword">int</span>*)<span class="number">123</span>;    <span class="comment">// avoid to be placed in .bss</span></span><br><span class="line">    p = &amp;sum;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">$ gcc -<span class="keyword">c</span> foo.<span class="keyword">c</span></span><br><span class="line">$ gcc -fPIC -<span class="keyword">c</span> foo.<span class="keyword">c</span> -o foo.o.pic</span><br></pre></td></tr></table></figure>
<p>有 <code>-fPIC</code> 跟沒有的差別：</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">$ objdump -d foo.o</span><br><span class="line"></span><br><span class="line">foo.o:     file format elf<span class="number">64</span>-<span class="keyword">x</span><span class="number">86</span><span class="number">-64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of <span class="keyword">section</span> .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;foo&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">55</span>                      push   <span class="variable">%rbp</span></span><br><span class="line">   <span class="number">1</span>:   <span class="number">48</span> <span class="number">89</span> e<span class="number">5</span>                mov    <span class="variable">%rsp</span><span class="punctuation">,</span><span class="variable">%rbp</span></span><br><span class="line">   <span class="number">4</span>:   <span class="number">89</span> <span class="number">7</span>d fc                mov    <span class="variable">%edi</span><span class="punctuation">,</span><span class="number">-0</span><span class="keyword">x</span><span class="number">4</span>(<span class="variable">%rbp</span>)</span><br><span class="line">   <span class="number">7</span>:   <span class="number">89</span> <span class="number">75</span> f<span class="number">8</span>                mov    <span class="variable">%esi</span><span class="punctuation">,</span><span class="number">-0</span><span class="keyword">x</span><span class="number">8</span>(<span class="variable">%rbp</span>)</span><br><span class="line"><span class="symbol">   a:</span>   <span class="number">48</span> <span class="keyword">c</span><span class="number">7</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    movq   $<span class="number">0x0</span><span class="punctuation">,</span><span class="number">0x0</span>(<span class="variable">%rip</span>)        # <span class="number">15</span> &lt;foo+<span class="number">0x15</span>&gt;</span><br><span class="line">  <span class="number">11</span>:   <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> </span><br><span class="line">  <span class="number">15</span>:   <span class="number">8</span>b <span class="number">55</span> fc                mov    <span class="number">-0</span><span class="keyword">x</span><span class="number">4</span>(<span class="variable">%rbp</span>)<span class="punctuation">,</span><span class="variable">%edx</span></span><br><span class="line">  <span class="number">18</span>:   <span class="number">8</span>b <span class="number">45</span> f<span class="number">8</span>                mov    <span class="number">-0</span><span class="keyword">x</span><span class="number">8</span>(<span class="variable">%rbp</span>)<span class="punctuation">,</span><span class="variable">%eax</span></span><br><span class="line">  <span class="number">1</span>b:   <span class="number">01</span> d<span class="number">0</span>                   <span class="keyword">add</span>    <span class="variable">%edx</span><span class="punctuation">,</span><span class="variable">%eax</span></span><br><span class="line">  <span class="number">1</span>d:   <span class="number">5</span>d                      pop    <span class="variable">%rbp</span></span><br><span class="line">  <span class="number">1</span>e:   <span class="keyword">c</span><span class="number">3</span>                      retq   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ objdump -d foo.o.pic</span><br><span class="line"></span><br><span class="line">foo.o.pic:     file format elf<span class="number">64</span>-<span class="keyword">x</span><span class="number">86</span><span class="number">-64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of <span class="keyword">section</span> .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;foo&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">55</span>                      push   <span class="variable">%rbp</span></span><br><span class="line">   <span class="number">1</span>:   <span class="number">48</span> <span class="number">89</span> e<span class="number">5</span>                mov    <span class="variable">%rsp</span><span class="punctuation">,</span><span class="variable">%rbp</span></span><br><span class="line">   <span class="number">4</span>:   <span class="number">89</span> <span class="number">7</span>d fc                mov    <span class="variable">%edi</span><span class="punctuation">,</span><span class="number">-0</span><span class="keyword">x</span><span class="number">4</span>(<span class="variable">%rbp</span>)</span><br><span class="line">   <span class="number">7</span>:   <span class="number">89</span> <span class="number">75</span> f<span class="number">8</span>                mov    <span class="variable">%esi</span><span class="punctuation">,</span><span class="number">-0</span><span class="keyword">x</span><span class="number">8</span>(<span class="variable">%rbp</span>)</span><br><span class="line"><span class="symbol">   a:</span>   <span class="number">48</span> <span class="number">8</span>b <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(<span class="variable">%rip</span>)<span class="punctuation">,</span><span class="variable">%rax</span>        # <span class="number">11</span> &lt;foo+<span class="number">0x11</span>&gt;</span><br><span class="line">  <span class="number">11</span>:   <span class="number">48</span> <span class="number">89</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="variable">%rax</span><span class="punctuation">,</span><span class="number">0x0</span>(<span class="variable">%rip</span>)        # <span class="number">18</span> &lt;foo+<span class="number">0x18</span>&gt;</span><br><span class="line">  <span class="number">18</span>:   <span class="number">8</span>b <span class="number">55</span> fc                mov    <span class="number">-0</span><span class="keyword">x</span><span class="number">4</span>(<span class="variable">%rbp</span>)<span class="punctuation">,</span><span class="variable">%edx</span></span><br><span class="line">  <span class="number">1</span>b:   <span class="number">8</span>b <span class="number">45</span> f<span class="number">8</span>                mov    <span class="number">-0</span><span class="keyword">x</span><span class="number">8</span>(<span class="variable">%rbp</span>)<span class="punctuation">,</span><span class="variable">%eax</span></span><br><span class="line">  <span class="number">1</span>e:   <span class="number">01</span> d<span class="number">0</span>                   <span class="keyword">add</span>    <span class="variable">%edx</span><span class="punctuation">,</span><span class="variable">%eax</span></span><br><span class="line">  <span class="number">20</span>:   <span class="number">5</span>d                      pop    <span class="variable">%rbp</span></span><br><span class="line">  <span class="number">21</span>:   <span class="keyword">c</span><span class="number">3</span>                      retq   </span><br></pre></td></tr></table></figure>
<p>結果是用 <code>-fPIC</code> compile 出來跟沒有用的 object file 不一樣<del>（好像廢話）</del>，而且沒有 <code>-fPIC</code> 無法 link 成 shared object。</p>
<figure class="highlight nim"><table><tr><td class="code"><pre><span class="line">$ gcc -<span class="literal">shared</span> foo.o -o foo.so</span><br><span class="line">/usr/bin/ld: foo.o: relocation <span class="type">R_X86_64_32S</span> against `sum&#x27; can <span class="keyword">not</span> be used <span class="keyword">when</span> making a <span class="literal">shared</span> <span class="keyword">object</span>; recompile <span class="keyword">with</span> -fPIC</span><br></pre></td></tr></table></figure>
<p>relocation table 如果有 <code>R_X86_64_32S</code> 定址無法變成 DSO。</p>
<figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">$ readelf -r foo.o</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rela.text&#x27; at <span class="built_in">offset</span> <span class="number">0</span>x240 contains <span class="number">2</span> entri<span class="symbol">es:</span></span><br><span class="line">  <span class="built_in">Offset</span>          <span class="built_in">Info</span>           <span class="built_in">Type</span>           Sym. <span class="built_in">Value</span>    Sym. Name + Addend</span><br><span class="line"><span class="number">00000000000</span>d  <span class="number">000300000002</span> R_X86_64_PC32     <span class="number">0000000000000000</span> .data - <span class="number">8</span></span><br><span class="line"><span class="number">000000000011</span>  <span class="number">000</span>a0000000b R_X86_64_32S      <span class="number">0000000000000000</span> <span class="built_in">sum</span> + <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rela.eh_frame&#x27; at <span class="built_in">offset</span> <span class="number">0</span>x270 contains <span class="number">1</span> entri<span class="symbol">es:</span></span><br><span class="line">  <span class="built_in">Offset</span>          <span class="built_in">Info</span>           <span class="built_in">Type</span>           Sym. <span class="built_in">Value</span>    Sym. Name + Addend</span><br><span class="line"><span class="number">000000000020</span>  <span class="number">000200000002</span> R_X86_64_PC32     <span class="number">0000000000000000</span> .<span class="built_in">text</span> + <span class="number">0</span></span><br><span class="line"></span><br><span class="line">$ readelf -r foo.o.pic</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rela.text&#x27; at <span class="built_in">offset</span> <span class="number">0</span>x278 contains <span class="number">2</span> entri<span class="symbol">es:</span></span><br><span class="line">  <span class="built_in">Offset</span>          <span class="built_in">Info</span>           <span class="built_in">Type</span>           Sym. <span class="built_in">Value</span>    Sym. Name + Addend</span><br><span class="line"><span class="number">00000000000</span>d  <span class="number">000</span>b00000009 R_X86_64_GOTPCREL <span class="number">0000000000000000</span> <span class="built_in">sum</span> - <span class="number">4</span></span><br><span class="line"><span class="number">000000000014</span>  <span class="number">000300000002</span> R_X86_64_PC32     <span class="number">0000000000000000</span> .data - <span class="number">4</span></span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rela.eh_frame&#x27; at <span class="built_in">offset</span> <span class="number">0</span>x2a8 contains <span class="number">1</span> entri<span class="symbol">es:</span></span><br><span class="line">  <span class="built_in">Offset</span>          <span class="built_in">Info</span>           <span class="built_in">Type</span>           Sym. <span class="built_in">Value</span>    Sym. Name + Addend</span><br><span class="line"><span class="number">000000000020</span>  <span class="number">000200000002</span> R_X86_64_PC32     <span class="number">0000000000000000</span> .<span class="built_in">text</span> + <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>再看看 shared library 的 section 們，只列出比較相關的部份。</p>
<figure class="highlight tap"><table><tr><td class="code"><pre><span class="line">$ gcc -fPIC -shared -o foo.so foo.c</span><br><span class="line">$ readelf -S foo.so</span><br><span class="line">There are<span class="number"> 27 </span>section headers, starting at offset 0x1170:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  ...</span><br><span class="line">  [ 3] .dynsym           DYNSYM           00000000000001f8  000001f8</span><br><span class="line">      <span class="number"> 0000000000000150 </span><span class="number"> 0000000000000018 </span>  A      <span class="number"> 4 </span>   <span class="number"> 2 </span>    8</span><br><span class="line">  [ 4] .dynstr           STRTAB          <span class="number"> 0000000000000348 </span> 00000348</span><br><span class="line">       00000000000000ab <span class="number"> 0000000000000000 </span>  A      <span class="number"> 0 </span>   <span class="number"> 0 </span>    1</span><br><span class="line">  ...</span><br><span class="line">  [ 7] .rela.dyn         RELA            <span class="number"> 0000000000000430 </span> 00000430</span><br><span class="line">       00000000000000d8 <span class="number"> 0000000000000018 </span>  A      <span class="number"> 3 </span>   <span class="number"> 0 </span>    8</span><br><span class="line">  [ 8] .rela.plt         RELA            <span class="number"> 0000000000000508 </span> 00000508</span><br><span class="line">      <span class="number"> 0000000000000030 </span><span class="number"> 0000000000000018 </span> AI      <span class="number"> 3 </span>  <span class="number"> 10 </span>    8</span><br><span class="line">  ...</span><br><span class="line">  [10] .plt              PROGBITS        <span class="number"> 0000000000000560 </span> 00000560</span><br><span class="line">      <span class="number"> 0000000000000030 </span><span class="number"> 0000000000000010 </span> AX      <span class="number"> 0 </span>   <span class="number"> 0 </span>    16</span><br><span class="line">  ...</span><br><span class="line">  [18] .dynamic          DYNAMIC         <span class="number"> 0000000000200760 </span> 00000760</span><br><span class="line">       00000000000001c0 <span class="number"> 0000000000000010 </span> WA      <span class="number"> 4 </span>   <span class="number"> 0 </span>    8</span><br><span class="line">  [19] .got              PROGBITS        <span class="number"> 0000000000200920 </span> 00000920</span><br><span class="line">      <span class="number"> 0000000000000030 </span><span class="number"> 0000000000000008 </span> WA      <span class="number"> 0 </span>   <span class="number"> 0 </span>    8</span><br><span class="line">  [20] .got.plt          PROGBITS        <span class="number"> 0000000000200950 </span> 00000950</span><br><span class="line">      <span class="number"> 0000000000000028 </span><span class="number"> 0000000000000008 </span> WA      <span class="number"> 0 </span>   <span class="number"> 0 </span>    8</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<h2 id="Lazy-Binding"><a href="#Lazy-Binding" class="headerlink" title="Lazy Binding"></a>Lazy Binding</h2><p>dynamic linking 以犧牲一點效能達到模組使用的靈活度。效能降低發生在兩個地方：程式開始執行時的 linking 工作以及 GOT 帶來的間接定址。</p>
<p>程式裡可能有很多 function 在執行過程中不會或很少被用到，例如錯誤處理跟少用的功能。一開始執行就 link 所有 library 裡的 function 顯然有點浪費，畢竟可能花時間 link 了卻沒用到。如果等到 function 第一次被使用時才 bind symbol（找 symbol、relocate 等等）可以加快程式啟動的速度，這個方法稱為 lazy binding。</p>
<p>ELF 用 Procedure Linkage Table（PLT）來實作 lazy binding。在沒有 lazy binding 前，會藉由 GOT 進行間接跳轉來 access 另一個模組的 function 。有了 lazy binding 表示一開始 load 模組時不會把 GOT 填完，所以使用 GOT 跳轉前要多一層 PLT 的處理：如果 GOT element 沒有值，會先由 dynamic linker 找到該 function 的 address，填入 GOT 後跳去該 function 執行。之後再使用到同一個 function，由於 GOT 裡已經有值，可以直接進行間接跳轉。</p>
<h2 id="Related-posts-amp-Ref"><a href="#Related-posts-amp-Ref" class="headerlink" title="Related posts &amp; Ref"></a>Related posts &amp; Ref</h2><ul>
<li><a href="/Dynamic-Linking-Basic/">Dynamic Linking Basic</a></li>
<li><a href="/Dynamic-Linking-Relocation/">Dynamic Linking Relocation</a></li>
<li><a href="/Shared-Library-Versioning/">Shared Library Versioning</a></li>
<li><a href="/Use-Shared-Library-in-Linux/">Use Shared Library in Linux</a></li>
<li><a href="/Explicit-Runtime-Linking/">Explicit Runtime Linking</a></li>
<li>《程式設計師的自我修養》ch7</li>
<li><a target="_blank" rel="noopener" href="https://www.bottomupcs.com/chapter08.xhtml">https://www.bottomupcs.com/chapter08.xhtml</a></li>
<li><a target="_blank" rel="noopener" href="https://hackmd.io/s/HkK7Uf4Ml">你所不知道的 C 語言：動態連結器篇</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Dynamic-Linking-Basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Dynamic-Linking-Basic/" class="post-title-link" itemprop="url">Dynamic Linking Basic</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-05 21:41:52" itemprop="dateCreated datePublished" datetime="2017-03-05T21:41:52+08:00">2017-03-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2017-03-18 22:47:00" itemprop="dateModified" datetime="2017-03-18T22:47:00+08:00">2017-03-18</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Dynamic-Linking-Basic/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Dynamic-Linking-Basic/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Static-Linking-的問題"><a href="#Static-Linking-的問題" class="headerlink" title="Static Linking 的問題"></a>Static Linking 的問題</h2><p>static link 拆分了可執行檔，讓不同人或組織可以開發自己的 module，最後再 link 成執行檔。隨著系統變複雜，OS 裡有多個 process 在執行，當多個 process 以 static linking 連結相同的 library 時，例如擁有 <code>printf()</code> 的 standard library，memory 會有多份類似的 library 程式碼，造成浪費。</p>
<p>另一個問題是 static linking 不易更新 module。例如 App 這個程式用到 <code>Lib.o</code>，<code>Lib.o</code> 更新時（<code>Lib.o</code> 可能是別人提供的 module，App 開發者無法控制其版本），App 的開發者必須拿 <code>App.o</code> 跟 <code>Lib.o</code> 再 link 成新版 App，再給發佈新版 App。</p>
<h2 id="Dynamic-Linking-基本概念"><a href="#Dynamic-Linking-基本概念" class="headerlink" title="Dynamic Linking 基本概念"></a>Dynamic Linking 基本概念</h2><p>為了解決 static link 在 memory 浪費以及不易更新的問題，最簡單的做法是將程式拆成多個 module，不在 compile 時期 link library，等到執行時才 link。如此一來就能只放一份共用 module 在 memory，需要該 module 的 executable file 就去 link。</p>
<p>不過現實世界總是不那麼美好，dynamic linking 還是會遇到其他問題，例如如果 program A 需要 1.0 版的 module、program B 需要 2.0 版的 module，或者一個程式更新共用 module 之後，其他程式因為 interface 相依性問題就壞了。</p>
<p>Linux 稱 ELF 動態連結檔為 Dynamic Shared Objects（DSO），簡稱 shared object，通常以 <code>.so</code> 為副檔名。Windows 則稱為 Dynamical Linking Library，以 <code>.dll</code> 為副檔名。這系列筆記會混用 DSO、shared object、shared library、module 等詞，皆指動態連結檔。</p>
<h2 id="Usage-in-Linux"><a href="#Usage-in-Linux" class="headerlink" title="Usage in Linux"></a>Usage in Linux</h2><p>先用簡單範例看看 Linux 上如何使用 dynamic link。</p>
<h3 id="source-code"><a href="#source-code" class="headerlink" title="source code"></a>source code</h3><figure class="highlight c"><figcaption><span>foo.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _LIB_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _LIB_H</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>foo.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (a + b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>main.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;lib.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    foo(<span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="compile-amp-link"><a href="#compile-amp-link" class="headerlink" title="compile &amp; link"></a>compile &amp; link</h3><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">$ gcc -fPIC -shared -o lib<span class="selector-class">.so</span> lib.c</span><br><span class="line">$ gcc -o <span class="selector-tag">main</span><span class="selector-class">.dyn</span> <span class="selector-tag">main</span><span class="selector-class">.c</span> ./lib.so</span><br></pre></td></tr></table></figure>
<p><code>-shared</code> 表示要編出 shared object。link 出 <code>main.dyn</code> 時，linker 會看 <code>foo()</code> 是定義在其他 static object file 還是在 DSO 裡，如果在 DSO 裡就會標示這個 symbol 為 dynamic linking，等到 load 才進行 symbol relocation。上面第二行要寫 <code>./lib.so</code> 是為了讓 linker 知道 <code>foo()</code> 是在 DSO 裡，而且 <code>main.dyn</code> 也會記錄 <code>lib.so</code> 的路徑。</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">$ ldd <span class="selector-tag">main</span><span class="selector-class">.dyn</span> </span><br><span class="line">linux-vdso<span class="selector-class">.so</span>.<span class="number">1</span> (<span class="number">0</span>x00007fff29986000)</span><br><span class="line">./lib<span class="selector-class">.so</span> (<span class="number">0</span>x00007febdc1b6000)</span><br><span class="line">libc<span class="selector-class">.so</span>.<span class="number">6</span> =&gt; /lib/x86_64-linux-gnu/libc<span class="selector-class">.so</span>.<span class="number">6</span> (<span class="number">0</span>x00007febdbe0b000)</span><br><span class="line">/lib64/ld-linux-x86-<span class="number">64</span><span class="selector-class">.so</span>.<span class="number">2</span> (<span class="number">0</span>x00007febdc3b7000)</span><br></pre></td></tr></table></figure>
<p>比較常用的寫法是 <code>-l</code> 指定 library、<code>-L</code> 指定找 library 的 path，例如 <code>-lfoo -L./</code> 會找 <code>libfoo.so</code> 來 link，尋找順序則是先找目前目錄再找系統預設目錄。這種寫法在 <code>main.dyn</code> 裡只會記錄 <code>lib.so</code>、不會有路徑，執行時會從系統以及相關參數所設的路徑找 library，如果找不到會跳 error。</p>
<figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line">$ readelf -h lib.so | grep <span class="keyword">Type</span></span><br><span class="line">  <span class="keyword">Type</span>:                              DYN (<span class="keyword">Shared</span> object <span class="keyword">file</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line">$ readelf -s lib.so</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.dynsym&#x27;</span> <span class="keyword">contains</span> <span class="number">13</span> entries:</span><br><span class="line">   Num:    <span class="keyword">Value</span>          <span class="built_in">Size</span> <span class="keyword">Type</span>    <span class="keyword">Bind</span>   Vis      Ndx <span class="keyword">Name</span></span><br><span class="line">     ...</span><br><span class="line">     <span class="number">8</span>: <span class="number">0000000000000660</span>    <span class="number">20</span> FUNC    GLOBAL <span class="keyword">DEFAULT</span>   <span class="number">11</span> foo</span><br><span class="line">     ...</span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> <span class="keyword">contains</span> <span class="number">53</span> entries:</span><br><span class="line">   Num:    <span class="keyword">Value</span>          <span class="built_in">Size</span> <span class="keyword">Type</span>    <span class="keyword">Bind</span>   Vis      Ndx <span class="keyword">Name</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="number">46</span>: <span class="number">0000000000000660</span>    <span class="number">20</span> FUNC    GLOBAL <span class="keyword">DEFAULT</span>   <span class="number">11</span> foo</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p><code>lib.so</code> 的 symbol table 有給 dynamic link 用的 <code>.dynsym</code> section 跟一般的 <code>.symtab</code> section。</p>
<figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line">$ readelf -s main.dyn</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.dynsym&#x27;</span> <span class="keyword">contains</span> <span class="number">12</span> entries:</span><br><span class="line">   Num:    <span class="keyword">Value</span>          <span class="built_in">Size</span> <span class="keyword">Type</span>    <span class="keyword">Bind</span>   Vis      Ndx <span class="keyword">Name</span></span><br><span class="line">     ...</span><br><span class="line">     <span class="number">4</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    GLOBAL <span class="keyword">DEFAULT</span>  UND foo</span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> <span class="keyword">contains</span> <span class="number">65</span> entries:</span><br><span class="line">   Num:    <span class="keyword">Value</span>          <span class="built_in">Size</span> <span class="keyword">Type</span>    <span class="keyword">Bind</span>   Vis      Ndx <span class="keyword">Name</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="number">56</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    GLOBAL <span class="keyword">DEFAULT</span>  UND foo</span><br></pre></td></tr></table></figure>
<p>重點來啦，<code>main.dyn</code> 是 dynamic link <code>lib.so</code> 的可執行檔，它的 symbol table 標示了 <code>foo</code> 仍然是 undefined，而且在 <code>.dynsym</code> 裡也有這個 symbol。<code>.dynsym</code> section 不會出現在其他 object file 裡的 symbol。</p>
<h3 id="virtual-memory-space"><a href="#virtual-memory-space" class="headerlink" title="virtual memory space"></a>virtual memory space</h3><p>編出 static linking 版本的執行檔：<code>ld -e main main.o lib.o -o main.st</code> 。執行後 <code>cat /proc/&lt;pid&gt;/maps</code> 可以看到 process 的 virtual memory space：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">00400000</span>-<span class="number">00401000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409244</span>                           /home/cjw/source/dynamic-link/main.st</span><br><span class="line"><span class="attribute">7ffeaa7bb000</span>-<span class="number">7</span>ffeaa<span class="number">7</span>dc<span class="number">000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [stack]</span></span><br><span class="line"><span class="attribute">7ffeaa7ed000</span>-<span class="number">7</span>ffeaa<span class="number">7</span>ef<span class="number">000</span> r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [vdso]</span></span><br><span class="line"><span class="attribute">7ffeaa7ef000</span>-<span class="number">7</span>ffeaa<span class="number">7</span>f<span class="number">1000</span> r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [vvar]</span></span><br><span class="line"><span class="attribute">ffffffffff600000</span>-ffffffffff<span class="number">601000</span> r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                 <span class="meta"> [vsyscall]</span></span><br></pre></td></tr></table></figure>
<p>簡單明瞭 load 進 <code>main.st</code>，比較 dynamic linking 的 <code>main.dyn</code>：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">00400000</span>-<span class="number">00401000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409246</span>                           /home/cjw/source/dynamic-link/main.dyn</span><br><span class="line"><span class="attribute">00600000</span>-<span class="number">00601000</span> rw-p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409246</span>                           /home/cjw/source/dynamic-link/main.dyn</span><br><span class="line"><span class="attribute">7fdee17b3000</span>-<span class="number">7</span>fdee<span class="number">1954000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864382</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/libc-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fdee1954000</span>-<span class="number">7</span>fdee<span class="number">1</span>b<span class="number">54000</span> ---p <span class="number">001</span>a<span class="number">1000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864382</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/libc-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fdee1b54000</span>-<span class="number">7</span>fdee<span class="number">1</span>b<span class="number">58000</span> r--p <span class="number">001</span>a<span class="number">1000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864382</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/libc-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fdee1b58000</span>-<span class="number">7</span>fdee<span class="number">1</span>b<span class="number">5</span>a<span class="number">000</span> rw-p <span class="number">001</span>a<span class="number">5000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864382</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/libc-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fdee1b5a000</span>-<span class="number">7</span>fdee<span class="number">1</span>b<span class="number">5</span>e<span class="number">000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line"><span class="attribute">7fdee1b5e000</span>-<span class="number">7</span>fdee<span class="number">1</span>b<span class="number">5</span>f<span class="number">000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409245</span>                   /home/cjw/source/dynamic-link/lib.so</span><br><span class="line"><span class="attribute">7fdee1b5f000</span>-<span class="number">7</span>fdee<span class="number">1</span>d<span class="number">5</span>e<span class="number">000</span> ---p <span class="number">00001000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409245</span>                   /home/cjw/source/dynamic-link/lib.so</span><br><span class="line"><span class="attribute">7fdee1d5e000</span>-<span class="number">7</span>fdee<span class="number">1</span>d<span class="number">5</span>f<span class="number">000</span> rw-p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409245</span>                   /home/cjw/source/dynamic-link/lib.so</span><br><span class="line"><span class="attribute">7fdee1d5f000</span>-<span class="number">7</span>fdee<span class="number">1</span>d<span class="number">7</span>f<span class="number">000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864371</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/ld-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fdee1f5e000</span>-<span class="number">7</span>fdee<span class="number">1</span>f<span class="number">61000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line"><span class="attribute">7fdee1f7d000</span>-<span class="number">7</span>fdee<span class="number">1</span>f<span class="number">7</span>f<span class="number">000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line"><span class="attribute">7fdee1f7f000</span>-<span class="number">7</span>fdee<span class="number">1</span>f<span class="number">80000</span> r--p <span class="number">00020000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864371</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/ld-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fdee1f80000</span>-<span class="number">7</span>fdee<span class="number">1</span>f<span class="number">81000</span> rw-p <span class="number">00021000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864371</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/ld-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fdee1f81000</span>-<span class="number">7</span>fdee<span class="number">1</span>f<span class="number">82000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line"><span class="attribute">7fffbbf58000</span>-<span class="number">7</span>fffbbf<span class="number">79000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [stack]</span></span><br><span class="line"><span class="attribute">7fffbbfce000</span>-<span class="number">7</span>fffbbfd<span class="number">0000</span> r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [vdso]</span></span><br><span class="line"><span class="attribute">7fffbbfd0000</span>-<span class="number">7</span>fffbbfd<span class="number">2000</span> r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [vvar]</span></span><br><span class="line"><span class="attribute">ffffffffff600000</span>-ffffffffff<span class="number">601000</span> r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                 <span class="meta"> [vsyscall]</span></span><br></pre></td></tr></table></figure>
<p>除了 <code>main.dyn</code> 跟 <code>lib.so</code> 之外也 load 進 C Runtime <code>/lib/x86_64-linux-gnu/libc-2.19.so</code> 以及動態連結器 <code>/lib/x86_64-linux-gnu/ld-2.19.so</code>。</p>
<p>那麼 DSO 會 load 到哪呢？從下面 <code>lib.so</code> 的 segment 來看，它會被 load 到的 address 是 <code>0x00000000</code>，但顯然這個 address 不合法。compile time 無法知道 DSO 會被 load 去哪，是在 runtime 才決定（最簡單的想法是 OS 找到一塊放得下 DSO 的 memory 放）。這也是可以想像的，如果 DSO 跟 executable file 一樣編譯時就決定自己要 load 到某個 address，多個 DSO 在系統裡可能會互撞。kill 掉原本的 <code>main.dyn</code> 再跑一次會發現 load <code>lib.so</code> 的 address 不一樣。</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">$ readelf -l lib.so</span><br><span class="line"></span><br><span class="line">Elf file type is DYN (Shared <span class="selector-tag">object</span> file)</span><br><span class="line">Entry point <span class="number">0</span>x560</span><br><span class="line">There are <span class="number">6</span> program headers, starting at offset <span class="number">64</span></span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset             VirtAddr           PhysAddr</span><br><span class="line">                 FileSiz            MemSiz              Flags  Align</span><br><span class="line">  LOAD           <span class="number">0</span>x0000000000000000 <span class="number">0</span>x0000000000000000 <span class="number">0</span>x0000000000000000</span><br><span class="line">                 <span class="number">0</span>x0000000000000704 <span class="number">0</span>x0000000000000704  R E    <span class="number">200000</span></span><br><span class="line">  LOAD           <span class="number">0</span>x0000000000000708 <span class="number">0</span>x0000000000200708 <span class="number">0</span>x0000000000200708</span><br><span class="line">                 <span class="number">0</span>x0000000000000230 <span class="number">0</span>x0000000000000238  RW     <span class="number">200000</span></span><br><span class="line">  DYNAMIC        <span class="number">0</span>x0000000000000720 <span class="number">0</span>x0000000000200720 <span class="number">0</span>x0000000000200720</span><br><span class="line">                 <span class="number">0</span>x00000000000001c0 <span class="number">0</span>x00000000000001c0  RW     <span class="number">8</span></span><br><span class="line">  NOTE           <span class="number">0</span>x0000000000000190 <span class="number">0</span>x0000000000000190 <span class="number">0</span>x0000000000000190</span><br><span class="line">                 <span class="number">0</span>x0000000000000024 <span class="number">0</span>x0000000000000024  R      <span class="number">4</span></span><br><span class="line">  GNU_EH_FRAME   <span class="number">0</span>x0000000000000680 <span class="number">0</span>x0000000000000680 <span class="number">0</span>x0000000000000680</span><br><span class="line">                 <span class="number">0</span>x000000000000001c <span class="number">0</span>x000000000000001c  R      <span class="number">4</span></span><br><span class="line">  GNU_STACK      <span class="number">0</span>x0000000000000000 <span class="number">0</span>x0000000000000000 <span class="number">0</span>x0000000000000000</span><br><span class="line">                 <span class="number">0</span>x0000000000000000 <span class="number">0</span>x0000000000000000  RW     <span class="number">10</span></span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   <span class="number">00</span>     <span class="selector-class">.note</span><span class="selector-class">.gnu</span><span class="selector-class">.build-id</span> <span class="selector-class">.gnu</span><span class="selector-class">.hash</span> <span class="selector-class">.dynsym</span> <span class="selector-class">.dynstr</span> <span class="selector-class">.gnu</span><span class="selector-class">.version</span> <span class="selector-class">.gnu</span><span class="selector-class">.version_r</span> <span class="selector-class">.rela</span><span class="selector-class">.dyn</span> <span class="selector-class">.rela</span><span class="selector-class">.plt</span> <span class="selector-class">.init</span> <span class="selector-class">.plt</span> <span class="selector-class">.text</span> <span class="selector-class">.fini</span> <span class="selector-class">.eh_frame_hdr</span> .eh_frame</span><br><span class="line">   <span class="number">01</span>     <span class="selector-class">.init_array</span> <span class="selector-class">.fini_array</span> <span class="selector-class">.jcr</span> <span class="selector-class">.dynamic</span> <span class="selector-class">.got</span> <span class="selector-class">.got</span><span class="selector-class">.plt</span> <span class="selector-class">.data</span> .bss</span><br><span class="line">   <span class="number">02</span>     .dynamic</span><br><span class="line">   <span class="number">03</span>     <span class="selector-class">.note</span><span class="selector-class">.gnu</span>.build-id</span><br><span class="line">   <span class="number">04</span>     .eh_frame_hdr</span><br><span class="line">   <span class="number">05</span></span><br></pre></td></tr></table></figure>
<h2 id="Related-posts-amp-Ref"><a href="#Related-posts-amp-Ref" class="headerlink" title="Related posts &amp; Ref"></a>Related posts &amp; Ref</h2><ul>
<li><a href="/Dynamic-Linking-PIC/">Dynamic Linking PIC</a></li>
<li><a href="/Dynamic-Linking-Relocation/">Dynamic Linking Relocation</a></li>
<li><a href="/Shared-Library-Versioning/">Shared Library Versioning</a></li>
<li><a href="/Use-Shared-Library-in-Linux/">Use Shared Library in Linux</a></li>
<li><a href="/Explicit-Runtime-Linking/">Explicit Runtime Linking</a></li>
<li>《程式設計師的自我修養》ch7</li>
<li><a target="_blank" rel="noopener" href="https://www.bottomupcs.com/chapter08.xhtml">https://www.bottomupcs.com/chapter08.xhtml</a></li>
<li><a target="_blank" rel="noopener" href="https://hackmd.io/s/HkK7Uf4Ml">你所不知道的 C 語言：動態連結器篇</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Linux-Desktop-Nvidia-driver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Linux-Desktop-Nvidia-driver/" class="post-title-link" itemprop="url">Linux Desktop 1 Install Nvidia driver</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-05 17:21:54" itemprop="dateCreated datePublished" datetime="2017-03-05T17:21:54+08:00">2017-03-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Linux-Desktop-Nvidia-driver/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Linux-Desktop-Nvidia-driver/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>裝 Linux 桌面系統來用用，為了避免以後可能重灌還要重找一次，記下些安裝過程。</p>
<p>雖然有 open source 版的顯卡 driver，但我還是覺得裝 Nvidia 的比較好，而且不另外裝 driver 根本調不動螢幕解析度……</p>
<p>原本想裝 LMDE 2 然後用<a href="/solve-servo-blank/">這篇</a>的方法裝 Nvidia 的 driver，但不知道為什麼就是無法進文字模式。設開機進文字模式或不裝桌面開機會卡在半路開不了，直接關掉桌面系統還是停在無法操作的狀態。</p>
<p>後來發現 Debian 蠻好裝 Nvidia driver 的，而且 Mint 不只顯卡需要額外 driver 連 audio 都要<del>搞到我有點崩潰</del>，就乾脆換用 Debian 8 Jessie了。</p>
<h2 id="Nvidia-driver-installation-under-Debian-8"><a href="#Nvidia-driver-installation-under-Debian-8" class="headerlink" title="Nvidia driver installation under Debian 8"></a>Nvidia driver installation under Debian 8</h2><p>雖然 <a target="_blank" rel="noopener" href="https://wiki.debian.org/NvidiaGraphicsDrivers#Version_367.44_.28via_jessie-backports.29">Debian wiki</a> 上都有，還是記錄一下。</p>
<p>修改 <code>/etc/apt/sources.list</code>，增加：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># jessie-backports</span></span><br><span class="line">deb http:<span class="regexp">//</span>httpredir.debian.org/debian jessie-backports main contrib non-free</span><br></pre></td></tr></table></figure>
<p>安裝 linux headers</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"># apt-get install linux-headers-<span class="constructor">$(<span class="params">uname</span> -<span class="params">r</span>|<span class="params">sed</span> &#x27;<span class="params">s</span>,[^-]<span class="operator">*</span>-[^-]<span class="operator">*</span>-,,&#x27;)</span></span><br></pre></td></tr></table></figure>
<p>安裝 Nvidia drier</p>
<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># apt-get update</span></span><br><span class="line"><span class="meta"># apt-get install -t jessie-backports nvidia-driver </span></span><br></pre></td></tr></table></figure>
<p>最後重開機，完成！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Murmur-software-flexibility/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Murmur-software-flexibility/" class="post-title-link" itemprop="url">軟體擴充性</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-02-22 22:37:11" itemprop="dateCreated datePublished" datetime="2017-02-22T22:37:11+08:00">2017-02-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Murmur-software-flexibility/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Murmur-software-flexibility/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><del>這個人又來胡言亂語了，不是什麼正經筆記</del></p>
<p>最近寫某個邏輯或定義常常不清楚或者 ambiguous 的東西（因為資料來源是給人看而且也沒整理過），但程式需要清楚的邏輯，感覺在試圖把模糊不清的東西轉成邏輯清晰的程式。似乎，在原本是人工作業而且沒有特別統一或整理過邏輯或步驟的事情上可能就有這種現象。</p>
<p>工程師很喜歡「找 general 的方法」跟「確認出清楚的邏輯」，畢竟這樣程式比較好寫。但是這東西不只原本的邏輯可能不清楚，還「一定會變動但無法預期會如何變動」，以至於後來我放棄找 general 的方法，而是把問題切得更細再組起來，其實就是 divide and conquer。 甚至稍微放寬對清晰邏輯的要求，改用擴充性比較好的做法。只要變動的時候可以用比較低風險──不會影響到其他部分──的方式因應就好，如此，無論是現在邏輯可能再修正或者之後增加目前沒有的東西都能處理。</p>
<p>這讓我更能體會為什麼很多設計都希望增加程式擴充性跟降低修改風險，這讓工程師在面對模糊或高度變動的狀況可以好過一點<del>，不然會改到崩潰</del>。</p>
<p>至於，不能邏輯清楚了再寫嗎？不是不行，但有時候等回應實在太慢，要搞清楚完整邏輯需要花很多時間，而且仍然無法避免「找不到 general 方法」，那就弄個可以微調的辦法之後再慢慢調就好啦！</p>
<p>另外，最近看了一篇文章讓我覺得相對於機器世界的邏輯分明，人類世界本來就沒有那麼清晰跟確定，而工程師剛好是兩者的翻譯官。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Cargo-project-basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Cargo-project-basic/" class="post-title-link" itemprop="url">Cargo project basic</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-02-21 23:01:10" itemprop="dateCreated datePublished" datetime="2017-02-21T23:01:10+08:00">2017-02-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Cargo-project-basic/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Cargo-project-basic/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Cargo-basic"><a href="#Cargo-basic" class="headerlink" title="Cargo basic"></a>Cargo basic</h2><p>Cargo 是 <a target="_blank" rel="noopener" href="https://www.rust-lang.org/en-US/index.html">Rust</a> 的 build &amp; package management system，通常會用 Cargo 管理 Rust project。<a target="_blank" rel="noopener" href="https://www.rust-lang.org/en-US/install.html">安裝 Rust</a> 會一起裝 Cargo。</p>
<p>這跟 npm、bower、composer 等等 package manager 很像，不過為 Rust 需要 compile，所以 Cargo 除了 package management 還有 build system。package manager 是為了解決各種 library 或 package dependency 的問題，例如像 C/C++ 得自己處理如何 build 跟 link library（還會有只剩 binary 檔不知道 source code 從哪來的 library）、維持 library 版本以及升級 library 等問題。</p>
<p>Cargo 裡稱 package 或 library 為 crate。</p>
<p>Cargo 基本指令：</p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>cargo build</span><br><span class="line"><span class="variable">$ </span>cargo run</span><br><span class="line"><span class="variable">$ </span>cargo clean</span><br><span class="line"><span class="variable">$ </span>cargo update  <span class="comment"># 升級 crate</span></span><br></pre></td></tr></table></figure>
<h2 id="Start-new-project"><a href="#Start-new-project" class="headerlink" title="Start new project"></a>Start new project</h2><p><code>$ cargo new &lt;project name&gt; --bin</code></p>
<p>產生基本 project 的 directory，內含 <code>src/</code> 跟 <code>Cargo.toml</code> 並且建立 git repository。加 <code>--bin</code> 是為了 build 出可執行檔，不加會是 library。建立 project 後修改 <code>Cargo.toml</code> 即可，<code>Cargo.toml</code> sample：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;rust-hello-cargo&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;cjwind &lt;cwentsai@gmail.com&gt;&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br></pre></td></tr></table></figure>

<h2 id="Directory-structure"><a href="#Directory-structure" class="headerlink" title="Directory structure"></a>Directory structure</h2><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">src/    # source code directory</span><br><span class="line">    xxx.rs</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Cargo</span>.</span></span>toml    # Cargo configuration</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Cargo</span>.</span></span>lock    # Cargo uses the <span class="module-access"><span class="module"><span class="identifier">Cargo</span>.</span></span>lock file <span class="keyword">to</span> keep track <span class="keyword">of</span> dependencies</span><br></pre></td></tr></table></figure>
<p>Cargo 會自己維護 <code>Cargo.lock</code>，不須手動修改。</p>
<h3 id="Cargo-toml"><a href="#Cargo-toml" class="headerlink" title="Cargo.toml"></a>Cargo.toml</h3><p>Cargo 用 <code>Cargo.toml</code> 來 maintain dependency──需要什麼 crate 以及 crate 版本。這跟 nodejs、PHP 之類的 package management 差不多，只是各自用不同格式而已。</p>
<p>修改 <code>Cargo.toml</code> 之後再 build，Cargo 會去抓需要的 crate 跟處理 dependency──如果 crate 還有 depend 是 project 沒有的也會去抓──然後 compile 它們。</p>
<h3 id="Cargo-lock"><a href="#Cargo-lock" class="headerlink" title="Cargo.lock"></a>Cargo.lock</h3><p>假設 project 依賴 crate A 1.0.12，crate A 有新版本 1.0.13 時會怎樣？</p>
<p>如果 Cargo 自動更新 crate 版本，萬一新版 crate A 反而讓我們的程式爛掉怎麼辦？畢竟總是可能有 bug 的，又或者某些介面或功能被修改了、行為跟原本不一樣也可能造成問題。</p>
<p>Cargo 對此的解決方式跟其他 package manager 差不多──使用 <code>Cargo.lock</code>。</p>
<p>第一次 build project 的時候（應該是 dependency 改動過後的第一次），Cargo 會在 <code>Cargo.lock</code> 記下當下 crate 的版本並且認定這些版本是 ok 的。之後即使 crate 有新版本，Cargo 也不會主動去更新而是以 <code>Cargo.lock</code> 記錄的為準，直到我們要求升級 crate。</p>
<p><code>cargo update</code> 預設只會升最後一碼版號，比較大版本的升級要手動改 <code>Cargo.toml</code>。因為大版本的更新可能會有 interface 的改動，需要我們確認相應修改沒問題才能更新。</p>
<h2 id="延伸閱讀"><a href="#延伸閱讀" class="headerlink" title="延伸閱讀"></a>延伸閱讀</h2><ul>
<li><a target="_blank" rel="noopener" href="http://semver.org/">Semantic Versioning</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Explicit-Runtime-Linking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Explicit-Runtime-Linking/" class="post-title-link" itemprop="url">Explicit Runtime Linking</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-02-19 23:21:48" itemprop="dateCreated datePublished" datetime="2017-02-19T23:21:48+08:00">2017-02-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2017-04-14 23:04:00" itemprop="dateModified" datetime="2017-04-14T23:04:00+08:00">2017-04-14</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Explicit-Runtime-Linking/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Explicit-Runtime-Linking/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>explicit runtime linking 讓程式可以在執行過程中控制 load 及 unload 模組。這種方式讓載入模組變得更靈活，可以在程式需要時才載入某個模組，載入什麼模組也可以依執行狀況決定。因為不需要在一開始載入所有模組，所以可以減少啟動時間跟記憶體用量。另外，因為可以在執行期才載入，也就能在不關閉程式的情況下新增、刪除及更新模組。</p>
<p>在程式碼裡指定了什麼時候要 load 哪個模組，對程式來說它就「知道」要有載入模組的動作。如果是以 dynamic linker 來 load 跟 link，模組跟 library 對程式是透明的，它不知道它用了什麼。兩者的差別即在手動或自動 load shared library，以及load 的時機。</p>
<p>另一方面，如果需要知道一個程式依賴哪些模組，例如移植時要將所有相關模組移植到其他平台以確保所有功能正常。這時以 explicit runtime linking 載入的模組可能增加檢查 dependency 的難度，因為無法用 <code>ldd</code> 得知依賴的模組，可能要等到用到某個功能時才當掉或無法使用。當然這問題並不是太大的缺點，可以透過適當管理 dependency library 以及以一致的方式撰寫 explicit linking 程式碼來避免。</p>
<p>linux 以四個 function 來達到 explicit runtime linking，分別是 <code>dlopen()</code>、<code>dlsym()</code>、<code>dlerror()</code> 以及 <code>dlclose()</code>，它們宣告在 <code>&lt;dlfcn.h&gt;</code>，link 時須 <code>-ldl</code>。</p>
<h2 id="dlopen"><a href="#dlopen" class="headerlink" title="dlopen()"></a>dlopen()</h2><p><code>dlopen()</code> 開啟一個 dynamic library，將其 load 到 process 的 adddress space，並完成初始化。</p>
<p><code>void *dlopen(const char *filename, int flag);</code></p>
<p>第一個參數 <code>filename</code> 很簡單，就是 dynamic library 的路徑。如果是絕對路徑就能直接打開 dynamic library，如果是相對路徑則會依照某個順序尋找 library，詳細的順序可參考 <code>man dlopen</code>。</p>
<p><code>flag</code> 必須指定 <code>RTLD_LAZY</code> 或 <code>RTLD_NOW</code> 之一，<code>RTLD_LAZY</code> 表示 lazy binding，也就是 symbol 在第一次被用到的時候才 resolve。lazy binding 只用於 function，variable 會在 library load 時就 bind 好。<code>RTLD_NOW</code> 當然就是在 load library 的時候就會把所有 symbol 都 resolve。除了 <code>RTLD_LAZY</code> 跟 <code>RTLD_NOW</code> 之外，還有 <code>RTLD_GLOBAL</code> 可以跟他們一起使用，表示之後載入的 library 都可以使用這個 library 的 symbol。其他更多 flag 就參考 manual 囉。</p>
<p><code>dlopen()</code> return 一個 handle，之後的操作要傳這個 handle 給其他 function。如果 load 失敗，會 return NULL。如果要 load 的 library 之前已經 load 過，會 return 跟之前相同的 handle。</p>
<p>如果 load 進來的 library 依賴其他 shared library（link 時指定，非 explicit runtime linking），<code>dlopen()</code> 會自動 load 那些 shared library。</p>
<h2 id="dlsym"><a href="#dlsym" class="headerlink" title="dlsym()"></a>dlsym()</h2><p>讓我們可以找到 library 的 symbol。</p>
<p><code>void *dlsym(void *handle, const char *symbol);</code></p>
<p><code>handle</code> 是剛剛 <code>dlopen()</code> return 的 handle。</p>
<p><code>symbol</code> 是要找的 symbol 的名字，如果找不到 symbol 會 return NULL。找到 symbol 會 return 該 symbol 的 address。根據 manual，return 值是 NULL 無法當作找不到 symbol 的判斷，因為 return 值有可能真的是 NULL<em>（不過我想不到這種狀況的例子…）</em>，須配合 <code>dlerror()</code> 才能確認是不是有找到 symbol：首先 call <code>dlerror()</code> 清掉前面的 error，接著 call <code>dlsym()</code> 找 symbol，再 call <code>dlerror()</code> 看是否有 error 來判斷是否找到 symbol。</p>
<p>如果多個 library 有相同的 symbol 會用哪個？<code>dlsym()</code> 會以 BFS 找 library 的 dependency tree，直到找到 symbol 或完全找不到為止。也就是說 load 順序會決定 symbol 同名時使用到誰，先 load 會先用。</p>
<h2 id="dlerror"><a href="#dlerror" class="headerlink" title="dlerror()"></a>dlerror()</h2><p>call <code>dlopen()</code>、<code>dlsym()</code> 跟 <code>dlclose()</code> 之後可以 call <code>dlerror()</code> 看上次呼叫有沒有成功。如果成功 <code>dlerror()</code> 會 return NULL，反之則 return error 相關資訊。</p>
<p><code>char *dlerror(void);</code></p>
<h2 id="dlclose"><a href="#dlclose" class="headerlink" title="dlclose()"></a>dlclose()</h2><p>用來 unload library。</p>
<p><code>int dlclose(void *handle);</code></p>
<p>系統會用 counter 紀錄一個 library load 的次數，也就是 <code>dlopen()</code> 時加一，<code>dlclose()</code> 則減一，當 counter 變成 0 時 library 才會真的被 unload 掉。unload 的順序跟 load 相反，會先執行 <code>.finit</code> section 的程式碼，接著從 symbol table 中移除相關 symbol，取消 process address space 跟 library 的 memory mapping，最後關閉 library 檔案。</p>
<p>成功 return 0，失敗 return 非 0 值。</p>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>簡單用個例子實作跟驗證。以下共有 <code>libfoo.so</code>、<code>libbar.so</code> 跟 <code>libkar.so</code> 三個 library，主程式 <code>main.c</code> 以 explicit runtime linking load <code>libfoo.so</code>，而 <code>libfoo.so</code> 依賴 <code>libbar.so</code> 以及 <code>libkar.so</code>，後兩者有相同名稱的 function。</p>
<figure class="highlight c"><figcaption><span>bar.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;bar() in bar.c\n&quot;</span>); &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>kar.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;bar() in kar.c\n&quot;</span>); &#125;</span><br></pre></td></tr></table></figure>
<p>compile with </p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">$ gcc -g -fPIC -<span class="keyword">shared </span>-o libbar.so <span class="keyword">bar.c</span></span><br><span class="line"><span class="keyword">$ </span>gcc -g -fPIC -<span class="keyword">shared </span>-o libkar.so kar.c</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>foo.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> zoo = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> coo = <span class="number">5566</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;foo = %x, &amp;zoo = %x, &amp;coo = %x\n&quot;</span>, foo, &amp;zoo, &amp;coo);</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">koo</span><span class="params">(<span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> n + coo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>compile with <code>gcc -g -fPIC -shared -o libfoo.so foo.c ./libbar.so ./libkar.so</code></p>
<figure class="highlight c"><figcaption><span>main.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span>* handle = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    handle = dlopen(<span class="string">&quot;./libfoo.so&quot;</span>, RTLD_LAZY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Load library failed. error: %s\n&quot;</span>, dlerror());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*fn)(<span class="keyword">int</span>, <span class="keyword">int</span>) = <span class="literal">NULL</span>;</span><br><span class="line">    dlerror();  <span class="comment">// clear error condition</span></span><br><span class="line">    fn = dlsym(handle, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"><span class="comment">//    fn = dlsym(handle, &quot;koo&quot;);    // fail</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* error = dlerror();</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Load symbol failed. error: %s\n&quot;</span>, error);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fn = %x\n&quot;</span>, fn);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = fn(<span class="number">3</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ret = %d\n&quot;</span>, ret);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// doesn&#x27;t check error</span></span><br><span class="line">    <span class="keyword">int</span>* p = <span class="literal">NULL</span>;</span><br><span class="line">    p = dlsym(handle, <span class="string">&quot;zoo&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;p = %x\n&quot;</span>, p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>* c = <span class="literal">NULL</span>;</span><br><span class="line">    c = dlsym(handle, <span class="string">&quot;coo&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;c = %x, *c = %d\n&quot;</span>, c, *c);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> (*bar)() = <span class="literal">NULL</span>;</span><br><span class="line">    bar = dlsym(handle, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line">    bar();</span><br><span class="line"></span><br><span class="line">    getchar();  <span class="comment">// just pause process</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dlclose(handle) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Close library fail. error: %s\n&quot;</span>, dlerror());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>compile with <code>gcc -g -o main main.c -ldl</code></p>
<p>執行結果顯示拿到主程式 <code>libfoo.so</code> 裡 symbol 的 address，以及 load 到 <code>libbar.so</code> 裡的 <code>bar()</code>：</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">$ ./main </span><br><span class="line"><span class="attr">fn</span> = ef40f740</span><br><span class="line"><span class="attr">foo</span> = ef40f740, &amp;<span class="attr">zoo</span> = ef60faf0, &amp;<span class="attr">coo</span> = ef40f7a8</span><br><span class="line"><span class="attr">ret</span> = <span class="number">8</span></span><br><span class="line"><span class="attr">p</span> = ef60faf0</span><br><span class="line"><span class="attr">c</span> = ef40f7a8, *<span class="attr">c</span> = <span class="number">5566</span></span><br><span class="line">bar() <span class="keyword">in</span> bar.c</span><br></pre></td></tr></table></figure>
<p>process 的 address space：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">00400000</span>-<span class="number">00401000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409326</span>                           /home/cjw/source/explicit-load/main</span><br><span class="line"><span class="attribute">00600000</span>-<span class="number">00601000</span> rw-p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409326</span>                           /home/cjw/source/explicit-load/main</span><br><span class="line"><span class="attribute">02552000</span>-<span class="number">02573000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                 <span class="meta"> [heap]</span></span><br><span class="line"><span class="attribute">7fe9bee48000</span>-<span class="number">7</span>fe<span class="number">9</span>bee<span class="number">49000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409316</span>                   /home/cjw/source/explicit-load/libkar.so</span><br><span class="line"><span class="attribute">7fe9bee49000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">048000</span> ---p <span class="number">00001000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409316</span>                   /home/cjw/source/explicit-load/libkar.so</span><br><span class="line"><span class="attribute">7fe9bf048000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">049000</span> rw-p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409316</span>                   /home/cjw/source/explicit-load/libkar.so</span><br><span class="line"><span class="attribute">7fe9bf049000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">04</span>a<span class="number">000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409324</span>                   /home/cjw/source/explicit-load/libbar.so</span><br><span class="line"><span class="attribute">7fe9bf04a000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">249000</span> ---p <span class="number">00001000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409324</span>                   /home/cjw/source/explicit-load/libbar.so</span><br><span class="line"><span class="attribute">7fe9bf249000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">24</span>a<span class="number">000</span> rw-p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409324</span>                   /home/cjw/source/explicit-load/libbar.so</span><br><span class="line"><span class="attribute">7fe9bf24a000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">24</span>b<span class="number">000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409329</span>                   /home/cjw/source/explicit-load/libfoo.so</span><br><span class="line"><span class="attribute">7fe9bf24b000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">44</span>a<span class="number">000</span> ---p <span class="number">00001000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409329</span>                   /home/cjw/source/explicit-load/libfoo.so</span><br><span class="line"><span class="attribute">7fe9bf44a000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">44</span>b<span class="number">000</span> rw-p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">11409329</span>                   /home/cjw/source/explicit-load/libfoo.so</span><br><span class="line"><span class="attribute">7fe9bf44b000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">5</span>ec<span class="number">000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864382</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/libc-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fe9bf5ec000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">7</span>ec<span class="number">000</span> ---p <span class="number">001</span>a<span class="number">1000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864382</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/libc-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fe9bf7ec000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">7</span>f<span class="number">0000</span> r--p <span class="number">001</span>a<span class="number">1000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864382</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/libc-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fe9bf7f0000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">7</span>f<span class="number">2000</span> rw-p <span class="number">001</span>a<span class="number">5000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864382</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/libc-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fe9bf7f2000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">7</span>f<span class="number">6000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="attribute">7fe9bf7f6000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">7</span>f<span class="number">9000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864385</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/libdl-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fe9bf7f9000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">9</span>f<span class="number">8000</span> ---p <span class="number">00003000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864385</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/libdl-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fe9bf9f8000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">9</span>f<span class="number">9000</span> r--p <span class="number">00002000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864385</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/libdl-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fe9bf9f9000</span>-<span class="number">7</span>fe<span class="number">9</span>bf<span class="number">9</span>fa<span class="number">000</span> rw-p <span class="number">00003000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864385</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/libdl-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fe9bf9fa000</span>-<span class="number">7</span>fe<span class="number">9</span>bfa<span class="number">1</span>a<span class="number">000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864371</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/ld-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fe9bfbf9000</span>-<span class="number">7</span>fe<span class="number">9</span>bfbfc<span class="number">000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="attribute">7fe9bfc16000</span>-<span class="number">7</span>fe<span class="number">9</span>bfc<span class="number">1</span>a<span class="number">000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="attribute">7fe9bfc1a000</span>-<span class="number">7</span>fe<span class="number">9</span>bfc<span class="number">1</span>b<span class="number">000</span> r--p <span class="number">00020000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864371</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/ld-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fe9bfc1b000</span>-<span class="number">7</span>fe<span class="number">9</span>bfc<span class="number">1</span>c<span class="number">000</span> rw-p <span class="number">00021000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">7864371</span>                    /lib/x<span class="number">86</span>_<span class="number">64</span>-linux-gnu/ld-<span class="number">2</span>.<span class="number">19</span>.so</span><br><span class="line"><span class="attribute">7fe9bfc1c000</span>-<span class="number">7</span>fe<span class="number">9</span>bfc<span class="number">1</span>d<span class="number">000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="attribute">7ffdd05ea000</span>-<span class="number">7</span>ffdd<span class="number">060</span>b<span class="number">000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [stack]</span></span><br><span class="line"><span class="attribute">7ffdd0755000</span>-<span class="number">7</span>ffdd<span class="number">0757000</span> r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [vdso]</span></span><br><span class="line"><span class="attribute">7ffdd0757000</span>-<span class="number">7</span>ffdd<span class="number">0759000</span> r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                         <span class="meta"> [vvar]</span></span><br><span class="line"><span class="attribute">ffffffffff600000</span>-ffffffffff<span class="number">601000</span> r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                 <span class="meta"> [vsyscall]</span></span><br></pre></td></tr></table></figure>
<p>三個 library 都 load 進來啦～</p>
<p>用 gdb 在 <code>_init</code> 跟 <code>_fini</code> 設 break point 可以看到在 <code>dlopen()</code> 跟 <code>dlclose()</code> 時會分別執行 <code>libfoo.so</code> 及其他 library 的 <code>_init</code> 及 <code>_fini</code>。同樣適用 GCC 提供的 shared library constructor 及 destructor，<a href="/Dynamic-Linking-Relocation/">Ref</a>。</p>
<p>可以用 <code>ldd</code> 看 <code>libfoo.so</code> 的 dependency：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">$ ldd libfoo.<span class="keyword">so</span> </span><br><span class="line">        linux-vdso.<span class="keyword">so</span>.1 (0x00007fffde785000)</span><br><span class="line">        ./libbar.<span class="keyword">so</span> (0x00007fdf77158000)</span><br><span class="line">        ./libkar.<span class="keyword">so</span> (0x00007fdf76f57000)</span><br><span class="line">        libc.<span class="keyword">so</span>.6 =&gt; /lib/x86_64-linux-gnu/libc.<span class="keyword">so</span>.6 (0x00007fdf76bac000)</span><br><span class="line">        /lib64/ld-linux-x86-64.<span class="keyword">so</span>.2 (0x00007fdf7755a000)</span><br></pre></td></tr></table></figure>
<p>如果 compile <code>libfoo.so</code> 時改變 link 的 shared library 順序，變成 <code>gcc -g -fPIC -shared -o libfoo.so foo.c ./libkar.so ./libbar.so</code>，load 到的 <code>bar()</code> 會變成是 <code>libkar.so</code> 的。</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">$ ./main</span><br><span class="line">fn <span class="operator">=</span> a<span class="number">259</span><span class="keyword">c</span><span class="number">740</span></span><br><span class="line">foo <span class="operator">=</span> a<span class="number">259</span><span class="keyword">c</span><span class="number">740</span><span class="punctuation">,</span> &amp;zoo <span class="operator">=</span> a<span class="number">279</span>caf<span class="number">0</span><span class="punctuation">,</span> &amp;coo <span class="operator">=</span> a<span class="number">259</span><span class="keyword">c</span><span class="number">7</span>a<span class="number">8</span></span><br><span class="line"><span class="keyword">ret</span> <span class="operator">=</span> <span class="number">8</span></span><br><span class="line">p <span class="operator">=</span> a<span class="number">279</span>caf<span class="number">0</span></span><br><span class="line"><span class="keyword">c</span> <span class="operator">=</span> a<span class="number">259</span><span class="keyword">c</span><span class="number">7</span>a<span class="number">8</span><span class="punctuation">,</span> *<span class="keyword">c</span> <span class="operator">=</span> <span class="number">5566</span></span><br><span class="line">bar() in kar.<span class="keyword">c</span></span><br></pre></td></tr></table></figure>
<p><code>ldd</code> 看到的順序也會變：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">$ ldd libfoo.<span class="keyword">so</span> </span><br><span class="line">        linux-vdso.<span class="keyword">so</span>.1 (0x00007fff4db40000)</span><br><span class="line">        ./libkar.<span class="keyword">so</span> (0x00007f5b4ddb5000)</span><br><span class="line">        ./libbar.<span class="keyword">so</span> (0x00007f5b4dbb4000)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="Related-posts"><a href="#Related-posts" class="headerlink" title="Related posts"></a>Related posts</h2><ul>
<li><a href="/Dynamic-Linking-Basic/">Dynamic Linking Basic</a></li>
<li><a href="/Dynamic-Linking-PIC/">Dynamic Linking PIC</a></li>
<li><a href="/Dynamic-Linking-Relocation/">Dynamic Linking Relocation</a></li>
<li><a href="/Shared-Library-Versioning/">Shared Library Versioning</a></li>
<li><a href="/Use-Shared-Library-in-Linux/">Use Shared Library in Linux</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/solve-servo-blank/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/solve-servo-blank/" class="post-title-link" itemprop="url">解決執行 Servo 只有白畫面問題</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-02-05 21:04:39" itemprop="dateCreated datePublished" datetime="2017-02-05T21:04:39+08:00">2017-02-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/solve-servo-blank/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="solve-servo-blank/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>build 好 servo 之後執行 <code>./mach run -d tests/html/about-mozilla.html</code> 視窗只出現白白的畫面。這怎麼看都不正常啊……ˊ（´;ω;｀)</p>
<h2 id="環境"><a href="#環境" class="headerlink" title="環境"></a>環境</h2><ul>
<li>LMDE 2 Cinnamon 64 bits</li>
<li>NVIDIA GeForce GTS 250</li>
<li>kernel 3.16.0-4-amd64</li>
</ul>
<h2 id="各種測試"><a href="#各種測試" class="headerlink" title="各種測試"></a>各種測試</h2><p>build release 版後 <code>./mach run -r tests/html/about-mozilla.html</code> 跟從 <a target="_blank" rel="noopener" href="https://download.servo.org/">https://download.servo.org/</a> 抓 pre-built 版都白白的。</p>
<p>用 gdb 跑跑看</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">./mcah <span class="builtin-name">run</span> -d --debug</span><br><span class="line">gdb&gt; r tests/html/about-mozilla.html</span><br><span class="line"><span class="built_in">..</span>.blahblah</span><br></pre></td></tr></table></figure>
<p>所以有在動啊……</p>
<p><code>./mach run -d tests/html/about-mozilla.html -o output.png</code> 輸出圖檔，圖片也是一片白。</p>
<p>update 系統再 try 也不行。</p>
<p>用 VM LMDE 跑 pre-built 出現其他 error <code>0:1(10): error: GLSL 1.50 is not supported. Supported versions are 1.10, 1.20, 1.30, 1.00 ES, and 3.00 ES</code>，<a target="_blank" rel="noopener" href="https://github.com/servo/servo/issues/11124">可能跟 VM 沒 support OpenGL 有關</a>，有點岔題所以不管。</p>
<p>另一台電腦 Ubuntu 跑 pre-built，正常。</p>
<h2 id="猜猜樂"><a href="#猜猜樂" class="headerlink" title="猜猜樂"></a>猜猜樂</h2><p>pre-built 不會動表示不是我 build 的有問題。猜是 render 有問題，測輸出圖檔也不行，應該八九不離十是 render 問題。google 看不出所以然，Ubuntu 是好的但應該不至於 Ubuntu 可以 LMDE 卻不能用。</p>
<p>畫不出來，不然更新看看 driver。</p>
<p>先說結果，猜中了。(′‧ω‧‵)</p>
<h2 id="檢查顯卡型號-amp-driver"><a href="#檢查顯卡型號-amp-driver" class="headerlink" title="檢查顯卡型號 &amp; driver"></a>檢查顯卡型號 &amp; driver</h2><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">$ lspci <span class="string">| grep VGA</span></span><br><span class="line"><span class="number">01</span>:<span class="number">00.0</span> VGA compatible controller: NVIDIA Corporation G92 [GeForce GTS <span class="number">250</span>] (rev a2)</span><br></pre></td></tr></table></figure>
<p>看顯卡型號。</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">$ glxinfo | OpenGL</span><br><span class="line">OpenGL vendor strin<span class="variable">g:</span> NVIDIA Corporation</span><br><span class="line">OpenGL renderer strin<span class="variable">g:</span> GeForce GTS <span class="number">250</span>/PCIe/SSE2</span><br><span class="line">OpenGL core <span class="keyword">profile</span> <span class="keyword">version</span> strin<span class="variable">g:</span> <span class="number">3.3</span>.<span class="number">0</span> NVIDIA <span class="number">340.101</span></span><br><span class="line">OpenGL core <span class="keyword">profile</span> shading <span class="keyword">language</span> <span class="keyword">version</span> strin<span class="variable">g:</span> <span class="number">3.30</span> NVIDIA via Cg <span class="keyword">compiler</span></span><br><span class="line">OpenGL core <span class="keyword">profile</span> context flag<span class="variable">s:</span> (none)</span><br><span class="line">OpenGL core <span class="keyword">profile</span> <span class="keyword">profile</span> mask: core <span class="keyword">profile</span></span><br><span class="line">OpenGL core <span class="keyword">profile</span> extension<span class="variable">s:</span></span><br><span class="line">OpenGL <span class="keyword">version</span> strin<span class="variable">g:</span> <span class="number">3.3</span>.<span class="number">0</span> NVIDIA <span class="number">340.101</span></span><br><span class="line">OpenGL shading <span class="keyword">language</span> <span class="keyword">version</span> strin<span class="variable">g:</span> <span class="number">3.30</span> NVIDIA via Cg <span class="keyword">compiler</span></span><br><span class="line">OpenGL context flag<span class="variable">s:</span> (none)</span><br><span class="line">OpenGL <span class="keyword">profile</span> mask: (none)</span><br><span class="line">OpenGL extension<span class="variable">s:</span></span><br><span class="line">OpenGL ES <span class="keyword">profile</span> <span class="keyword">version</span> strin<span class="variable">g:</span> OpenGL ES <span class="number">2.0</span> NVIDIA <span class="number">340.101</span> <span class="number">340.101</span></span><br><span class="line">OpenGL ES <span class="keyword">profile</span> shading <span class="keyword">language</span> <span class="keyword">version</span> strin<span class="variable">g:</span> OpenGL ES GLSL ES <span class="number">1.00</span></span><br><span class="line">OpenGL ES <span class="keyword">profile</span> extension<span class="variable">s:</span></span><br></pre></td></tr></table></figure>
<p>看顯卡 driver，這是已經換成 NVIDIA driver 的結果。如果 <code>OpenGL renderer string</code> 出現 Mesa 之類的表示不是用 NVIDIA 的 driver。</p>
<h2 id="更新顯卡-driver"><a href="#更新顯卡-driver" class="headerlink" title="更新顯卡 driver"></a>更新顯卡 driver</h2><p>為了更新顯卡搞了半天……總結如下。</p>
<p><a target="_blank" rel="noopener" href="http://www.nvidia.com/Download/index.aspx?lang=en-us">抓 NVIDIA driver</a>。</p>
<p>修改 <code>/etc/default/grub</code>：<code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;nouveau.blacklist=1 quiet splash text&quot;</code>，之後</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> sudo <span class="built_in">update-grub</span></span><br><span class="line"><span class="variable">$</span> sudo <span class="built_in">update-initramfs</span></span><br><span class="line"><span class="variable">$</span> sudo reboot</span><br></pre></td></tr></table></figure>
<p><code>nouveau.blacklist=1</code> 是 disable nouveau，nouveau 是 open source 社群做的 NVIDIA 顯卡的 driver。</p>
<p><code>text</code> 則是開機不進 GUI，因為得關掉 X server 才能裝 driver，乾脆直接進文字模式裝。我以為是改 run level，但是 google 到一堆都這樣搞就這樣了。有人說用 recovery mode 也可以裝 driver，不過我沒試。</p>
<p>從 NVIDIA 抓下 <code>NVIDIA-Linux-x86_64-340.101.run</code>，是個 script，要用 root 權限跑。</p>
<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># export CC=gcc-4.8</span></span><br><span class="line"><span class="meta"># sh NVIDIA-Linux-x86_64-340.101.run</span></span><br></pre></td></tr></table></figure>
<p>需要設 <code>CC</code> 是因為我 gcc 預設版本是 4.9，但是 compile driver 需要 4.8。</p>
<p>安裝過程是 console 的互動介面（忘記這叫什麼了啦）就不細寫了。中間有問要不要 build 成什麼 module 之類的，選 yes 會 fail，懶得研究那是什麼東西，用 no 就安裝成功了。</p>
<p>最後，修改 <code>/etc/default/grub</code> 以 GUI 開機：<code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;nouveau.blacklist=1 quiet splash&quot;</code> 再 update grub 跟 reboot。</p>
<p>開 servo 終於正常了…\T_T/</p>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.cgl.ucsf.edu/chimera/graphics/updatelinux.html">http://www.cgl.ucsf.edu/chimera/graphics/updatelinux.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Design-Pattern-Overview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Design-Pattern-Overview/" class="post-title-link" itemprop="url">Design Pattern Overview</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-12-24 13:34:04" itemprop="dateCreated datePublished" datetime="2016-12-24T13:34:04+08:00">2016-12-24</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Design-Pattern-Overview/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Design-Pattern-Overview/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Design Pattern <strong>提供某個情境下針對某問題的某種解決方法</strong>。這些解法通常是前人整理出來、經過驗證的。</p>
<ul>
<li>「情境」是某種不斷出現的狀況。</li>
<li>「問題」是在某個情境下希望達到的目標，也可能是情境下的限制。</li>
<li>「解決方法」希望是個 general 的設計，用來解決限制、達到目標。</li>
</ul>
<p>常用來描述 design pattern 的方式是 GoF 書裡使用的格式。</p>
<h2 id="使用-Design-Pattern"><a href="#使用-Design-Pattern" class="headerlink" title="使用 Design Pattern"></a>使用 Design Pattern</h2><p><strong>能用簡單方法解決問題就用簡單方法。</strong>pattern 會為系統增加額外複雜度，只有需要的時候才使用。</p>
<p>使用 pattern 要注意是否有意義以及是否對系統其他部分造成影響，不要為了用而用。如果預期系統在未來會有實際的改變，也可以用 pattern 預先加上彈性。不過要注意，必須是實際的改變，而不是假定的改變。自己覺得可能會改變就用一堆 pattern 也不對，至於什麼叫做「未來實際會有的改變」又是另一個故事了……(喂</p>
<p>熟悉大部分 pattern 後，需要時大概會知道需要什麼 pattern，接著可以參考 pattern 的 motivation 確認想法對不對，再來要考量會不會對系統造成不良影響。設計上確認後，實作可以參考 UML 跟範例了解實作上的眉眉角角。</p>
<p>GoF 把 design pattern 分成三大類：creational、structural、behavioral patterns。有時候不知道確切需要哪個 pattern，可以先對問題分類再從類別中找適合的 pattern。</p>
<h2 id="Design-Pattern-分類"><a href="#Design-Pattern-分類" class="headerlink" title="Design Pattern 分類"></a>Design Pattern 分類</h2><h3 id="Creational-pattern"><a href="#Creational-pattern" class="headerlink" title="Creational pattern"></a>Creational pattern</h3><p>處理「產生 object」。主要的目的有二，一是希望封裝 concrete class，二是想封裝「如何產生並結合 concrete class 的 instance」的過程。</p>
<ul>
<li>Abstract Factory</li>
<li>Builder</li>
<li>Factory Method</li>
<li>Prototype</li>
<li><a href="/singleton">Singleton</a></li>
</ul>
<h3 id="Structural-pattern"><a href="#Structural-pattern" class="headerlink" title="Structural pattern"></a>Structural pattern</h3><p>可以合成 class 跟 object 到更大的結構中。</p>
<ul>
<li><a href="/Adapter-Pattern">Adapter</a></li>
<li>Bridge</li>
<li><a href="/Composite-Pattern">Composite</a></li>
<li>Decorator</li>
<li><a href="/Facade-Pattern">Facade</a></li>
<li>Flyweight</li>
<li><a href="/Proxy-Pattern">Proxy</a></li>
</ul>
<h3 id="Behavior-pattern"><a href="#Behavior-pattern" class="headerlink" title="Behavior pattern"></a>Behavior pattern</h3><p>重點在 class 與 object 間的互動，以及各自的責任。</p>
<ul>
<li>Chain of Responsibility</li>
<li>Command</li>
<li>Interpreter</li>
<li><a href="/Iterator-Pattern">Iterator</a></li>
<li>Mediator</li>
<li>Memento</li>
<li><a href="/Observer-Pattern">Observer</a></li>
<li><a href="/State-Pattern">State</a></li>
<li><a href="/Strategy-Pattern">Strategy</a></li>
<li><a href="/Template-Method-Pattern">Template Method</a></li>
<li>Visitor</li>
</ul>
<h2 id="Anti-pattern"><a href="#Anti-pattern" class="headerlink" title="Anti-pattern"></a>Anti-pattern</h2><p>anti-pattern 就是不好的 pattern，告訴大家什麼叫用不好的解決方式解決一個問題，好避免用到這些方法。一個好的 anti-pattern 除了說明不好的方法之外，會建議改用其他 pattern。<del>不然就沒建設性啦</del></p>
<h2 id="pattern-世界"><a href="#pattern-世界" class="headerlink" title="pattern 世界"></a>pattern 世界</h2><p>除了 design pattern 之外，還有像特定領域如 concurrent 系統的 pattern、組織溝通上的 pattern、UI/UX 的 pattern 等等。pattern 是蠻 general 的概念，在蠻多領域都會出現的，共通的概念是「在面對某種重複出現的情境、狀況或問題時的應對方式」。</p>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ul>
<li>《Design Patterns: Elements of Reusable Object-Oriented Software》</li>
<li>《Head First Design Patterns》</li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Software_design_pattern">https://en.wikipedia.org/wiki/Software_design_pattern</a></li>
<li><a target="_blank" rel="noopener" href="http://hillside.net/">http://hillside.net/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/MVC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/MVC/" class="post-title-link" itemprop="url">MVC (Model-View-Controller)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-12-20 23:15:40" itemprop="dateCreated datePublished" datetime="2016-12-20T23:15:40+08:00">2016-12-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/MVC/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="MVC/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>大名鼎鼎的 MVC（Model-View-Controller）是一種 compound pattern，要說是個架構也行，這篇主要用 design pattern 的角度去看 MVC。</p>
<p>compound pattern 是一堆 design pattern 被結合起來使用以解決一般性問題。</p>
<p>MVC 將 component 分成 model、view 以及 controller：</p>
<ul>
<li>model 包含商業邏輯、資料、狀態等等，真正的功能跟做事的 code 會放在 model。</li>
<li>view 負責呈現各種資料跟畫面。</li>
<li>controller 接收來自 view 的 input，解讀後要 model 做事。依據使用的 model 不同，controller 對 input 的解讀會不同。</li>
</ul>
<h2 id="MVC-中的-design-pattern"><a href="#MVC-中的-design-pattern" class="headerlink" title="MVC 中的 design pattern"></a>MVC 中的 design pattern</h2><p>MVC 中有 <a href="/Observer-Pattern">Observer pattern</a>、<a href="/Strategy-Pattern">Strategy pattern</a> 以及 <a href="/Composite-Pattern">Composite pattern</a>。</p>
<p>model 利用 observer pattern 通知 controller 及 view 狀態改變。如果 observer 使用 pull 的方式取得資料，model 會開 getter。如果用 push，model 會在 notify 時將 state 傳給 observer。view 一般只從 model 取得資料、不會改變 model。要 model 做事或改變 model 是 controller 的工作。有 controller 可以讓 model 跟 view 不要綁那麼緊。</p>
<p>view 跟 controller 使用 strategy pattern，controller 是 view 的 strategy。view 負責管理呈現，任何操作與動作都交給 controller 處理。strategy 讓 view 只需要更換 controller 就能有不同動作。</p>
<p>view 通常用 composite pattern 管理內部的顯示 component，例如 window、panel、widget、button 的階層式結構。</p>
<p>另外，如果需要轉換某個 model 的 interface 就輪到 <a href="/Adapter-Pattern">Adapter pattern</a> 上場啦。例如 db table 的 primary key 改了，新程式碼希望用新的 primary key 當參數又不想改舊 model，就可以用 adapter 轉換 interface。</p>
<h2 id="Murmur"><a href="#Murmur" class="headerlink" title="Murmur"></a>Murmur</h2><p>最早遇到 MVC 是在網頁 framework，所以一直理解 model 為「資料」。後來發現 model 好像不只是資料，有文件說 model 包含商業邏輯，但我還是說不上來到底是什麼。現在的理解是絕大多數的程式都是 model，只是把 view 拆出去並且引進 controller 作為類似中介的角色。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Proxy-Pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Proxy-Pattern/" class="post-title-link" itemprop="url">Proxy Pattern</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-12-11 15:31:47" itemprop="dateCreated datePublished" datetime="2016-12-11T15:31:47+08:00">2016-12-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Proxy-Pattern/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Proxy-Pattern/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>讓某個物件有個替身，藉以控制外界對物件的接觸。<del>就是個經紀人的概念。(欸)</del></p>
<p>Proxy pattern 主要目的在於「控制存取」，被代理的物件可以是遠端主機上的物件、建立成本高（例如需要時間下載）的物件、或者需要做存取權限管控的物件。</p>
<h2 id="UML"><a href="#UML" class="headerlink" title="UML"></a>UML</h2><p><img src="/images/proxy_pattern.png" alt="Proxy Pattern"></p>
<p>很簡單的 UML，client 透過 interface Subject 使用物件，所以它不用知道使用的是真正有功能的物件 RealSubject 還是只是代理人 Proxy。Proxy 依據型態不同會用不同方式取得 RealSubject、使用 RealSubject 的功能，再將結果丟回給 client。</p>
<p>除了操作 interface 外，要讓 client 使用 proxy 而非真正的 object，有個方法是用 factory 產生物件、傳回給 client，不然 client 自己 new 了個 XXXProxy，看也知道不是真正的 object 啊 XD。不過，是不是真有必要再加一層 factory 隱藏使用 proxy 的事實倒是依情況而定，簡單的情境下讓 client 自己去生 XXXProxy 也不會怎麼樣，不見得非得用 factory 增加複雜度。</p>
<h2 id="Proxy-與它的變種們"><a href="#Proxy-與它的變種們" class="headerlink" title="Proxy 與它的變種們"></a>Proxy 與它的變種們</h2><h3 id="Remote-Proxy"><a href="#Remote-Proxy" class="headerlink" title="Remote Proxy"></a>Remote Proxy</h3><p>代理另一台電腦上的物件或 service 等等的代理人。使用 proxy 的 client 基本上不會知道 proxy 多做了網路連線、傳遞資料等等的事情，例如 Java 的 RMI（Remote Method Invocation）（這東西應該有點年代了，就當作是個簡單的例子就好）。</p>
<h3 id="Virtual-Proxy"><a href="#Virtual-Proxy" class="headerlink" title="Virtual Proxy"></a>Virtual Proxy</h3><p>代理建立成本很高的 object，所謂成本很高可能是需要比較多時間等等，例如 video object 需要從網路抓影片、回應很慢的 API 等等。等待過程中但又不希望卡到 UI 操作，這時候就可以透過 virtual proxy 先回一個 loading 畫面，等到 video 抓好或 API 回來之後，就由真正的 object 做事。</p>
<h3 id="Protection-Proxy"><a href="#Protection-Proxy" class="headerlink" title="Protection Proxy"></a>Protection Proxy</h3><p>顧名思義，保護真正 object 的 proxy，它會根據權限決定外部可不可以存取真正的 object。</p>
<h3 id="Dynamic-Proxy"><a href="#Dynamic-Proxy" class="headerlink" title="Dynamic Proxy"></a>Dynamic Proxy</h3><p>Java 把事情搞得更複雜，弄了個 dynamic proxy 出來，在 package <code>java.lang.reflect</code>。</p>
<p>簡單來說，Java 讓 programmer 連 proxy 都不用寫了，只要寫個 <code>InvocationHandler</code> 讓 proxy object call，runtime 才依據要代理的 object 生出 proxy object。<del>除了讓人更懶之外不太懂為什麼要搞這個出來…</del></p>
<h3 id="其他奇奇怪怪的-Proxy-們"><a href="#其他奇奇怪怪的-Proxy-們" class="headerlink" title="其他奇奇怪怪的 Proxy 們"></a>其他奇奇怪怪的 Proxy 們</h3><p>放關鍵字，需要用再查。</p>
<p>Firewall proxy、Caching proxy、Synchronization proxy、Smart Reference proxy、Complexity Hiding proxy、Copy-On-Wrtie proxy。</p>
<p>網路上常說的 proxy server，就有 cache 跟控制網頁存取的功能。</p>
<h2 id="Proxy-與其他-pattern-的不同"><a href="#Proxy-與其他-pattern-的不同" class="headerlink" title="Proxy 與其他 pattern 的不同"></a>Proxy 與其他 pattern 的不同</h2><h3 id="Decorator"><a href="#Decorator" class="headerlink" title="Decorator"></a>Decorator</h3><p>proxy 跟 decorator 都是對一個物件包裝，有點像，但是兩者的意圖不同。proxy 的目的是控制存取，decorator 則是增加功能。而且 proxy 通常不會一直包一直包、像洋蔥一樣好多層，decorator 會依據想要的功能一直包。</p>
<h3 id="Adapter"><a href="#Adapter" class="headerlink" title="Adapter"></a>Adapter</h3><p>proxy 看到一半，我就想，啊這跟 <a href="/Adapter-Pattern">adapter</a> 不是一樣嗎！不都是在使用的 client 跟真正的 objec 之間加一層！！！（施主冷靜）</p>
<p>還是不一樣啦。adapter 會改變 interface，例如 function 參數不一樣，proxy 會 implement 同樣的 interface。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cjwind</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  





<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://cjwind.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
