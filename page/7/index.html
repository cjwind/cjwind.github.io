<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.cjwind.idv.tw","root":"/","images":"/images","scheme":"Gemini","version":"8.2.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta property="og:type" content="website">
<meta property="og:title" content="cjwind&#39;s note">
<meta property="og:url" content="http://www.cjwind.idv.tw/page/7/index.html">
<meta property="og:site_name" content="cjwind&#39;s note">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="cjwind">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://www.cjwind.idv.tw/page/7/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>
<title>cjwind's note</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-62800351-2"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-62800351-2');
      }
    </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="cjwind's note" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">cjwind's note</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">要夠努力，但不要太努力</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-projects"><a href="/projects/" rel="section"><i class="fa fa-code fa-fw"></i>Projects</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">cjwind</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">173</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/cjwind" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cjwind" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:cwentsai@gmail.com" title="E-Mail → mailto:cwentsai@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.youtube.com/channel/UCJCXRf8LQCjX8Ydlrd1i0vw" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCJCXRf8LQCjX8Ydlrd1i0vw" rel="noopener" target="_blank"><i class="fab fa-youtube fa-fw"></i>YouTube</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/chia-wen-tsai-b1605166/" title="Linkedin → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;chia-wen-tsai-b1605166&#x2F;" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i>Linkedin</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://ko-fi.com/C0C812X69" title="Donate → https:&#x2F;&#x2F;ko-fi.com&#x2F;C0C812X69" rel="noopener" target="_blank"><i class="fas fa-donate fa-fw"></i>Donate</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Reactor-pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Reactor-pattern/" class="post-title-link" itemprop="url">Reactor pattern</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-08-27 14:49:27" itemprop="dateCreated datePublished" datetime="2017-08-27T14:49:27+08:00">2017-08-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Reactor-pattern/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Reactor-pattern/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>看<a target="_blank" rel="noopener" href="http://www.cs.wustl.edu/~schmidt/PDF/reactor-siemens.pdf">這篇 paper</a>。</p>
<h2 id="問題-amp-情境"><a href="#問題-amp-情境" class="headerlink" title="問題 &amp; 情境"></a>問題 &amp; 情境</h2><p>Reactor pattern 處理一個 application 收到從一個或多個 client 同時（concurrently）送 request 的情況。</p>
<p>分散式環境的 server 必須處理多個送 request 過來的 client。為了處理 request，server 必須 demultiplex 以及 dispatch request 給對應的 service。設計 demultiplexing 及 dispatching 需考量：</p>
<ul>
<li>Availability<br>server 在等待某些 request 時（例如 server 與 client 間需要多步驟溝通，server 正在等 client 的某個步驟），server 依然能處理收到的 request，不能因為處理某個 request 而 block 住，不然會卡到對其他 request 的 response。</li>
<li>Efficiency<br>server 要最小化 latency、最大化 throughput 以及避免不必要的 CPU 使用。</li>
<li>Programming simplicity<br>顧名思義，程式寫得愈簡單愈好。</li>
<li>Adaptability<br>容易新增或改進 service，修改最少現有的 code 就能加新功能或改進功能，例如新增 service 不用修改底層的 dispatching 機制。</li>
<li>Portability<br>容易 porting 到其他 OS 平台等。</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Reactor-pattern/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Reentrancy-and-Thread-safety/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Reentrancy-and-Thread-safety/" class="post-title-link" itemprop="url">Reentrancy and Thread-safety</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-22 00:05:57" itemprop="dateCreated datePublished" datetime="2017-07-22T00:05:57+08:00">2017-07-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Reentrancy-and-Thread-safety/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Reentrancy-and-Thread-safety/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>常常聽到看到 reentrancy 但老是跟 thread-safety 搞得不是太清楚。</p>
<h2 id="Reentrancy"><a href="#Reentrancy" class="headerlink" title="Reentrancy"></a>Reentrancy</h2><p>reentrancy 是 function 可以在執行過程中被中斷，在上一次執行還沒完成前可以再次進入這個 function 執行而不會有問題，也就是第二次進入 function 執行結束後，第一次的執行仍能正確完成。中斷可以是 jump 或 call，也可以是系統的 interrupt 或 signal。</p>
<p>reentrancy 是 single thread 環境下就有的概念。像是被系統 interrupt 中斷時 interrupt handler 是不是能夠再 call 剛剛執行到一半的 function？反過來說，interrupt handler 能 call 的只有 reentrant function。另外，recursive function 一般會是 reentrancy，但如果它使用了 global 變數就不一定。</p>
<p>reentrancy function 可以是 thread-safe 但不一定是 thread-safe。thread-safe function 可以是 reentrancy 也可以不是（繞口令時間）。function 是 thread-safe 但不是 reentrancy 的例子：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">function <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mutex_lock();</span><br><span class="line">    <span class="comment">//blah...</span></span><br><span class="line">    mutex_unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 single thread 的環境下，如果 <code>foo()</code> 執行到一半被 interrupt 打斷，interrupt handler 又 call <code>foo()</code> 會永遠等不到 mutex unlock，整個卡在那。</p>
<p>達成 reentrancy 的基本原則：</p>
<ul>
<li>不使用 global（或 static）的變數<br>但如果執行過程確保 global 變數或 state 能在執行前後保持一致，是可以用的。</li>
<li>不修改自身的 code</li>
<li>不 call non-reentrant function</li>
</ul>
<h2 id="Thread-safety"><a href="#Thread-safety" class="headerlink" title="Thread-safety"></a>Thread-safety</h2><p>thread-safety 是在 multiple thread 的環境下，thread 間的 shared data 可以在任意執行順序下依然保持正確。</p>
<p>達到 thread-safety 的方式分兩大類，一是避免 race condition，二是 synchronization。</p>
<ol>
<li>避免 race condition<ul>
<li>寫成不使用 global 變數的 reentrancy code<br>這種 reentrancy code 的寫法可以達成 thread-safety，但不是所有 reentrancy code 都是 thread-safety。反之，因為有很多達成 thread-safety 的方式，不是所有 thread-safety 都是 reentrancy。</li>
<li>使用 thread-local storage（TLS）<br>存在 TLS 裡的 data 是屬於某個 thread 的，不會在 thread 間共享。</li>
<li>shared data 使用 immutable object<br>data 不會變當然就沒有 race condition 的問題啦！XD</li>
</ul>
</li>
<li>synchronization<ul>
<li>mutual exclusion 以及其變形們<br>要注意 dead-lock 或 resource starvation 等等問題</li>
<li>atomic operation<br>確保 operation 不會被打斷的，通常有賴 instruction 層級的支援。高階 mutual exclusion 也是需要靠 atomic operation 實作的。</li>
</ul>
</li>
</ol>
<h2 id="不同的-terminology"><a href="#不同的-terminology" class="headerlink" title="不同的 terminology"></a>不同的 terminology</h2><p>不同的 library、系統或語言可能自己定義 thread-safe 跟 reentrant。</p>
<p>例如 <a target="_blank" rel="noopener" href="http://doc.qt.io/qt-5/threads-reentrancy.html">Qt</a> 將 reentrant 以及 thread-safe 都定義在 multiple thread 的環境下。針對 class 來說，Qt 的 thread-safe class 是 multiple thread 可以 call 同一個 class instance 的 member function，而 reentrant class 則是 multiple thread 只要使用不同的 class instance 就能同時 call member function。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/design-models-for-concurrent-algorithems/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/design-models-for-concurrent-algorithems/" class="post-title-link" itemprop="url">Design Models for Concurrent Algorithems</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-09 17:55:22" itemprop="dateCreated datePublished" datetime="2017-07-09T17:55:22+08:00">2017-07-09</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/design-models-for-concurrent-algorithems/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="design-models-for-concurrent-algorithems/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>這篇是設計 concurrent algorithem 的理論概念，沒什麼例子。</p>
<p>兩種設計 concurrent algorithem 的方法：</p>
<ul>
<li>Task Decomposition：計算是一堆獨立的 task，可以由 thread 以任意順序執行。</li>
<li>Data Decomposition：程式處理大量資料，其中個別 element 的計算可以獨立執行。</li>
</ul>
<h2 id="Task-Decomposition"><a href="#Task-Decomposition" class="headerlink" title="Task Decomposition"></a>Task Decomposition</h2><p>task decomposition 的目標是找出完全獨立的計算，才能 concurrent 執行多個 task。但是計算常常互相有關係，這樣的關係稱為 dependency。程式平行化前必須先消除 dependency。</p>
<p>將 sequential 程式轉成 concurrent 程式要確保原本有順序性的步驟也要依序完成，也就是確保 sequential consistency，使得 concurrent 程式在相同的 input 可以得到跟 sequential 程式一樣的結果。</p>
<p>concurrent 程式的基本架構：main thread 定義以及準備 task，產生 thread 執行 task，最後等待 thread 們完成工作。</p>
<p>一種分解 task 的方式是在要進行 concurrent 計算的外層進行分解，接著將 task 分給 thread 執行。另一種是 task 會在計算過程中動態產生，這需要額外程式碼封裝新產生的 task。</p>
<p>Task Decomposition 要考慮：</p>
<ol>
<li>task 是什麼以及如何定義？</li>
<li>task 間的 dependency 為何以及如何滿足？</li>
<li>task 如何分派給 thread？</li>
</ol>
<h3 id="task-是什麼以及如何定義？"><a href="#task-是什麼以及如何定義？" class="headerlink" title="task 是什麼以及如何定義？"></a>task 是什麼以及如何定義？</h3><p>基本上，要識別出能獨立執行的 task，得依靠對程式以及其計算的理解。要對可能平行化執行的程式模擬兩個 thread 一起執行的狀況<em>（真心覺得這靠練習跟經驗，做多了自然會有莫名的直覺(?)）</em>，以此決定 task 是否彼此獨立或有可接受的 dependency。</p>
<p>並行化（concurrent）程式執行最頻繁或者計算最繁重的地方可以有比較好的成效。因為並行化需要修改程式碼、驗證以及debug 等等，也會讓程式變得複雜，當然要選擇最有成效的地方做。除此之外，concurrent 程式會比 sequential 程式多出為了並行化的程式碼，例如管理及分派 task，所以會有 overhead。</p>
<p>找到可以獨立執行的 task 後，拆分 task 需注意：</p>
<ol>
<li>task 數量至少要跟 thread 或 core 數量一樣多。<br>確保不會有 idle 的 thread，能達到較好的 load balance。</li>
<li>每個 task 的計算量（granularity）必須大到能抵消管理 task 及 thread 的 overhead。<br>coarse-grained 代表 granularity 高（task 的計算量高），fine-grained 代表 granularity 低。如果 task 的 granularity 不夠大，光是管理 task 跟 thread 的 overhead 就把效能提升給吃光了。</li>
</ol>
<p>這兩個條件看起來有點矛盾，因為在總 task 固定的情況下 task 愈大數量愈少，反之亦然，因此    要在 task 計算量及數量間取得平衡。並行化（concurrent）程式最主要的目的是減少執行時間，如果使用所有 core/thread 卻需要較長執行時間，寧可調整為使用較少 core/thread 但執行時間較短的 task decomposition。</p>
<p>拆分 task 可能需要多次嘗試，一個切法的效果不太好，就應該嘗試其他分解方式。</p>
<h3 id="task-間的-dependency-為何以及如何滿足？"><a href="#task-間的-dependency-為何以及如何滿足？" class="headerlink" title="task 間的 dependency 為何以及如何滿足？"></a>task 間的 dependency 為何以及如何滿足？</h3><p>task 間的 dependency 有兩種：</p>
<ol>
<li>執行順序的 dependency<br>某些 task 必須等其他 task 完成才能做，可能是需要前面 task 的結果作為參數。<br>要滿足執行順序 dependency 最簡單的方式是將有此 dependency 的 task 交給同一個 thread 執行。但當某 task 需要許多 thread 的 task 完成後才能執行，或者 thread 間有執行順序的限制（例如要 thread1 做完前幾步 thread2 才能執行），而且無法以其他 task decomposition 處理時就得加入 synchoronization 機制來確保 thread 間的執行順序。</li>
<li>data dependency<br>區分是否有 data dependency 的方法：先列出所有 assignment 左邊的變數，檢查這些變數是否有並行（concurrent）寫入或者寫入與讀取會並行發生的狀況，因為至少要有一個 thread 寫入變數才會有 data dependency。找到 data dependency 後就要看能不能消除 dependency。消除 data dependency 有很多種作法，最簡單的是以互斥存取（mutually exclusive access）的方式 access shared data，也就是使用 lock 或 mutex 保護資料。</li>
</ol>
<p>消除 dependency 的方法很多，不見得都得用 mutually exclusive access，如果可以以消除 dependency 的作法來達到 concurrency，就可以減少使用 synchoronization 物件帶來的 overhead。</p>
<h3 id="task-如何分派給-thread？"><a href="#task-如何分派給-thread？" class="headerlink" title="task 如何分派給 thread？"></a>task 如何分派給 thread？</h3><p>thread 執行時希望各 thread 有差不多的計算量，平衡 thread 們的 loading。</p>
<p>兩種分派 task 的方式：static scheduling 以及 dynamic scheduling。</p>
<p>static scheduling 會要並行化（concurrent）的計算外面決定 task 的切分，而且計算過程中不會改變。實作 static scheduling 會讓 N 個 thread 有 0 到 N-1 的唯一識別碼，可以透過識別碼分派 task 給 thread。static scheduling 適用於每個 task 的運算量差不多，或是能預先知道計算量的情況。反之，各 task 計算量變動大或無法預先知道的狀況比較適合 dynamic scheduling。</p>
<p>dynamic scheduling 在計算過程中才將 task 指派給 thread，會儘量平均各 thread 的計算量，理想上會有較好的 load balance。分派 task 給 thread 以及 thread 找新 task 的邏輯是原先 sequential 程式沒有的，這些額外的邏輯當然有 overhead。</p>
<p>最簡單的 scheduling 是為 task 加上 index，用 counter 記錄下一個要分派的 task，當 thread 要新 task 時就從 counter 得知拿哪個 task。這個 counter 是 thread 間共用的，因此 access 它需要 mutually exclusive。另一種 dynamic scheduling 使用 shared container 保存 task，通常會用 queue，thread 從 container 拿新 task 執行，例如 producer-consumer 就是這種方式的變形。因為放在 container 裡，task 必須被封裝成可以放進 container 的結構，例如可能是一包描述 task input 的 structure。</p>
<h2 id="Data-Decomposition"><a href="#Data-Decomposition" class="headerlink" title="Data Decomposition"></a>Data Decomposition</h2><p>計算是一連串更新一個或多個巨大 data structure 中的 element 時，如果這些更新是彼此獨立的，則可以切割 data structure 並將不同部份分給不同 thread 處理，進而達到並行化（concurrent）。切割 data structure 並交給 thread 處理的方法稱為 data decomposition。</p>
<p>如何將 data structure 切割成多個連續區域（稱為 chunk）取決於 data structure 的 type，例如常見的 array 會依照 dimension 來切割。</p>
<p>將資料分割成 chunk 也代表將整個計算分解成針對單一 chunk 的 task，這些 task 會分配給 thread 執行。由於資料是已經分解過的，所以 thread 可以安心使用這些 data，不需要擔心其他 thread 也會使用到。但如果計算需要 chunk 鄰近的資料，task 間就得共享這些資料，thread 也需要彼此協調資料存取。</p>
<p>data decomposition 要考慮：</p>
<ol>
<li>如何將資料分割成 chunk？</li>
<li>如何確保 task 能 access 到其計算所需的所有資料？</li>
<li>如何分派 chunk 給 thread？</li>
</ol>
<h3 id="如何將資料分割成-chunk？"><a href="#如何將資料分割成-chunk？" class="headerlink" title="如何將資料分割成 chunk？"></a>如何將資料分割成 chunk？</h3><p>每個 chunk 都跟 task 有關，要考慮上述 task 的幾個條件，除此之外還需要注意：</p>
<ol>
<li>每個 thread 至少分到一個 chunk，每個 thread 分到的 chunk 愈多愈好。</li>
<li>處理 chunk 的計算量要遠大於分割 data 所產生的 overhead。<ol>
<li>task 處理 chunk 需要的計算量一樣稱為 granularity，granularity 跟 chunk 中的 element 數量有關。</li>
<li>分割 data 還需要考慮 chunk 的 shape（就是形狀啦）。chunk 的 shape 決定了跟相鄰 chunk 的關係以及計算時如何處理資料交換，shape 並不見得是畫得出來、看得到的形狀，而是 chunk 之間的「關係」。資料交換是為了計算與更新自己的資料而需要去 access 別人（別的 chunk）的資料。如果每個 chunk 的邊界（處在邊界的 element）都需要資料交換，減少整體邊界數量就能減少資料交換。針對每個 chunk 減少與其相鄰的 chunk 數量也能降低交換資料的程式複雜度，因為一個 chunk 與愈多 chunk 相鄰代表一個 task 跟更多 task 有關聯。</li>
</ol>
</li>
</ol>
<p>考慮 chunk 的 shape 時，granularity 愈大表示 chunk 擁有的 element 數量愈多，也代表有愈多需要資料交換的 element，因此資料交換的 overhead 愈大，又需要在 shape 與 granularity 之間取得平衡。針對這個問題，一個解法是最大化 volume-to-surface ratio，也就是 chunk 的 element 數量與需要交換資料的邊界比例，也就是 <code>chunk 的 element 數 / chunk 中在邊界的 element 數</code>。例如一個 4 x 8 的資料（想像一個二維陣列），分割成兩個 2 x 8 的 chunk，volume-to-surface ratio 是  16 / 8 = 2，分割兩個 4 x 4 的 chunk 則是 16 / 4 = 4。</p>
<h3 id="如何確保-task-能-access-到其計算所需的所有資料？"><a href="#如何確保-task-能-access-到其計算所需的所有資料？" class="headerlink" title="如何確保 task 能 access 到其計算所需的所有資料？"></a>如何確保 task 能 access 到其計算所需的所有資料？</h3><p>如果 chunk 內包含計算與更新所需的所有資料，task 間就不需要協調資料交換<del>（這不是廢話）</del>。反之，如果計算需要鄰近 chunk 的資料，就得找出較有效率的資料交換機制。一般有兩種方法：將資料從鄰近 chunk 複製到 task/thread 的 local structure，或者直接 access 鄰近 chunk 的資料。</p>
<p>如果鄰近 chunk 的資料不會隨著計算改變，複製資料是比較容易的方法，因為不需要處理同步問題。缺點是需要額外的儲存空間存放資料副本。這些額外配置的儲存空間一般稱為 ghost cells。複製資料也需要考慮複製次數，如果次數太多或每次複製太多資料，比較適合直接 access 鄰近 chunk 的資料。</p>
<p>直接 access 鄰近 chunk 的資料可以利用 thread 間以 shared memory 為基礎的溝通機制，在真正需要資料前也可以不用協調。缺點是必須確保拿到正確的資料，尤其是鄰近 chunk 也會更新其資料的時候。要確保拿到正確的資料，得找出計算過程中資料交換與更新資料間的關係或互動，才能知道如何協調。有些 sequential 程式計算 element 時需要鄰近 element 的舊資料而非更新後的新資料，此時 sequential 程式與 concurrent 程式遇到的問題是一樣的，concurrent 程式有時能借用 sequential 程式的解法。</p>
<h3 id="如何分派-chunk-給-thread？"><a href="#如何分派-chunk-給-thread？" class="headerlink" title="如何分派 chunk 給 thread？"></a>如何分派 chunk 給 thread？</h3><p>類似 task decomposition，與 chunk 關聯的 task 可以用 static 或 dynamic scheduling 指派給 thread。static scheduling 所有跟資料交換有關的協調可以在計算外面、也就是計算開始前處理好，適合 task 的計算是一致或可預期的情況。如果 task 處理各 chunk 的計算量不一致，dynamic scheduling 可能有比較好的 load balance，但也讓資料更新、交換以及與其他 task 協調變得複雜。</p>
<p>data decomposition 中 task 是由資料的分解方式定義的，應該以 task 間的關係找出所需的互動，不管這個 task 是由哪個 thread 執行。</p>
<h2 id="選擇-Design-Model-需考量的因素"><a href="#選擇-Design-Model-需考量的因素" class="headerlink" title="選擇 Design Model 需考量的因素"></a>選擇 Design Model 需考量的因素</h2><p>在做 task 或 data decomposition 時，會考量以下四個因素以建立最有效率的 concurrent solution：</p>
<ol>
<li>Efficiency（效率）<br>效率必須考慮 concurrency 帶來的額外 overhead、thread 的調配以及 task 的組織方式等等問題。</li>
<li>Simplicity<br>concurrent algorithem 愈簡單愈容易開發、debug、驗證以及維護。simplicity 著重在要加多少額外程式碼才能將程式並行化（concurrent）。</li>
<li>Portability<br>使用不同 multiple threading model 的取捨。</li>
<li>Scalability<br>考量 concurrent 程式在不同 core/thread 數以及 data set 上的行為如何。照目前的趨勢，機器的 core 數會愈來愈多，concurrent 程式應該要能夠有效率的在不同數量的 thread/core 或不同大小的 data set 上執行。</li>
</ol>
<p>重要性：scalability &gt; efficiency &gt; simplicity ~ portability</p>
<p>有時候 concurrent 程式的 scalability 會在某個階段達到高峰後趨於平緩，這可能是因為 algorithem 的需求或是 threading model 提供的環境。遇到這種狀況要評估是否值得花更多力氣嘗試提高 scalability 或者使用不同的 threading model 重新寫過。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Open-Street-Map-API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Open-Street-Map-API/" class="post-title-link" itemprop="url">Open Street Map API</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-04-15 23:43:15" itemprop="dateCreated datePublished" datetime="2017-04-15T23:43:15+08:00">2017-04-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Open-Street-Map-API/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Open-Street-Map-API/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>記錄開放街圖 Open Street Map（OSM） API 的基本使用跟文件。</p>
<h2 id="Editing-API"><a href="#Editing-API" class="headerlink" title="Editing API"></a>Editing API</h2><p>RESTful API，data 格式為 XML，目前版本為 v0.6。</p>
<p>文件：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://wiki.openstreetmap.org/wiki/API">http://wiki.openstreetmap.org/wiki/API</a></li>
<li><a target="_blank" rel="noopener" href="http://wiki.openstreetmap.org/wiki/API_v0.6">http://wiki.openstreetmap.org/wiki/API_v0.6</a></li>
</ul>
<p>程式化編輯資料要注意的事情：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://wiki.openstreetmap.org/wiki/API#Terms_of_use">http://wiki.openstreetmap.org/wiki/API#Terms_of_use</a></li>
<li><a target="_blank" rel="noopener" href="http://wiki.openstreetmap.org/wiki/Automated_Edits_code_of_conduct">http://wiki.openstreetmap.org/wiki/Automated_Edits_code_of_conduct</a></li>
</ul>
<p>OSM 有提供測試用 API，測試站跟正式網站的帳號是分開的。</p>
<ul>
<li>測試站：<a target="_blank" rel="noopener" href="https://master.apis.dev.openstreetmap.org/">https://master.apis.dev.openstreetmap.org/</a></li>
<li>測試用 API：<a target="_blank" rel="noopener" href="https://master.apis.dev.openstreetmap.org/">https://master.apis.dev.openstreetmap.org/</a></li>
<li>正式 API：<a target="_blank" rel="noopener" href="http://api.openstreetmap.org/">http://api.openstreetmap.org/</a> </li>
</ul>
<p>編輯修改 element 必須 reference 到一個 changeset，可以想成修改 log。changeset 跟 element 一樣有 tag，文件建議包含 <code>comment=*</code> 以及 <code>created_by=*</code> tag，簡述改了什麼以及由誰修改。</p>
<h3 id="API-使用流程"><a href="#API-使用流程" class="headerlink" title="API 使用流程"></a>API 使用流程</h3><ol>
<li>生一個 changeset 得到 changeset id</li>
<li>call API 修改 element，會帶 changeset id</li>
<li>關閉 changeset</li>
</ol>
<p>changeset 如果沒有關掉，<a target="_blank" rel="noopener" href="http://wiki.openstreetmap.org/wiki/API_v0.6#Changesets_2">OSM 有規則會自動關閉它</a>。</p>
<h3 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h3><p>editing API 需要 authentication，可以用 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Basic_access_authentication">HTTP basic authentication</a>，即在 http header 加上 <code>Authorization: Basic xxx</code>，其中 <code>xxx</code> 是 <code>user:password</code> 的 base64 字串。nodejs 下可以用 <code>new Buffer(&quot;Hello World&quot;).toString(&#39;base64&#39;);</code> 得到 base64 字串。</p>
<p>以 <code>curl</code> 送 request：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">$ curl https:<span class="regexp">//m</span>aster.apis.dev.openstreetmap.org<span class="regexp">/api/</span>capabilities</span><br><span class="line">$ curl -H <span class="string">&quot;Authorization: Basic xxx&quot;</span> https:<span class="regexp">//m</span>aster.apis.dev.openstreetmap.org<span class="regexp">/api/</span><span class="number">0.6</span>/permissions</span><br></pre></td></tr></table></figure>
<p>除了 HTTP basic authentication 外也可以使用 <a target="_blank" rel="noopener" href="http://wiki.openstreetmap.org/wiki/OAuth">OAuth</a>，這我沒研究。</p>
<p>剩下 API 使用參考<a target="_blank" rel="noopener" href="http://wiki.openstreetmap.org/wiki/API_v0.6#API_calls">文件定義</a>囉。</p>
<h2 id="Overpass-API"><a href="#Overpass-API" class="headerlink" title="Overpass API"></a>Overpass API</h2><p>read only API</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://wiki.openstreetmap.org/wiki/Overpass_API">http://wiki.openstreetmap.org/wiki/Overpass_API</a></li>
<li><a target="_blank" rel="noopener" href="http://wiki.openstreetmap.org/wiki/Overpass_API/XAPI_Compatibility_Layer">http://wiki.openstreetmap.org/wiki/Overpass_API/XAPI_Compatibility_Layer</a></li>
</ul>
<p>Overpass API 有幾種 query 語法，大致分成 XML query format 跟 Overpass QL，相關文件：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://wiki.openstreetmap.org/wiki/Overpass_API/Language_Guide">http://wiki.openstreetmap.org/wiki/Overpass_API/Language_Guide</a></li>
<li><a target="_blank" rel="noopener" href="http://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_QL">http://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_QL</a></li>
</ul>
<p>我只用 XAPI Compatibility Layer 做簡單的 map 讀取跟 tag query，沒使用上面比較複雜的 query 功能。</p>
<p>XAPI Compatibility Layer 基本 HTTP GET：</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">http</span>://www.overpass-api.de/api/xapi?map?bbox=left,bottom,right,top</span><br><span class="line"><span class="attribute">http</span>://www.overpass-api.de/api/xapi?map?bbox=<span class="number">121</span>.<span class="number">53828</span>,<span class="number">25</span>.<span class="number">045</span>,<span class="number">121</span>.<span class="number">540</span>,<span class="number">25</span>.<span class="number">05</span></span><br><span class="line"><span class="attribute">http</span>://www.overpass-api.de/api/xapi?node[bbox=<span class="number">121</span>.<span class="number">53828</span>,<span class="number">25</span>.<span class="number">045</span>,<span class="number">121</span>.<span class="number">55</span>,<span class="number">25</span>.<span class="number">06</span>][highway=traffic_signals]</span><br></pre></td></tr></table></figure>
<p>tag 可以串很多，會被 and 起來，其中 node 也可以改成 way 跟 relation。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Use-Shared-Library-in-Linux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Use-Shared-Library-in-Linux/" class="post-title-link" itemprop="url">Use Shared Library in Linux</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-04-14 22:25:09" itemprop="dateCreated datePublished" datetime="2017-04-14T22:25:09+08:00">2017-04-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Use-Shared-Library-in-Linux/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Use-Shared-Library-in-Linux/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="執行檔如何尋找-shared-library"><a href="#執行檔如何尋找-shared-library" class="headerlink" title="執行檔如何尋找 shared library"></a>執行檔如何尋找 shared library</h2><p>ELF 將依賴的 shared library 存在 <code>.dynamic</code> section 的 <code>DT_NEED</code> 欄位。</p>
<figure class="highlight vhdl"><table><tr><td class="code"><pre><span class="line">$ readelf -d main</span><br><span class="line"></span><br><span class="line">Dynamic section at offset <span class="number">0</span>x868 contains <span class="number">26</span> entries:</span><br><span class="line">  Tag        <span class="keyword">Type</span>                         Name/Value</span><br><span class="line"> <span class="number">0</span>x0000000000000001 (NEEDED)             <span class="keyword">Shared</span> <span class="keyword">library</span>: [./libfoo.so]</span><br><span class="line"> <span class="number">0</span>x0000000000000001 (NEEDED)             <span class="keyword">Shared</span> <span class="keyword">library</span>: [./libbar.so]</span><br><span class="line"> <span class="number">0</span>x0000000000000001 (NEEDED)             <span class="keyword">Shared</span> <span class="keyword">library</span>: [libc.so.<span class="number">6</span>]</span><br></pre></td></tr></table></figure>
<p>如果是絕對路徑， dynamic linker 直接去該路徑存取 shared library。如果是相對路徑，則會依照以下順序到不同路徑下找 library：</p>
<ul>
<li><code>LD_LIBRARY_PATH</code> 環境變數指定的路徑</li>
<li><code>.dynamic</code> section 中 <code>DT_RUNPATH</code> 欄位記錄的路徑</li>
<li><code>/etc/ld.so.conf</code> 設定的路徑（實際上是讀取 <code>/etc/ld.so.cache</code>）</li>
<li><code>/lib</code></li>
<li><code>/usr/lib</code></li>
</ul>
<p>因為一個個搜尋路徑很慢，所以指令 <code>ldconfig</code> 除了更新系統中 library 的 SO-NAME soft link 外，還會將這些 SO-NAME 以特殊的形式存在 <code>/etc/ld.so.cache</code> 作為 cache 以加快搜尋。所以增加、刪除或更新 shared library 以及修改 <code>/etc/ld.so.conf</code> 後，都要執行 <code>ldconfig</code> 來更新 SO-NAME。</p>
<h2 id="環境變數"><a href="#環境變數" class="headerlink" title="環境變數"></a>環境變數</h2><p>幾個跟 dynamic linking 有關的常用環境變數。</p>
<h3 id="LD-LIBRARY-PATH"><a href="#LD-LIBRARY-PATH" class="headerlink" title="LD_LIBRARY_PATH"></a>LD_LIBRARY_PATH</h3><p>臨時改變 shared library 的搜尋路徑，開發跟 debug 的時候很好用。</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">$ LD_LIBRARY_PATH=<span class="regexp">/home/</span>foo ls</span><br></pre></td></tr></table></figure>
<h3 id="LD-PRELOAD"><a href="#LD-PRELOAD" class="headerlink" title="LD_PRELOAD"></a>LD_PRELOAD</h3><p>可以指定預先 load 的 shared library 或 object file，無論執行檔或使用的 shared library 有沒有依賴它。因為會使用先 load 的 shared library 的 symbol，所以可以用來改掉原本執行檔使用的 shared library，例如 standard C library。</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">$ LD_PRELOAD=.<span class="regexp">/libfoo.so ./m</span>ain</span><br></pre></td></tr></table></figure>
<h3 id="LD-DEBUG"><a href="#LD-DEBUG" class="headerlink" title="LD_DEBUG"></a>LD_DEBUG</h3><p>可以看 dynamic linker 的 debug 訊息，設成 <code>help</code> 可以看可設定的值。</p>
<h2 id="建立-amp-安裝-shared-library"><a href="#建立-amp-安裝-shared-library" class="headerlink" title="建立 &amp; 安裝 shared library"></a>建立 &amp; 安裝 shared library</h2><p>build 出 shared library：</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">$ gcc -<span class="keyword">shared</span> -fPIC -Wl,-soname,mysoname -o library_name sources</span><br></pre></td></tr></table></figure>
<p><code>-shared</code> 表示輸出 shared library，<code>-fPIC</code> 表示使用 <a href="/Dynamic-Linking-PIC/">PIC</a>。<code>-Wl</code> 可以將參數傳給 linker。<code>-soname</code> 是指定 SO-NAME，如果不指定，shared library 預設沒有 SO-NAME，即無法用 <code>ldconfig</code> 建 soft link。shared library 的 SO-NAME 可以用 <code>readelf -d</code> 查看。</p>
<p>去除 symbol 資訊可以讓 shared library 檔案變小，常用在 release 時：</p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>strip libfoo.so</span><br></pre></td></tr></table></figure>
<p>安裝 shared library 通常是放到系統相關的路徑下，例如 <code>/lib</code>、<code>/usr/lib</code> 等，然後執行 <code>ldconfig</code> 更新 soft link。不過通常安裝會用 <code>make install</code> 之類的指令，不需要手動 copy 跟 <code>ldconfig</code>。</p>
<h2 id="Related-Posts-amp-Ref"><a href="#Related-Posts-amp-Ref" class="headerlink" title="Related Posts &amp; Ref"></a>Related Posts &amp; Ref</h2><ul>
<li>ld-linux manual</li>
<li>《程式設計師的自我修養》ch8</li>
<li><a href="/Dynamic-Linking-Basic/">Dynamic Linking Basic</a></li>
<li><a href="/Dynamic-Linking-PIC/">Dynamic Linking PIC</a></li>
<li><a href="/Dynamic-Linking-Relocation/">Dynamic Linking Relocation</a></li>
<li><a href="/Shared-Library-Versioning/">Shared Library Versioning</a></li>
<li><a href="/Explicit-Runtime-Linking/">Explicit Runtime Linking</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Shared-Library-Versioning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Shared-Library-Versioning/" class="post-title-link" itemprop="url">Shared Library Versioning</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-04-03 16:53:36" itemprop="dateCreated datePublished" datetime="2017-04-03T16:53:36+08:00">2017-04-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Shared-Library-Versioning/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Shared-Library-Versioning/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="相容性問題"><a href="#相容性問題" class="headerlink" title="相容性問題"></a>相容性問題</h2><p>使用 library 其中一個目標是不需要重新 compile 就能方便的升級程式的部份功能或者修正 bug。理想上，升級 library 只需要用新的檔案取代舊的。但是事情沒那麼美好，舊程式不見得能正常使用新 library，新舊程式間會有相容性問題。</p>
<p>依據舊程式能不能使用新 library，library 的更新分為相容更新與不相容更新。相容更新通常不修改 interface，可能只是修正 bug 或者加點新東西。不相容更新則改變了 interface，這時舊版程式無法正常使用新版 library。</p>
<p>library 以 binary 的形式發佈，代表 interface 是 binary 層級，也就是 ABI（Application Binary Layer），包含 call function 的 stack 結構、symbol 命名、memory 配置、參數的結構等等。</p>
<p>ABI 跟語言有很大關係，以 C 語言來說，只要跟 export 的 symbol（function 跟 variable）有關的修改，都會動到 ABI，例如增加 export 變數、增減 export 的 function 參數、修改 export 的資料結構（會改變 memory 配置，程式依舊配置使用新結構會踩壞記憶體）等等。至於 C++ <del>基本上是場災難</del>，因為各家 compiler 甚至相同 compiler 的不同版本可能都對 C++ 的各種特性諸如 virtual function 等有不同實作方式，這會造成 ABI 不相容。C++ 有一些避免改到 interface 的原則及作法，例如 pimpl。</p>
<h2 id="版號"><a href="#版號" class="headerlink" title="版號"></a>版號</h2><p>既然有相容性問題，程式如何知道能不能使用新 library？系統必須有方法確保相容性、讓程式能正常執行，其中一個方法是以版號區分不同版本的 library，並讓程式指定它相容於哪些版本的 library。</p>
<p>在 Linux 系統中，shared library 的檔案命名規則為 <code>libname.so.x.y.z</code>。最前面是字首 <code>lib</code>，中間是 library 名稱，接著 <code>.so</code>，最後跟著三個版號數字。<code>x</code> 表示 major versison number，<code>y</code> 是 minor version number，<code>z</code> 為 release version number。</p>
<p>major version number 代表 library 有重大升級，不同 major version number 的 library 是不相容的。使用舊版的程式必須要經過修改及重新 compile 才能使用新版 library。系統中需要保留舊版 library 以讓未更新至使用新版 library 的程式依然能正常執行。</p>
<p>minor version number 表示 library 是增量升級，也就是加一些新的 interface 並且保持原本的 symbol 在名稱與語意上皆不變，例如增加一個 function。在 major version number 相同的狀況下，高 minor version number 的 library 向後相容低 minor version number 的 library，使用舊版 library 的程式可以使用新版 library，例如使用 <code>1.1.z</code> libary 的程式可以在 <code>1.2.z</code> library 上正常執行。</p>
<p>release version number 是 library 的 bug 修正、效能改進等等，不添加新 interface 也不改動舊 interface。因此相同 major version number 以及 minor version number 的不同 release version 之間的 library 完全相容，依賴某個 release version 的程式可以使用其他任一 release version。</p>
<h3 id="SO-NAME"><a href="#SO-NAME" class="headerlink" title="SO-NAME"></a>SO-NAME</h3><p>library 有版號之後，程式如何指定使用的 library 版本？</p>
<p>在 Solaris 跟 Linux 裡採用 SO-NAME 命名機制，SO-NAME 是 library 版號只保留 major version number，去掉 minor version 以及 release version，例如 <code>libfoo.so.3.2.1</code> 的 SO-NAME 是 <code>libfoo.so.3</code>。</p>
<p>Linux 系統會建立檔名為 SO-NAME 並指向 major version 相同、最新 minor 及 release version 的 library 實體檔案的 soft link，例如 <code>/usr/lib/libcln.so.6</code> 指向 <code>/usr/lib/libcln.so.6.0.4</code>。這麼做的好處是系統中的程式只需要記錄 library 的 SO-NAME，再藉由 soft link 就能使用該 major version 最新的 library。</p>
<p>記錄 SO-NAME 提供了一些彈性，讓 library 有一定的升級空間，不會讓程式只限定於某版本的 library。同時又能知道何種狀況是大幅度的更新，系統不應該自動使用新 major version 的 library，需保留舊版 library 讓使用的程式可以正常執行。當然，話是這麼說，版號只是個規則，還是需要由開發者判斷新版是否向後相容以決定如何升版號。</p>
<p>ELF 在 <code>.dynamic</code> 以 SO-NAME 記錄所需的 shared library：</p>
<figure class="highlight delphi"><table><tr><td class="code"><pre><span class="line">$ readelf -d main</span><br><span class="line"><span class="keyword">Dynamic</span> section at offset <span class="number">0</span>x868 contains <span class="number">26</span> entries:</span><br><span class="line">  Tag        <span class="keyword">Type</span>                         <span class="keyword">Name</span>/Value</span><br><span class="line">...</span><br><span class="line"> <span class="number">0</span>x0000000000000001 (NEEDED)             Shared <span class="keyword">library</span>: [libc.so.<span class="number">6</span>]</span><br></pre></td></tr></table></figure>
<p>Linux 指令 <code>ldconfig</code> 用來更新上述 library 的 soft link，它會掃過所有預設 shared library directory，例如 <code>/lib</code>、<code>/usr/lib</code> 等，更新所有 soft link，將其指向目前系統中最新的 library 或為新 library 建立 soft link。安裝或更新 library 需要執行 <code>ldconfig</code>。</p>
<h3 id="link-name"><a href="#link-name" class="headerlink" title="link name"></a>link name</h3><p>compile 時我們以 <code>-lXXX</code> 指定要 link 的 library，這個 <code>XXX</code> 稱為 link name。指定 link name 時省略了版號，compiler 會到系統相關的搜尋路徑中尋找最新版本的 <code>XXX</code> library。</p>
<h2 id="Symbol-Versioning"><a href="#Symbol-Versioning" class="headerlink" title="Symbol Versioning"></a>Symbol Versioning</h2><p>SO-NAME 有升級彈性，但仍有問題──假設依賴的 library 是 <code>libfoo.2.3.1</code>，SO-NAME 是 <code>libfoo.2</code>，但執行環境中只有 <code>libfoo.2.2.1</code>，以 SO-NAME 來看是正確的，但卻可能不相容，因為程式可能使用 <code>libfoo.2.3.1</code> 才有的 interface，這在 <code>libfoo.2.2.1</code> 中找不到，因而執行錯誤。這個問題稱為 Minor-revision Rendezvous Problem。</p>
<p>為解決 Minor-revision Rendezvous Problem，Solaris 2.5 發展出 symbol versioning 機制，提供 versioning 以及 scoping 機制。</p>
<h3 id="Versioning"><a href="#Versioning" class="headerlink" title="Versioning"></a>Versioning</h3><p>基本概念是在每個 import 及 export symbol 加上版號，例如 <code>libfoo.1.3</code> 要更新為 <code>libfoo.1.4</code> 時，就把 <code>libfoo.1.4</code> 增加的 symbol 加上 <code>VERS_1.4</code> 的標記。如此 SO-NAME 是 <code>libfoo.1</code> 各版 library 裡會有 <code>VERS_1.2</code>、<code>VERS_1.3</code>、<code>VERS_1.4</code> 等等擁有不同版號標記的 symbol，就能區別 symbol 的版本了。</p>
<p>versioning 定義了一些 symbol 集合。symbol 集合有名稱，例如 <code>VERS_1.2</code>，每個集合包含一些 symbol，一個集合能包含另一個集合，例如 <code>VERS_1.2</code> 包含 <code>VERS_1.1</code>，這種包含關係也像是繼承，<code>VERS_1.2</code> 繼承 <code>VERS_1.1</code> 的 symbol。symbol 集合由 symbol version script 指定，在 <code>gcc</code> 可以用 <code>-Xlinker --version-script &lt;script file&gt;</code> 指定。</p>
<p>versioning 機制讓 symbol 可以標上版號，build 執行檔時會記錄它需要的 symbol 及其版號。因為 symbol 只能有一個 version，在相同 major version 的 library 中，同一個 symbol 的 version 是固定的，否則會導致向後不相容。因此，執行檔執行時可以用 SO-NAME 找到系統中最新的 library，接著看它是不是有所需要版本的 symbol，如果有就能正常執行，以此解決 Minor-revision Rendezvous Problem。</p>
<p>但 Solaris 2.5 的 symbol versioning 有個限制：在一個 shared library 中每個 symbol 只能有一個 version，也就是如果 symbol 是 <code>VERS_1.1</code> 就不能再是 <code>VERS_1.2</code>。這造成如果 interface 只有小修改，例如只加一個參數、依然向後相容（只是擴充，舊有功能不變），由於無法讓新版 library 標示該 symbol 為新版，只能透過增加 major version 來表示 interface 改變，有點小題大作。</p>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><p>source code</p>
<figure class="highlight h"><figcaption><span>foo-1.0.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>foo-1.0.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123; <span class="keyword">return</span> (x + y); &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight h"><figcaption><span>foo-1.1.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo2</span><span class="params">(<span class="keyword">int</span> x)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>foo-1.1.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123; <span class="keyword">return</span> (x + y); &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo2</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; <span class="keyword">return</span> (x + x); &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>main1.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;foo-1.0.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, foo(<span class="number">2</span>, <span class="number">3</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>main2.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;foo-1.1.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, foo(<span class="number">2</span>, <span class="number">3</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, foo2(<span class="number">12</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>foo.1.0.ver</span></figcaption><table><tr><td class="code"><pre><span class="line">VERS_1.0 &#123;</span><br><span class="line">    global:</span><br><span class="line">        foo;</span><br><span class="line">    local:</span><br><span class="line">        *;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>foo.1.1.ver</span></figcaption><table><tr><td class="code"><pre><span class="line">VERS_1.0 &#123;</span><br><span class="line">    global:</span><br><span class="line">        foo;</span><br><span class="line">    local:</span><br><span class="line">        *;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">VERS_1.1 &#123;</span><br><span class="line">    global:</span><br><span class="line">        foo2;</span><br><span class="line">&#125; VERS_1.0;</span><br></pre></td></tr></table></figure>
<p>library 版本更新的時候，可由新的 symbol 集合看出它的 interface 改動，例如上面 <code>1.1</code> 版繼承了 <code>1.0</code> 版、增加了 symbol <code>foo2</code>。</p>
<figure class="highlight makefile"><figcaption><span>Makefile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="section">1.0:</span></span><br><span class="line">        gcc -shared -fPIC foo-1.0.c -Xlinker --version-script foo.1.0.ver -o libfoo.1.0.so</span><br><span class="line">        rm -f libfoo.so</span><br><span class="line">        ln -s libfoo.1.0.so libfoo.so</span><br><span class="line">        gcc main1.c ./libfoo.so -o main1</span><br><span class="line"></span><br><span class="line"><span class="section">1.1:</span></span><br><span class="line">        gcc -shared -fPIC foo-1.1.c -Xlinker --version-script foo.1.1.ver -o libfoo.1.1.so</span><br><span class="line">        rm -f libfoo.so</span><br><span class="line">        ln -s libfoo.1.1.so libfoo.so</span><br><span class="line">        gcc main2.c ./libfoo.so -o main2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>看看 library 的 export symbol：</p>
<figure class="highlight tap"><table><tr><td class="code"><pre><span class="line">$ readelf --dyn-syms libfoo.1.0.so </span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.dynsym&#x27; contains<span class="number"> 9 </span>entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     1: 00000000000004b0    <span class="number"> 0 </span>SECTION LOCAL  DEFAULT  <span class="number"> 10 </span></span><br><span class="line">     2:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab</span><br><span class="line">     3:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">     4:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  WEAK   DEFAULT  UND _Jv_RegisterClasses</span><br><span class="line">     5:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable</span><br><span class="line">     6:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>FUNC    WEAK   DEFAULT  UND __cxa_finalize@GLIBC_2.2.5 (3)</span><br><span class="line">     7:<span class="number"> 0000000000000600 </span>  <span class="number"> 20 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 12 </span>foo@@VERS_1.0</span><br><span class="line">     8:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>OBJECT  GLOBAL DEFAULT  ABS VERS_1.0</span><br><span class="line"></span><br><span class="line">$ readelf --dyn-syms libfoo.1.1.so </span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.dynsym&#x27; contains<span class="number"> 11 </span>entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     1:<span class="number"> 0000000000000528 </span>   <span class="number"> 0 </span>SECTION LOCAL  DEFAULT  <span class="number"> 10 </span></span><br><span class="line">     2:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab</span><br><span class="line">     3:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">     4:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  WEAK   DEFAULT  UND _Jv_RegisterClasses</span><br><span class="line">     5:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable</span><br><span class="line">     6:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>FUNC    WEAK   DEFAULT  UND __cxa_finalize@GLIBC_2.2.5 (4)</span><br><span class="line">     7:<span class="number"> 0000000000000680 </span>  <span class="number"> 20 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 12 </span>foo@@VERS_1.0</span><br><span class="line">     8:<span class="number"> 0000000000000694 </span>  <span class="number"> 14 </span>FUNC    GLOBAL DEFAULT  <span class="number"> 12 </span>foo2@@VERS_1.1</span><br><span class="line">     9:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>OBJECT  GLOBAL DEFAULT  ABS VERS_1.0</span><br><span class="line">    10:<span class="number"> 0000000000000000 </span>   <span class="number"> 0 </span>OBJECT  GLOBAL DEFAULT  ABS VERS_1.1</span><br></pre></td></tr></table></figure>
<p>兩個 library 的 symbol <code>foo</code> 後面加上 <code>VERS</code> 資訊。如果多個 symbol 集合裡有相同 symbol，第一次出現 symbol 的集合是該 symbol 的 version。另外，會被包含的集合必須先寫。也就是說 symbol version 的前後關係是由 version script 指定的，通常遵照數字順序寫（不然會誤導別人啦）。</p>
<p>執行檔可以看到使用的 symbol 版本：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">$ readelf <span class="comment">--dyn-syms main1</span></span><br><span class="line"></span><br><span class="line">Symbol <span class="keyword">table</span> <span class="string">&#x27;.dynsym&#x27;</span> <span class="keyword">contains</span> <span class="number">8</span> entries:</span><br><span class="line">   Num:    <span class="keyword">Value</span>          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  <span class="keyword">LOCAL</span>  <span class="keyword">DEFAULT</span>  UND </span><br><span class="line">     <span class="number">1</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   <span class="keyword">DEFAULT</span>  UND _ITM_deregisterTMCloneTab</span><br><span class="line">     <span class="number">2</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>  UND foo<span class="variable">@VERS</span>_1<span class="number">.0</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="number">3</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>  UND printf<span class="variable">@GLIBC</span>_2<span class="number">.2</span><span class="number">.5</span> (<span class="number">3</span>)</span><br><span class="line">     <span class="number">4</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>  UND __libc_start_main<span class="variable">@GLIBC</span>_2<span class="number">.2</span><span class="number">.5</span> (<span class="number">3</span>)</span><br><span class="line">     <span class="number">5</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   <span class="keyword">DEFAULT</span>  UND __gmon_start__</span><br><span class="line">     <span class="number">6</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   <span class="keyword">DEFAULT</span>  UND _Jv_RegisterClasses</span><br><span class="line">     <span class="number">7</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   <span class="keyword">DEFAULT</span>  UND _ITM_registerTMCloneTable</span><br><span class="line"></span><br><span class="line">$ readelf <span class="comment">--dyn-syms main2</span></span><br><span class="line"></span><br><span class="line">Symbol <span class="keyword">table</span> <span class="string">&#x27;.dynsym&#x27;</span> <span class="keyword">contains</span> <span class="number">9</span> entries:</span><br><span class="line">   Num:    <span class="keyword">Value</span>          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  <span class="keyword">LOCAL</span>  <span class="keyword">DEFAULT</span>  UND </span><br><span class="line">     <span class="number">1</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>  UND foo2<span class="variable">@VERS</span>_1<span class="number">.1</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="number">2</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   <span class="keyword">DEFAULT</span>  UND _ITM_deregisterTMCloneTab</span><br><span class="line">     <span class="number">3</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>  UND foo<span class="variable">@VERS</span>_1<span class="number">.0</span> (<span class="number">3</span>)</span><br><span class="line">     <span class="number">4</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>  UND printf<span class="variable">@GLIBC</span>_2<span class="number">.2</span><span class="number">.5</span> (<span class="number">4</span>)</span><br><span class="line">     <span class="number">5</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>  UND __libc_start_main<span class="variable">@GLIBC</span>_2<span class="number">.2</span><span class="number">.5</span> (<span class="number">4</span>)</span><br><span class="line">     <span class="number">6</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   <span class="keyword">DEFAULT</span>  UND __gmon_start__</span><br><span class="line">     <span class="number">7</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   <span class="keyword">DEFAULT</span>  UND _Jv_RegisterClasses</span><br><span class="line">     <span class="number">8</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   <span class="keyword">DEFAULT</span>  UND _ITM_registerTMCloneTable</span><br></pre></td></tr></table></figure>
<p>修改 soft link <code>libfoo.so</code> 指向的 library，<code>main1</code> 依然可以正常使用 <code>1.1</code> 版的 library，但 <code>main2</code> 無法使用 <code>1.0</code> 版的 library，會跳 <code>./main2: ./libfoo.so: version &#39;VERS_1.1&#39; not found (required by ./main2)</code> 找不到 symbol 的 error。</p>
<h3 id="Scoping"><a href="#Scoping" class="headerlink" title="Scoping"></a>Scoping</h3><p>在 symbol 集合裡，<code>local:</code> 的設置會將原本 global 的 symbol 變成 local 的，程式以及其他 shared library 無法使用到這些 symbol。這稱為 scoping 機制，算是補強 ELF 處理 C 的 global symbol scoping，因為 ELF 把所有 global symbol 當作 export symbol，這也是為什麼 Linux 下不需要特別指定哪些 global symbol 要 export 就能 export symbol（windows 就需要）。</p>
<p>上面的例子裡如果把 <code>foo.1.0.ver</code> 裡 <code>local: *;</code> 拿掉，原本其他的 export symbol 就不會被設成 local：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">$ readelf <span class="comment">--dyn-syms libfoo.1.0.so</span></span><br><span class="line"></span><br><span class="line">Symbol <span class="keyword">table</span> <span class="string">&#x27;.dynsym&#x27;</span> <span class="keyword">contains</span> <span class="number">14</span> entries:</span><br><span class="line">   Num:    <span class="keyword">Value</span>          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  <span class="keyword">LOCAL</span>  <span class="keyword">DEFAULT</span>  UND</span><br><span class="line">     <span class="number">1</span>: <span class="number">0000000000000570</span>     <span class="number">0</span> SECTION <span class="keyword">LOCAL</span>  <span class="keyword">DEFAULT</span>   <span class="number">10</span></span><br><span class="line">     <span class="number">2</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   <span class="keyword">DEFAULT</span>  UND _ITM_deregisterTMCloneTab</span><br><span class="line">     <span class="number">3</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   <span class="keyword">DEFAULT</span>  UND __gmon_start__</span><br><span class="line">     <span class="number">4</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   <span class="keyword">DEFAULT</span>  UND _Jv_RegisterClasses</span><br><span class="line">     <span class="number">5</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> NOTYPE  WEAK   <span class="keyword">DEFAULT</span>  UND _ITM_registerTMCloneTable</span><br><span class="line">     <span class="number">6</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    WEAK   <span class="keyword">DEFAULT</span>  UND __cxa_finalize<span class="variable">@GLIBC</span>_2<span class="number">.2</span><span class="number">.5</span> (<span class="number">3</span>)</span><br><span class="line">     <span class="number">7</span>: <span class="number">00000000002009</span>b8     <span class="number">0</span> NOTYPE  <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>   <span class="number">22</span> _edata</span><br><span class="line">     <span class="number">8</span>: <span class="number">00000000000006</span>c0    <span class="number">20</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>   <span class="number">12</span> foo@<span class="variable">@VERS</span>_1<span class="number">.0</span></span><br><span class="line">     <span class="number">9</span>: <span class="number">00000000002009</span>c0     <span class="number">0</span> NOTYPE  <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>   <span class="number">23</span> _end</span><br><span class="line">    <span class="number">10</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> OBJECT  <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>  ABS VERS_1<span class="number">.0</span></span><br><span class="line">    <span class="number">11</span>: <span class="number">00000000002009</span>b8     <span class="number">0</span> NOTYPE  <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>   <span class="number">23</span> __bss_start</span><br><span class="line">    <span class="number">12</span>: <span class="number">0000000000000570</span>     <span class="number">0</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>   <span class="number">10</span> _init</span><br><span class="line">    <span class="number">13</span>: <span class="number">00000000000006</span>d4     <span class="number">0</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>   <span class="number">13</span> _fini</span><br></pre></td></tr></table></figure>

<h3 id="GCC-對-symbol-version-的擴充"><a href="#GCC-對-symbol-version-的擴充" class="headerlink" title="GCC 對 symbol version 的擴充"></a>GCC 對 symbol version 的擴充</h3><p>GCC 對於 symbol version 提供兩個擴充。第一個是可以指定 symbol 的 version，例如 <code>asm(&quot;.symver foo_new, foo@VERS_1.1&quot;);</code> 指定 <code>foo_new</code> 是 symbol <code>foo</code> 的 <code>1.1</code> 版。</p>
<p>第二個擴充是允許同個 symbol 有多個版本，這補充了 Solaris 版本機制的限制。例如上面例子裡想在 1.1 版的 <code>foo()</code> 增加一個參數，但希望仍保留舊版功能好能向後相容，這時候就能以指定不同版本來達到。</p>
<figure class="highlight c"><figcaption><span>foo-1.1.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span>(<span class="string">&quot;.symver foo_old, foo@VERS_1.0&quot;</span>);</span><br><span class="line"><span class="keyword">asm</span>(<span class="string">&quot;.symver foo_new, foo@@VERS_1.1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo_old</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123; <span class="keyword">return</span> x + y; &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo_new</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> z)</span> </span>&#123; <span class="keyword">return</span> (x + y + z); &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo2</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; <span class="keyword">return</span> (x + x); &#125;</span><br></pre></td></tr></table></figure>
<p>兩個 <code>.symver</code> 分別指定 <code>foo_old()</code> 是 <code>foo</code> 的版本 <code>1.0</code>，<code>foo_new()</code> 是版本 <code>1.1</code>。因為已經用 <code>.symver</code> 自訂 <code>foo</code> 這個 symbol，如果又寫 <code>foo()</code> link 時會有 <code>multiple definition</code> 錯誤。<code>foo@@VERS_1.1</code> 表示 <code>foo</code> 預設版本是 <code>1.1</code>，一個 symbol 的預設版號只能有一個，實驗看起來預設版號會影響 compile 執行檔時記錄的 symbol。由於仍然有 <code>1.0</code> 的 <code>foo</code>，<code>main1</code> 用新版 library 仍能正常執行。</p>
<figure class="highlight h"><figcaption><span>foo-1.1.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> z)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo2</span><span class="params">(<span class="keyword">int</span> x)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>main2.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;foo-1.1.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, foo(<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, foo2(<span class="number">12</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>header 跟 library 檔一起發佈，在 compile 執行檔時讓執行檔知道有什麼 symbol，所以必須要是新版 <code>foo</code> 的 prototype，而且 function name 也要是 <code>foo</code>，而非 <code>foo_new</code>。（我想還是有別的方式可以做到同樣的事情，甚至可以刻意使用舊版 symbol，這只是我認為合理的 library 發佈以及使用方式）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">$ readelf <span class="comment">--dyn-syms libfoo.1.1.so </span></span><br><span class="line"></span><br><span class="line">Symbol <span class="keyword">table</span> <span class="string">&#x27;.dynsym&#x27;</span> <span class="keyword">contains</span> <span class="number">12</span> entries:</span><br><span class="line">   Num:    <span class="keyword">Value</span>          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">7</span>: <span class="number">0000000000000690</span>    <span class="number">20</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>   <span class="number">12</span> foo<span class="variable">@VERS</span>_1<span class="number">.0</span></span><br><span class="line">     <span class="number">8</span>: <span class="number">00000000000006</span>a4    <span class="number">28</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>   <span class="number">12</span> foo@<span class="variable">@VERS</span>_1<span class="number">.1</span></span><br><span class="line">     <span class="number">9</span>: <span class="number">00000000000006</span>c0    <span class="number">14</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>   <span class="number">12</span> foo2@<span class="variable">@VERS</span>_1<span class="number">.1</span></span><br><span class="line">    <span class="number">10</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> OBJECT  <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>  ABS VERS_1<span class="number">.0</span></span><br><span class="line">    <span class="number">11</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> OBJECT  <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>  ABS VERS_1<span class="number">.1</span></span><br><span class="line"></span><br><span class="line">$ readelf <span class="comment">--dyn-syms main2</span></span><br><span class="line"></span><br><span class="line">Symbol <span class="keyword">table</span> <span class="string">&#x27;.dynsym&#x27;</span> <span class="keyword">contains</span> <span class="number">9</span> entries:</span><br><span class="line">   Num:    <span class="keyword">Value</span>          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">1</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>  UND foo2<span class="variable">@VERS</span>_1<span class="number">.1</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="number">6</span>: <span class="number">0000000000000000</span>     <span class="number">0</span> FUNC    <span class="keyword">GLOBAL</span> <span class="keyword">DEFAULT</span>  UND foo<span class="variable">@VERS</span>_1<span class="number">.1</span> (<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Semantic-Versioning"><a href="#Semantic-Versioning" class="headerlink" title="Semantic Versioning"></a>Semantic Versioning</h2><p>由 <a target="_blank" rel="noopener" href="http://tom.preston-werner.com/">Tom Preston-Werner</a> 提出的 <a target="_blank" rel="noopener" href="http://semver.org/">Semantic Versioning</a> 以 spec 的形式提供了版號規範，例如每個數字代表的意義、何時該增加版號、如何增加版號以及如何區分版本的新舊等等。它定義的版號包含 <code>MAJOR.MINOR.PATCH</code> 三個數字，並且可以加上如 <code>-alpha</code>、<code>-beta</code> 等 pre-release 資訊。概念與上面說的 library 版號類似，interface 有變更時需增加 major verion，增加向後相容的功能時要增加 minor version，修 bug 則增加 patch version，只是它以精準定義的方式描述這些規則。</p>
<p>當然，它只定義了版號本身的規則，至於「什麼改變是有向後相容？是否更改的 interface？」等問題仍然要由開發者判斷。</p>
<h2 id="Related-posts-amp-Ref"><a href="#Related-posts-amp-Ref" class="headerlink" title="Related posts &amp; Ref"></a>Related posts &amp; Ref</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.usenix.org/legacy/publications/library/proceedings/als00/2000papers/papers/full_papers/browndavid/browndavid_html/">Library Interface Versioning in Solaris and Linux</a> / <a target="_blank" rel="noopener" href="https://www.usenix.org/legacy/publications/library/proceedings/als00/2000papers/papers/full_papers/browndavid/browndavid.pdf">pdf</a></li>
<li>《程式設計師的自我修養》ch8</li>
<li><a href="ftp://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_25.html">Using LD, the GNU linker - Version Script</a></li>
<li><a target="_blank" rel="noopener" href="http://semver.org/">Semantic Versioning</a></li>
<li><a href="/Dynamic-Linking-Basic/">Dynamic Linking Basic</a></li>
<li><a href="/Dynamic-Linking-PIC/">Dynamic Linking PIC</a></li>
<li><a href="/Dynamic-Linking-Relocation/">Dynamic Linking Relocation</a></li>
<li><a href="/Use-Shared-Library-in-Linux/">Use Shared Library in Linux</a></li>
<li><a href="/Explicit-Runtime-Linking/">Explicit Runtime Linking</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Dynamic-Linking-Relocation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Dynamic-Linking-Relocation/" class="post-title-link" itemprop="url">Dynamic Linking Relocation</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-18 22:42:42" itemprop="dateCreated datePublished" datetime="2017-03-18T22:42:42+08:00">2017-03-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2017-04-14 23:04:00" itemprop="dateModified" datetime="2017-04-14T23:04:00+08:00">2017-04-14</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Dynamic-Linking-Relocation/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Dynamic-Linking-Relocation/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a href="/Load-process/">Load process</a> 在 dynamic linking 的差別是 load 完執行檔後 OS 會先看 ELF 的 <code>.interp</code> section 知道要 load 哪個 dynamic linker，OS load dynamic linker 並將控制權先交給它，在 linux 下是 <code>/lib/x86_64-linux-gnu/ld-2.19.so</code>（很明顯也是個 shared library）。</p>
<p>dynamic linker 做的事情分成三步：</p>
<ol>
<li>啟動</li>
<li>load 所有需要的 shared library</li>
<li>relocation &amp; initialization</li>
</ol>
<p>dynamic linker 本身也是個 shared library，但它有一些限制，例如不能有依賴的 shared library、不能使用 global 變數、不能 call function 等等。在啟動階段，dynamic linker 會先找到自己的 GOT，而 GOT 第一個 entry 存的是 <code>.dynamic</code> section 的 offset。<code>.dynamic</code> section 保存了 dynamic linker 需要的資訊，例如依賴哪些 shared library，dynamic symbol table、dynamic relocation table 的位置等等。<code>readelf -d</code> 可以查看 <code>.dynamic</code> section。</p>
<p>透過 <code>.dynamic</code> 裡的資訊，linker 可以知道自己的 relocation table 以及 symbol table，能對自己進行 relocation。linker 做完針對自己的 relocation 後，才能開始使用 global 變數、call function 等等。</p>
<p>啟動完成後，dynamic linker 將自己的 symbol 以及 executable file 的 symbol 合併到 global symbol table。接著開始從 executable file 的  <code>.dynamic</code> 得知依賴哪些 shared library，一一打開 shared library 並將之 load 到 memory 中、建立 mapping，並且將 shared library 的 symbol 合併到 global symbol table，再搜尋 shared library 的 dependency。如此 traverse 整棵 shared library dependency tree 之後，即 load 完所需的 shared library。通常會以 BFS traverse dependency tree。</p>
<p>symbol 的部份，ELF 以 dynamic symbol table 保存模組間 import 及 export symbol 的關係，位於 <code>.dynsym</code>，作用以及記錄的資訊跟 <code>.symtab</code> 差不多，但只記錄給其他模組使用的 symbol 以及使用其他模組的 symbol。</p>
<p>traverse dependency tree 的順序跟 symbol 的優先度有關──當兩個 shared library 有相同的 symbol 時要使用誰的？在 Linux 中會優先使用先 load 的 symbol。也就是說，shared library 的 load 順序會影響 symbol 的優先度，而 link 時指定的 library 順序會影響 load 的順序。</p>
<p>接著，linker 開始 traverse executable file 以及 shared library 的 relocation table，使用 global symbol table 來修正 GOT 及 PLT 內的 address。dynamic linking 中的 relocation table <code>.rela.dyn</code> 用來修正 <code>.got</code> 及 data section，<code>.rela.plt</code> 則修正 <code>.got.plt</code> section 內的 address。relocation 完成後，如果 shared library 擁有 <code>.init</code> section，dynamic linker 會執行它以進行對 shared library 的初始化。</p>
<p>最後，dynamic linker 將控制權交給程式的入口開始執行。</p>
<h2 id="Relocation-example"><a href="#Relocation-example" class="headerlink" title="Relocation example"></a>Relocation example</h2><p>雖然簡單來說 dynamic linker 會在 load shared library 時進行 relocation，但如<a href="/Dynamic-Linking-PIC/">Dynamic Linking PIC</a>所說的，實際上 ELF 是以 lazy binding 來 bind symbol。用個簡單例子看看怎麼做的：</p>
<figure class="highlight h"><figcaption><span>foo.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __FOO_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __FOO_H</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>foo.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (x + y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight h"><figcaption><span>bar.h</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __BAR_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __BAR_H</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> n)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>bar.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;foo.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    foo(a, b);</span><br><span class="line">    foo(b, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight h"><figcaption><span>main.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;bar.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bar(<span class="number">2</span>, <span class="number">3</span>, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">$ gcc -g -shared -fPIC foo<span class="selector-class">.c</span> -o libfoo.so</span><br><span class="line">$ gcc -g -shared -fPIC bar<span class="selector-class">.c</span> -o libbar.so</span><br><span class="line">$ gcc -g <span class="selector-tag">main</span><span class="selector-class">.c</span> ./libfoo<span class="selector-class">.so</span> ./libbar<span class="selector-class">.so</span> -o main</span><br></pre></td></tr></table></figure>
<p>最後編 executable file 時指定的 library 順序會影響 load library 的順序。</p>
<p>在 <code>main()</code>、<code>bar()</code> 跟 <code>foo()</code> 設中斷點，停在 <code>main()</code> 之後觀察 <code>foo</code> 的 relocation 資訊：</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">$ gdb ./main</span><br><span class="line">Reading symbols <span class="keyword">from</span> ./main...done.</span><br><span class="line">(gdb) b main</span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0</span>x40067a: <span class="keyword">file</span> main.c, line <span class="number">5</span>.</span><br><span class="line">(gdb) b bar</span><br><span class="line">Breakpoint <span class="number">2</span> at <span class="number">0</span>x400550</span><br><span class="line">(gdb) b foo</span><br><span class="line">Function <span class="string">&quot;foo&quot;</span> not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint <span class="number">3</span> (foo) pending.</span><br><span class="line">(gdb) r</span><br><span class="line">Starting program: <span class="regexp">/home/</span>cjw<span class="regexp">/source/</span>dynamic-link<span class="regexp">/relocate/m</span>ain</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">1</span>, main () at main.c:<span class="number">5</span></span><br><span class="line"><span class="number">5</span>           bar(<span class="number">2</span>, <span class="number">3</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">$ cat <span class="regexp">/proc/</span>`pgrep main`/maps</span><br><span class="line"><span class="number">00400000</span>-<span class="number">00401000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">24</span> <span class="number">8259464</span>                            <span class="regexp">/home/</span>cjw<span class="regexp">/source/</span>dynamic-link<span class="regexp">/relocate/m</span>ain</span><br><span class="line"><span class="number">00600000</span>-<span class="number">00601000</span> rw-p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">24</span> <span class="number">8259464</span>                            <span class="regexp">/home/</span>cjw<span class="regexp">/source/</span>dynamic-link<span class="regexp">/relocate/m</span>ain</span><br><span class="line"><span class="number">7</span>ffff762f000-<span class="number">7</span>ffff77d0000 r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">22</span> <span class="number">1572872</span>                    <span class="regexp">/lib/</span>x86_64-linux-gnu/libc-<span class="number">2.19</span>.so</span><br><span class="line"><span class="number">7</span>ffff77d0000-<span class="number">7</span>ffff79d0000 ---p <span class="number">001</span>a1000 <span class="number">08</span>:<span class="number">22</span> <span class="number">1572872</span>                    <span class="regexp">/lib/</span>x86_64-linux-gnu/libc-<span class="number">2.19</span>.so</span><br><span class="line"><span class="number">7</span>ffff79d0000-<span class="number">7</span>ffff79d4000 r--p <span class="number">001</span>a1000 <span class="number">08</span>:<span class="number">22</span> <span class="number">1572872</span>                    <span class="regexp">/lib/</span>x86_64-linux-gnu/libc-<span class="number">2.19</span>.so</span><br><span class="line"><span class="number">7</span>ffff79d4000-<span class="number">7</span>ffff79d6000 rw-p <span class="number">001</span>a5000 <span class="number">08</span>:<span class="number">22</span> <span class="number">1572872</span>                    <span class="regexp">/lib/</span>x86_64-linux-gnu/libc-<span class="number">2.19</span>.so</span><br><span class="line"><span class="number">7</span>ffff79d6000-<span class="number">7</span>ffff79da000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line"><span class="number">7</span>ffff79da000-<span class="number">7</span>ffff79db000 r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">24</span> <span class="number">8259463</span>                    <span class="regexp">/home/</span>cjw<span class="regexp">/source/</span>dynamic-link<span class="regexp">/relocate/</span>libbar.so</span><br><span class="line"><span class="number">7</span>ffff79db000-<span class="number">7</span>ffff7bda000 ---p <span class="number">00001000</span> <span class="number">08</span>:<span class="number">24</span> <span class="number">8259463</span>                    <span class="regexp">/home/</span>cjw<span class="regexp">/source/</span>dynamic-link<span class="regexp">/relocate/</span>libbar.so</span><br><span class="line"><span class="number">7</span>ffff7bda000-<span class="number">7</span>ffff7bdb000 rw-p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">24</span> <span class="number">8259463</span>                    <span class="regexp">/home/</span>cjw<span class="regexp">/source/</span>dynamic-link<span class="regexp">/relocate/</span>libbar.so</span><br><span class="line"><span class="number">7</span>ffff7bdb000-<span class="number">7</span>ffff7bdc000 r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">24</span> <span class="number">8259445</span>                    <span class="regexp">/home/</span>cjw<span class="regexp">/source/</span>dynamic-link<span class="regexp">/relocate/</span>libfoo.so</span><br><span class="line"><span class="number">7</span>ffff7bdc000-<span class="number">7</span>ffff7ddb000 ---p <span class="number">00001000</span> <span class="number">08</span>:<span class="number">24</span> <span class="number">8259445</span>                    <span class="regexp">/home/</span>cjw<span class="regexp">/source/</span>dynamic-link<span class="regexp">/relocate/</span>libfoo.so</span><br><span class="line"><span class="number">7</span>ffff7ddb000-<span class="number">7</span>ffff7ddc000 rw-p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">24</span> <span class="number">8259445</span>                    <span class="regexp">/home/</span>cjw<span class="regexp">/source/</span>dynamic-link<span class="regexp">/relocate/</span>libfoo.so</span><br><span class="line"><span class="number">7</span>ffff7ddc000-<span class="number">7</span>ffff7dfc000 r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">22</span> <span class="number">1572869</span>                    <span class="regexp">/lib/</span>x86_64-linux-gnu/ld-<span class="number">2.19</span>.so</span><br><span class="line"><span class="number">7</span>ffff7fd5000-<span class="number">7</span>ffff7fd8000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line"><span class="number">7</span>ffff7ff6000-<span class="number">7</span>ffff7ff8000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line"><span class="number">7</span>ffff7ff8000-<span class="number">7</span>ffff7ffa000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vdso]</span><br><span class="line"><span class="number">7</span>ffff7ffa000-<span class="number">7</span>ffff7ffc000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vvar]</span><br><span class="line"><span class="number">7</span>ffff7ffc000-<span class="number">7</span>ffff7ffd000 r--p <span class="number">00020000</span> <span class="number">08</span>:<span class="number">22</span> <span class="number">1572869</span>                    <span class="regexp">/lib/</span>x86_64-linux-gnu/ld-<span class="number">2.19</span>.so</span><br><span class="line"><span class="number">7</span>ffff7ffd000-<span class="number">7</span>ffff7ffe000 rw-p <span class="number">00021000</span> <span class="number">08</span>:<span class="number">22</span> <span class="number">1572869</span>                    <span class="regexp">/lib/</span>x86_64-linux-gnu/ld-<span class="number">2.19</span>.so</span><br><span class="line"><span class="number">7</span>ffff7ffe000-<span class="number">7</span>ffff7fff000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line"><span class="number">7</span>ffffffdd000-<span class="number">7</span>ffffffff000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [stack]</span><br><span class="line">ffffffffff600000-ffffffffff601000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                  [vsyscall]</span><br><span class="line"></span><br><span class="line">$ readelf -r libbar.so</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rela.dyn&#x27;</span> at offset <span class="number">0</span>x430 contains <span class="number">8</span> entries:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rela.plt&#x27;</span> at offset <span class="number">0</span>x4f0 contains <span class="number">3</span> entries:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line"><span class="number">000000200980</span>  <span class="number">000300000007</span> R_X86_64_JUMP_SLO <span class="number">0000000000000000</span> __gmon_start__ + <span class="number">0</span></span><br><span class="line"><span class="number">000000200988</span>  <span class="number">000400000007</span> R_X86_64_JUMP_SLO <span class="number">0000000000000000</span> foo + <span class="number">0</span></span><br><span class="line"><span class="number">000000200990</span>  <span class="number">000700000007</span> R_X86_64_JUMP_SLO <span class="number">0000000000000000</span> __cxa_finalize + <span class="number">0</span></span><br><span class="line"></span><br><span class="line">(gdb) x/<span class="number">1</span>xbg <span class="number">0</span>x7ffff79da000+<span class="number">0</span>x000000200988</span><br><span class="line"><span class="number">0</span>x7ffff7bda988: <span class="number">0</span>x00007ffff79da586</span><br><span class="line"></span><br><span class="line">(gdb) info address foo</span><br><span class="line">Symbol <span class="string">&quot;foo&quot;</span> is a function at address <span class="number">0</span>x7ffff7bdb660.</span><br></pre></td></tr></table></figure>
<p><code>libbar.so</code> 裡需要修正 address 的位置是 <code>0x7ffff79da000 + 0x000000200988</code>，因為 library 要到 load 的時候才能知道起始位置，所以必須用 offset 算出要修改的地方，因為還沒用過 <code>foo</code>，這個 address 的內容還不是 <code>foo</code> 的 address。</p>
<figure class="highlight tap"><table><tr><td class="code"><pre><span class="line">$ readelf -S libbar.so</span><br><span class="line">...</span><br><span class="line">  [20] .got.plt          PROGBITS        <span class="number"> 0000000000200968 </span> 00000968</span><br><span class="line">      <span class="number"> 0000000000000030 </span><span class="number"> 0000000000000008 </span> WA      <span class="number"> 0 </span>   <span class="number"> 0 </span>    8</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>從 relocation entry 來看，relocate 的 offset 是 <code>0x000000200988</code>，在 <code>.got.plt</code> 裡。<code>0x7ffff7bda988</code> 這個位置在 load <code>libbar.so</code> 的第三個 segment，屬性是 <code>rw-p</code>，是可以修改的。</p>
<p>繼續跑看第一次 call <code>foo()</code>：</p>
<figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">2</span>, bar (a=<span class="number">2</span>, b=<span class="number">3</span>, <span class="built_in">n</span>=<span class="number">10</span>) at bar.<span class="symbol">c:7</span></span><br><span class="line"><span class="number">7</span>           foo(a, b);</span><br><span class="line">(gdb) x/<span class="number">10</span>i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79da6b1 &lt;bar+<span class="number">17</span>&gt;<span class="symbol">:</span>     mov    -<span class="number">0</span>x8(%rbp),%edx</span><br><span class="line">   <span class="number">0</span>x7ffff79da6b4 &lt;bar+<span class="number">20</span>&gt;<span class="symbol">:</span>     mov    -<span class="number">0</span>x4(%rbp),%eax</span><br><span class="line">   <span class="number">0</span>x7ffff79da6b7 &lt;bar+<span class="number">23</span>&gt;<span class="symbol">:</span>     mov    %edx,%esi</span><br><span class="line">   <span class="number">0</span>x7ffff79da6b9 &lt;bar+<span class="number">25</span>&gt;<span class="symbol">:</span>     mov    %eax,%edi</span><br><span class="line">   <span class="number">0</span>x7ffff79da6bb &lt;bar+<span class="number">27</span>&gt;<span class="symbol">:</span>     callq  <span class="number">0</span>x7ffff79da580 &lt;foo@plt&gt;</span><br><span class="line">   <span class="number">0</span>x7ffff79da6c0 &lt;bar+<span class="number">32</span>&gt;<span class="symbol">:</span>     mov    -<span class="number">0</span>xc(%rbp),%edx</span><br><span class="line">   <span class="number">0</span>x7ffff79da6c3 &lt;bar+<span class="number">35</span>&gt;<span class="symbol">:</span>     mov    -<span class="number">0</span>x8(%rbp),%eax</span><br><span class="line">   <span class="number">0</span>x7ffff79da6c6 &lt;bar+<span class="number">38</span>&gt;<span class="symbol">:</span>     mov    %edx,%esi</span><br><span class="line">   <span class="number">0</span>x7ffff79da6c8 &lt;bar+<span class="number">40</span>&gt;<span class="symbol">:</span>     mov    %eax,%edi</span><br><span class="line">   <span class="number">0</span>x7ffff79da6ca &lt;bar+<span class="number">42</span>&gt;<span class="symbol">:</span>     callq  <span class="number">0</span>x7ffff79da580 &lt;foo@plt&gt;</span><br><span class="line">(gdb) b *<span class="number">0</span>x7ffff79da6bb</span><br><span class="line">(gdb) c</span><br><span class="line">(gdb) x/<span class="number">1</span>i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79da6bb &lt;bar+<span class="number">27</span>&gt;<span class="symbol">:</span>     callq  <span class="number">0</span>x7ffff79da580 &lt;foo@plt&gt;</span><br><span class="line">(gdb) si</span><br><span class="line"><span class="number">0</span>x00007ffff79da580 in foo@plt () from ./libbar.so</span><br><span class="line">(gdb) x/<span class="number">3</span>i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79da580 &lt;foo@plt&gt;<span class="symbol">:</span>    jmpq   *<span class="number">0</span>x200402(%rip)        # <span class="number">0</span>x7ffff7bda988</span><br><span class="line">   <span class="number">0</span>x7ffff79da586 &lt;foo@plt+<span class="number">6</span>&gt;<span class="symbol">:</span>  pushq  $<span class="number">0</span>x1</span><br><span class="line">   <span class="number">0</span>x7ffff79da58b &lt;foo@plt+<span class="number">11</span>&gt;<span class="symbol">:</span> jmpq   <span class="number">0</span>x7ffff79da560</span><br><span class="line">(gdb) si</span><br><span class="line"><span class="number">0</span>x00007ffff79da586 in foo@plt () from ./libbar.so</span><br><span class="line"><span class="symbol">2:</span> x/i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79da586 &lt;foo@plt+<span class="number">6</span>&gt;<span class="symbol">:</span>  pushq  $<span class="number">0</span>x1</span><br><span class="line">(gdb) </span><br><span class="line"><span class="number">0</span>x00007ffff79da58b in foo@plt () from ./libbar.so</span><br><span class="line"><span class="symbol">2:</span> x/i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79da58b &lt;foo@plt+<span class="number">11</span>&gt;<span class="symbol">:</span> jmpq   <span class="number">0</span>x7ffff79da560</span><br><span class="line">(gdb) </span><br><span class="line"><span class="number">0</span>x00007ffff79da560 in ?? () from ./libbar.so</span><br><span class="line"><span class="symbol">2:</span> x/i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79<span class="symbol">da560:</span>      pushq  <span class="number">0</span>x20040a(%rip)        # <span class="number">0</span>x7ffff7bda970</span><br><span class="line">(gdb) </span><br><span class="line"><span class="number">0</span>x00007ffff79da566 in ?? () from ./libbar.so</span><br><span class="line"><span class="symbol">2:</span> x/i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79<span class="symbol">da566:</span>      jmpq   *<span class="number">0</span>x20040c(%rip)        # <span class="number">0</span>x7ffff7bda978</span><br><span class="line">(gdb) x/<span class="number">3</span>i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79<span class="symbol">da566:</span>      jmpq   *<span class="number">0</span>x20040c(%rip)        # <span class="number">0</span>x7ffff7bda978</span><br><span class="line">   <span class="number">0</span>x7ffff79da56<span class="symbol">c:</span>      nopl   <span class="number">0</span>x0(%rax)</span><br><span class="line">   <span class="number">0</span>x7ffff79da570 &lt;__gmon_start__@plt&gt;<span class="symbol">:</span> jmpq   *<span class="number">0</span>x20040a(%rip)        # <span class="number">0</span>x7ffff7bda980</span><br><span class="line">(gdb) si</span><br><span class="line">_dl_runtime_resolve () at ../sysdeps/x86_64/dl-trampoline.<span class="symbol">S:34</span></span><br><span class="line"><span class="number">34</span>      ../sysdeps/x86_64/dl-trampoline.<span class="symbol">S:</span> No such file <span class="built_in">or</span> directory.</span><br><span class="line"><span class="symbol">2:</span> x/i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff7df02b0 &lt;_dl_runtime_resolve&gt;<span class="symbol">:</span>        sub    $<span class="number">0</span>x38,%rsp</span><br><span class="line">(gdb) x/<span class="number">1</span>xbg <span class="number">0</span>x7ffff7bda978</span><br><span class="line"><span class="number">0</span>x7ffff7b<span class="symbol">da978:</span> <span class="number">0</span>x00007ffff7df02b0</span><br></pre></td></tr></table></figure>
<p><code>0x7ffff79da580</code> 是 <code>foo</code> 在 PLT 裡的位置，call <code>foo()</code> 的時候會跳過去。這個位置位於 load <code>libbar.so</code> 的第一個 segment，屬性 <code>r-xp</code>，可執行，同時也代表 PLT 是被放在可執行的 segment 裡。到 <code>foo@plt</code> 後會再跳到 <code>foo</code> 在 <code>.got.plt</code> 的 entry 所指的 address，也就是前面看到的 <code>0x00007ffff79da586</code>，同時也是 <code>foo@plt</code> 的下一個指令，最後在 <code>0x7ffff79da566:      jmpq   *0x20040c(%rip)        # 0x7ffff7bda978</code> 會跳到 <code>0x7ffff7bda978</code> 記錄的位置 <code>0x00007ffff7df02b0</code>，即 <code>_dl_runtime_resolve</code> 的入口，到這邊當然是要 resolve symbol 啦，至於中間 push 的動作跟給 <code>_dl_runtime_resolve</code> 參數有關。</p>
<p>設中斷點在 call 完 <code>foo()</code> 之後，看看 resolve 完 <code>foo</code> 在 <code>.got.plt</code> 裡對應的 entry 會如何：</p>
<figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">(gdb) b *<span class="number">0</span>x7ffff79da6c0</span><br><span class="line">Breakpoint <span class="number">5</span> at <span class="number">0</span>x7ffff79da6<span class="symbol">c0:</span> file bar.c, line <span class="number">8</span>.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">3</span>, foo (x=<span class="number">2</span>, y=<span class="number">3</span>) at foo.<span class="symbol">c:3</span></span><br><span class="line"><span class="number">3</span>           return (x + y);</span><br><span class="line"><span class="symbol">2:</span> x/i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff7bdb66a &lt;foo+<span class="number">10</span>&gt;<span class="symbol">:</span>     mov    -<span class="number">0</span>x4(%rbp),%edx</span><br><span class="line"><span class="symbol">1:</span> $pc = (void (*)()) <span class="number">0</span>x7ffff7bdb66a &lt;foo+<span class="number">10</span>&gt;</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">5</span>, bar (a=<span class="number">2</span>, b=<span class="number">3</span>, <span class="built_in">n</span>=<span class="number">10</span>) at bar.<span class="symbol">c:8</span></span><br><span class="line"><span class="number">8</span>           foo(b, <span class="built_in">n</span>);</span><br><span class="line"><span class="symbol">2:</span> x/i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79da6c0 &lt;bar+<span class="number">32</span>&gt;<span class="symbol">:</span>     mov    -<span class="number">0</span>xc(%rbp),%edx</span><br><span class="line"><span class="symbol">1:</span> $pc = (void (*)()) <span class="number">0</span>x7ffff79da6c0 &lt;bar+<span class="number">32</span>&gt;</span><br><span class="line">(gdb) x/<span class="number">7</span>i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79da6c0 &lt;bar+<span class="number">32</span>&gt;<span class="symbol">:</span>     mov    -<span class="number">0</span>xc(%rbp),%edx</span><br><span class="line">   <span class="number">0</span>x7ffff79da6c3 &lt;bar+<span class="number">35</span>&gt;<span class="symbol">:</span>     mov    -<span class="number">0</span>x8(%rbp),%eax</span><br><span class="line">   <span class="number">0</span>x7ffff79da6c6 &lt;bar+<span class="number">38</span>&gt;<span class="symbol">:</span>     mov    %edx,%esi</span><br><span class="line">   <span class="number">0</span>x7ffff79da6c8 &lt;bar+<span class="number">40</span>&gt;<span class="symbol">:</span>     mov    %eax,%edi</span><br><span class="line">   <span class="number">0</span>x7ffff79da6ca &lt;bar+<span class="number">42</span>&gt;<span class="symbol">:</span>     callq  <span class="number">0</span>x7ffff79da580 &lt;foo@plt&gt;</span><br><span class="line">   <span class="number">0</span>x7ffff79da6cf &lt;bar+<span class="number">47</span>&gt;<span class="symbol">:</span>     leaveq </span><br><span class="line">   <span class="number">0</span>x7ffff79da6d0 &lt;bar+<span class="number">48</span>&gt;<span class="symbol">:</span>     retq   </span><br><span class="line">(gdb) x/<span class="number">1</span>xbg <span class="number">0</span>x7ffff79da000+<span class="number">0</span>x000000200988</span><br><span class="line"><span class="number">0</span>x7ffff7b<span class="symbol">da988:</span> <span class="number">0</span>x00007ffff7bdb660</span><br><span class="line">(gdb) <span class="built_in">info</span> <span class="built_in">address</span> foo</span><br><span class="line">Symbol <span class="string">&quot;foo&quot;</span> is a function at <span class="built_in">address</span> <span class="number">0</span>x7ffff7bdb660.</span><br></pre></td></tr></table></figure>
<p>出現 <code>foo</code> 的 address 啦！</p>
<p>再看第二次 call <code>foo()</code> 會怎樣：</p>
<figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">(gdb) b *<span class="number">0</span>x7ffff79da6ca</span><br><span class="line">Breakpoint <span class="number">6</span> at <span class="number">0</span>x7ffff79da6<span class="symbol">ca:</span> file bar.c, line <span class="number">8</span>.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">6</span>, <span class="number">0</span>x00007ffff79da6ca in bar (a=<span class="number">2</span>, b=<span class="number">3</span>, <span class="built_in">n</span>=<span class="number">10</span>) at bar.<span class="symbol">c:8</span></span><br><span class="line"><span class="number">8</span>           foo(b, <span class="built_in">n</span>);</span><br><span class="line"><span class="symbol">2:</span> x/i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79da6ca &lt;bar+<span class="number">42</span>&gt;<span class="symbol">:</span>     callq  <span class="number">0</span>x7ffff79da580 &lt;foo@plt&gt;</span><br><span class="line">(gdb) si</span><br><span class="line"><span class="number">0</span>x00007ffff79da580 in foo@plt () from ./libbar.so</span><br><span class="line"><span class="symbol">2:</span> x/i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79da580 &lt;foo@plt&gt;<span class="symbol">:</span>    jmpq   *<span class="number">0</span>x200402(%rip)        # <span class="number">0</span>x7ffff7bda988</span><br><span class="line"><span class="symbol">1:</span> $pc = (void (*)()) <span class="number">0</span>x7ffff79da580 &lt;foo@plt&gt;</span><br><span class="line">(gdb) x/<span class="number">5</span>i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff79da580 &lt;foo@plt&gt;<span class="symbol">:</span>    jmpq   *<span class="number">0</span>x200402(%rip)        # <span class="number">0</span>x7ffff7bda988</span><br><span class="line">   <span class="number">0</span>x7ffff79da586 &lt;foo@plt+<span class="number">6</span>&gt;<span class="symbol">:</span>  pushq  $<span class="number">0</span>x1</span><br><span class="line">   <span class="number">0</span>x7ffff79da58b &lt;foo@plt+<span class="number">11</span>&gt;<span class="symbol">:</span> jmpq   <span class="number">0</span>x7ffff79da560</span><br><span class="line">   <span class="number">0</span>x7ffff79da590 &lt;__cxa_finalize@plt&gt;<span class="symbol">:</span> jmpq   *<span class="number">0</span>x2003fa(%rip)        # <span class="number">0</span>x7ffff7bda990</span><br><span class="line">   <span class="number">0</span>x7ffff79da596 &lt;__cxa_finalize@plt+<span class="number">6</span>&gt;<span class="symbol">:</span>       pushq  $<span class="number">0</span>x2</span><br><span class="line">(gdb) si</span><br><span class="line">foo (x=<span class="number">2</span>, y=<span class="number">3</span>) at foo.<span class="symbol">c:2</span></span><br><span class="line"><span class="number">2</span>       &#123;</span><br><span class="line"><span class="symbol">2:</span> x/i $pc</span><br><span class="line">=&gt; <span class="number">0</span>x7ffff7bdb660 &lt;foo&gt;<span class="symbol">:</span>        push   %rbp</span><br><span class="line"><span class="symbol">1:</span> $pc = (void (*)()) <span class="number">0</span>x7ffff7bdb660 &lt;foo&gt;</span><br></pre></td></tr></table></figure>
<p>一樣跳到 <code>foo@plt</code>，接著會跳到 <code>foo</code> 於 <code>.got.plt</code> 所記錄的 address，現在是 <code>foo()</code> 的 address 了所以就會進 <code>foo()</code> 了！</p>
<p>總結上面的 lazy binding 行為，call function 時會跳到 PLT 裡執行，進到 PLT 的第一個指令是跳到 symbol 於 GOT 裡所指向的位置。第一次 call 時 GOT 記錄的 address 會是 PLT 對應的下一個指令，相當於繼續執行 PLT 的 instruction，接著一路 call 到 resolve symbol 的 function 找 symbol 以及將 address 填進 GOT。之後再 call 到相同 function 一樣會先到 PLT，但第一個指令就會從 GOT 得到正確 address、跳去該 function 執行。</p>
<p>觀察 <code>main</code> 裡的 <code>bar</code> 也會有類似的情況，只是 <code>main</code> 因為是 executable file，relocation entry 的 offset 已經是 load 進 memory 的 address，可以不用像 shared library 那樣要用 load 的 memory 開頭算 offset。</p>
<h2 id="Initialization"><a href="#Initialization" class="headerlink" title="Initialization"></a>Initialization</h2><p>除了一般會進入 shared library 的 <code>.init</code> section 進行初始化外，GCC 還提供了 shared library 的 constructor 及 destructor 擴充語法，可以讓 function 在 load shared library 時執行以做更多初始化的動作，宣告語法如下：</p>
<figure class="highlight delphi"><table><tr><td class="code"><pre><span class="line">void __attribute__((<span class="function"><span class="keyword">constructor</span>)) <span class="title">init</span><span class="params">()</span>;</span></span><br><span class="line">void __attribute__((<span class="function"><span class="keyword">destructor</span>)) <span class="title">fini</span><span class="params">()</span>;</span></span><br></pre></td></tr></table></figure>
<p>使用這種 constructor 跟 destructor 必須使用系統預設的 standard runtime library 以及啟動檔案，不可以用 <code>-nostartfiles</code> 以及 <code>-nostdlib</code> 參數。constructor 會在 load shared library 時執行（執行 main 之前），而 destructor 則會在執行 <code>exit()</code> 時執行。如果是 <a href="/Explicit-Runtime-Linking/">Explicit Runtime Linking</a>，constructor 會在 <code>dlopen()</code> 時執行，destructor 則在 <code>dlclose()</code> 時執行。</p>
<h2 id="Murmur-amp-省略的細節"><a href="#Murmur-amp-省略的細節" class="headerlink" title="Murmur &amp; 省略的細節"></a>Murmur &amp; 省略的細節</h2><p>上面這樣順順列下來看起來好簡單，但其實我找 GOT 跟 PLT 到底在做什麼找～很～久～一直錯把 GOT 當 PLT，就搞不懂是在幹嘛……</p>
<p>PIC 跟 GOT/PLT 還有不少細節，例如 ELF 怎麼處理 library 內跟跨 library 的 function call？變數的 relocation 怎麼做的？resolve function 怎麼知道要找哪個 symbol？這些先暫時略過，不然我永遠寫不完……Orz</p>
<h2 id="Related-posts-amp-Ref"><a href="#Related-posts-amp-Ref" class="headerlink" title="Related posts &amp; Ref"></a>Related posts &amp; Ref</h2><ul>
<li><a href="/Dynamic-Linking-Basic/">Dynamic Linking Basic</a></li>
<li><a href="/Dynamic-Linking-PIC/">Dynamic Linking PIC</a></li>
<li><a href="/Shared-Library-Versioning/">Shared Library Versioning</a></li>
<li><a href="/Use-Shared-Library-in-Linux/">Use Shared Library in Linux</a></li>
<li><a href="/Explicit-Runtime-Linking/">Explicit Runtime Linking</a></li>
<li>《程式設計師的自我修養》ch7</li>
<li><a target="_blank" rel="noopener" href="https://www.bottomupcs.com/chapter08.xhtml">https://www.bottomupcs.com/chapter08.xhtml</a></li>
<li><a target="_blank" rel="noopener" href="https://hackmd.io/s/HkK7Uf4Ml">你所不知道的 C 語言：動態連結器篇</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Linux-Desktop-Chinese/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Linux-Desktop-Chinese/" class="post-title-link" itemprop="url">Linux Desktop 2 中文環境</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-16 20:42:15" itemprop="dateCreated datePublished" datetime="2017-03-16T20:42:15+08:00">2017-03-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Linux-Desktop-Chinese/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Linux-Desktop-Chinese/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>用 Linux 桌面最麻煩的地方之一是中文介面。我已經放棄設語系為中文，畢竟 terminal 各種 message 顯示中文實在很奇怪，但還是需要輸入法跟能看一點的字型啊啊啊啊啊……</p>
<ul>
<li>distribution：Debian 8</li>
<li>桌面環境：KDE</li>
</ul>
<h2 id="輸入法"><a href="#輸入法" class="headerlink" title="輸入法"></a>輸入法</h2><p>我先試了 scim，但用起來好像有點 bug，導致操作有點卡。後來換 hime，它的各種切換快捷鍵、符號輸入等等操作跟 windows 的中文輸入法差不多，就用它啦～</p>
<p>裝完、修改完設定檔 <code>~/.xsessionrc</code> 讓 KDE 去用它，改完 relogin。</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ sudo apt-<span class="builtin-name">get</span> install hime hime-chewing</span><br><span class="line">$ cat ~/.xsessionrc</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">GTK_IM_MODULE</span>=hime</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">XMODIFIERS</span>=@im=hime</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">QT_IM_MODULE</span>=hime</span><br></pre></td></tr></table></figure>
<h2 id="中文字型"><a href="#中文字型" class="headerlink" title="中文字型"></a>中文字型</h2><p>比較喜歡沒襯線、像麥克筆寫的字體。</p>
<p>目前覺得 Noto 系列跟 WenQuanYi Micro Hei 系列不錯。一般字體就挑順眼的，等寬字體是用 WenQuanYi Micro Hei Mono。WenQuanYi 還有正黑體的版本，但我覺得微米黑（Micro Hei）比較好看。</p>
<figure class="highlight gauss"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install <span class="built_in">fonts</span>-noto <span class="built_in">fonts</span>-wqy-microhei <span class="built_in">fonts</span>-wqy-zenhei</span><br></pre></td></tr></table></figure>
<p>Ref：<a target="_blank" rel="noopener" href="http://wiki.ubuntu.hk/w/%E4%B8%AD%E6%96%87%E5%AD%97%E5%9E%8B">http://wiki.ubuntu.hk/w/%E4%B8%AD%E6%96%87%E5%AD%97%E5%9E%8B</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/RD-murmur-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/RD-murmur-1/" class="post-title-link" itemprop="url">工程師碎碎念 1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-11 23:51:27" itemprop="dateCreated datePublished" datetime="2017-03-11T23:51:27+08:00">2017-03-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2020-08-09 11:17:09" itemprop="dateModified" datetime="2020-08-09T11:17:09+08:00">2020-08-09</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/RD-murmur-1/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="RD-murmur-1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>想不到標題只好亂寫。跟<a href="/Murmur-software-flexibility">這篇</a>有點相關，但講點別的。</p>
<p>因為某些邏輯有點複雜，修改程式很容易會改壞東西，而且改的那個人也不見得會測到所有該測的條件。</p>
<p>這種問題的解法之一是 unit test，用充分的測試保護那個 module，就能確保之後的修改比較不會改壞原本好的東西。但是那個 project 還沒裝 unit test framework，我也不熟，而且有點時間壓力，我認為先做出一個堪用的版本比架起 unit test framework 重要。</p>
<p>不過我也真的覺得要是之後改了一點 code，就可能會<del>山崩</del>，阿不是，是壞一堆沒想到的地方啊啊啊。光想到可能會 bug 相連到天邊、牽一髮動全身就覺得可怕。</p>
<p>後來我用比較彈性的做法，讓之後可以用新增 class 或一小段 code 而不修改原本 code 的方式加新的邏輯。咦？好眼熟喔！阿不就<a href="/Open-Closed-Principle/">OCP</a>？真是突然體會了為什麼那些 principle 那麼討厭「修改原有 code」，因為改原本的 code 就有風險、有可能造成意想不掉的 bug。這種事就是工程師最討厭的──我明明沒動那裡為什麼那邊會壞。</p>
<p>修改意味著可能有 bug，而且蠻高的機率需要修改，來不及架測試安全網，至少以遵守 OCP 的方式避免之後生 bug，也是一個方法。無法降低風險至零，但應該要能降低到能夠掌控。</p>
<p>設計原則也好，自動測試也好，它們只是方法不同，最終的目標是一樣的──完成一個有品質的軟體、系統。漸漸覺得，好像是看情況使用，而不見得非得如何。當然，有好設計以及自動測試的軟體是更好的。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cjwind.idv.tw/Dynamic-Linking-PIC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="cjwind">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cjwind's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Dynamic-Linking-PIC/" class="post-title-link" itemprop="url">Dynamic Linking Position-independent Code（PIC）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-03-07 23:45:15" itemprop="dateCreated datePublished" datetime="2017-03-07T23:45:15+08:00">2017-03-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2017-03-18 22:47:00" itemprop="dateModified" datetime="2017-03-18T22:47:00+08:00">2017-03-18</time>
      </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Dynamic-Linking-PIC/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Dynamic-Linking-PIC/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Dynamic-linking-遇到的問題"><a href="#Dynamic-linking-遇到的問題" class="headerlink" title="Dynamic linking 遇到的問題"></a>Dynamic linking 遇到的問題</h2><p>Dynamic linking 想解決的一大問題是 memory 浪費。直覺想法是如果能讓不同 process 都會使用到的 library 在 memory 只有一份就能節省空間。對不同 process 來說 library 的內容必須是相同的才能共用。library 主要是 instruction 以及 data （executable file 都是這樣辣），data 不可能在 process 間共用，因為每個 process 都需要它自己的 data，不然會互相干擾（好像有古代系統是共用的…），因此能共用的主要是 instruction。</p>
<p>excutable file、object file 以及 library 等 binary file 中 instruction 會以不同定址方式 access symbol，絕對定址模式會將 symbol 的 virtual address 寫進 instruction，相對定址模式則跟 instruction 及 data 之間的相對位置有關。也就是說，無論是 executable file 還是要共用的 library，instruction 都可能涉及 symbol 的 address 資訊。</p>
<p>不像 executable file，library 在 compile time 無法知道會被 load 到哪，因為系統裡會有多個 library，如果各自指定要 load 到哪可能會撞到，所以得等到 runtime 由系統決定，其中 symbol 位置也要到 runtime 才能決定。這使得 compile time 無法修改 instruction 內的 address 資訊，也就是 static linking 做的事。</p>
<p>另一方面，即使在 runtime 修改 library 的 instruction，也會造成不同 process 實際上有不同的 library instruction 而無法共用。例如 library A 使用某個外部 symbol <code>foo</code>，process 1 跟 process 2 都有使用 library A，但它們分別以 library B 跟 library C 來提供 symbol <code>foo</code> 給 library A。此時，process 1 的 <code>foo</code> 的 address 在 library B，process 2 則在 library C，runtime 修改 library A instruction 會有兩種版本。</p>
<h2 id="Position-independent-Code（PIC）"><a href="#Position-independent-Code（PIC）" class="headerlink" title="Position-independent Code（PIC）"></a>Position-independent Code（PIC）</h2><p>上面的問題基本上是因為 instruction 裡含有 symbol address 相關資訊，就出現 Position-independent Code（PIC）「與位置無關的程式碼」來解決。</p>
<p>由於 process 有各自的 data section 而且可以修改裡面的值，PIC 將 library 會被修改的部分（instruction 中的 address 相關資訊）放到 data section，讓 instruction 跟 address 無關而能共用。</p>
<p>library 的 address reference 可分為 library 內與跨 library，各自又再分成 reference 到資料或 instruction（function call 或 jump），處理方式主要依據 library 內或跨 library 而不同。</p>
<h3 id="library-內"><a href="#library-內" class="headerlink" title="library 內"></a>library 內</h3><p>同一 library 內的 instruction 跟資料間相對位置是固定的，所以可以用相對位置來 access 資料、call function 或 jump。</p>
<h3 id="跨-library"><a href="#跨-library" class="headerlink" title="跨 library"></a>跨 library</h3><p>ELF 在 data section 放一個指向其他 library 的 symbol 的 pointer array，稱為 Global Offset Table（GOT）。instruction 可以從 GOT 找到對應的 element 進行間接 reference。先找到 GOT（不同平台有不同作法，可以用相對定址也可以有特殊 register 記錄），再從 GOT 以及 instruction 所知道的「該 symbol 在 GOT 裡的 offset」得到 element，最後得到 symbol address。</p>
<p>GOT 由 linker 載入 library 時填填內容，同樣使用 relocation table 的 entry 標示需要修改的位置及如何修改。relocation table 不會管 offset 指向的位置是什麼，改那個地方的內容就對了，放 GOT element 就會改 GOT。至於變數與 call function 的差別在 GOT element 存的是變數還是 function 的 address，不過實際上 ELF 有區分變數跟 function，這部份下一篇再說。</p>
<p>雖然 GOT 可以達到 PIC，但代價是 access symbol 的速度會變慢，因為要先找到 GOT 再間接定址。</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight c"><figcaption><span>foo.c</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> sum;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span>* p = (<span class="keyword">int</span>*)<span class="number">123</span>;    <span class="comment">// avoid to be placed in .bss</span></span><br><span class="line">    p = &amp;sum;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">$ gcc -<span class="keyword">c</span> foo.<span class="keyword">c</span></span><br><span class="line">$ gcc -fPIC -<span class="keyword">c</span> foo.<span class="keyword">c</span> -o foo.o.pic</span><br></pre></td></tr></table></figure>
<p>有 <code>-fPIC</code> 跟沒有的差別：</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">$ objdump -d foo.o</span><br><span class="line"></span><br><span class="line">foo.o:     file format elf<span class="number">64</span>-<span class="keyword">x</span><span class="number">86</span><span class="number">-64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of <span class="keyword">section</span> .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;foo&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">55</span>                      push   <span class="variable">%rbp</span></span><br><span class="line">   <span class="number">1</span>:   <span class="number">48</span> <span class="number">89</span> e<span class="number">5</span>                mov    <span class="variable">%rsp</span><span class="punctuation">,</span><span class="variable">%rbp</span></span><br><span class="line">   <span class="number">4</span>:   <span class="number">89</span> <span class="number">7</span>d fc                mov    <span class="variable">%edi</span><span class="punctuation">,</span><span class="number">-0</span><span class="keyword">x</span><span class="number">4</span>(<span class="variable">%rbp</span>)</span><br><span class="line">   <span class="number">7</span>:   <span class="number">89</span> <span class="number">75</span> f<span class="number">8</span>                mov    <span class="variable">%esi</span><span class="punctuation">,</span><span class="number">-0</span><span class="keyword">x</span><span class="number">8</span>(<span class="variable">%rbp</span>)</span><br><span class="line"><span class="symbol">   a:</span>   <span class="number">48</span> <span class="keyword">c</span><span class="number">7</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    movq   $<span class="number">0x0</span><span class="punctuation">,</span><span class="number">0x0</span>(<span class="variable">%rip</span>)        # <span class="number">15</span> &lt;foo+<span class="number">0x15</span>&gt;</span><br><span class="line">  <span class="number">11</span>:   <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> </span><br><span class="line">  <span class="number">15</span>:   <span class="number">8</span>b <span class="number">55</span> fc                mov    <span class="number">-0</span><span class="keyword">x</span><span class="number">4</span>(<span class="variable">%rbp</span>)<span class="punctuation">,</span><span class="variable">%edx</span></span><br><span class="line">  <span class="number">18</span>:   <span class="number">8</span>b <span class="number">45</span> f<span class="number">8</span>                mov    <span class="number">-0</span><span class="keyword">x</span><span class="number">8</span>(<span class="variable">%rbp</span>)<span class="punctuation">,</span><span class="variable">%eax</span></span><br><span class="line">  <span class="number">1</span>b:   <span class="number">01</span> d<span class="number">0</span>                   <span class="keyword">add</span>    <span class="variable">%edx</span><span class="punctuation">,</span><span class="variable">%eax</span></span><br><span class="line">  <span class="number">1</span>d:   <span class="number">5</span>d                      pop    <span class="variable">%rbp</span></span><br><span class="line">  <span class="number">1</span>e:   <span class="keyword">c</span><span class="number">3</span>                      retq   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ objdump -d foo.o.pic</span><br><span class="line"></span><br><span class="line">foo.o.pic:     file format elf<span class="number">64</span>-<span class="keyword">x</span><span class="number">86</span><span class="number">-64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of <span class="keyword">section</span> .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;foo&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">55</span>                      push   <span class="variable">%rbp</span></span><br><span class="line">   <span class="number">1</span>:   <span class="number">48</span> <span class="number">89</span> e<span class="number">5</span>                mov    <span class="variable">%rsp</span><span class="punctuation">,</span><span class="variable">%rbp</span></span><br><span class="line">   <span class="number">4</span>:   <span class="number">89</span> <span class="number">7</span>d fc                mov    <span class="variable">%edi</span><span class="punctuation">,</span><span class="number">-0</span><span class="keyword">x</span><span class="number">4</span>(<span class="variable">%rbp</span>)</span><br><span class="line">   <span class="number">7</span>:   <span class="number">89</span> <span class="number">75</span> f<span class="number">8</span>                mov    <span class="variable">%esi</span><span class="punctuation">,</span><span class="number">-0</span><span class="keyword">x</span><span class="number">8</span>(<span class="variable">%rbp</span>)</span><br><span class="line"><span class="symbol">   a:</span>   <span class="number">48</span> <span class="number">8</span>b <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(<span class="variable">%rip</span>)<span class="punctuation">,</span><span class="variable">%rax</span>        # <span class="number">11</span> &lt;foo+<span class="number">0x11</span>&gt;</span><br><span class="line">  <span class="number">11</span>:   <span class="number">48</span> <span class="number">89</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="variable">%rax</span><span class="punctuation">,</span><span class="number">0x0</span>(<span class="variable">%rip</span>)        # <span class="number">18</span> &lt;foo+<span class="number">0x18</span>&gt;</span><br><span class="line">  <span class="number">18</span>:   <span class="number">8</span>b <span class="number">55</span> fc                mov    <span class="number">-0</span><span class="keyword">x</span><span class="number">4</span>(<span class="variable">%rbp</span>)<span class="punctuation">,</span><span class="variable">%edx</span></span><br><span class="line">  <span class="number">1</span>b:   <span class="number">8</span>b <span class="number">45</span> f<span class="number">8</span>                mov    <span class="number">-0</span><span class="keyword">x</span><span class="number">8</span>(<span class="variable">%rbp</span>)<span class="punctuation">,</span><span class="variable">%eax</span></span><br><span class="line">  <span class="number">1</span>e:   <span class="number">01</span> d<span class="number">0</span>                   <span class="keyword">add</span>    <span class="variable">%edx</span><span class="punctuation">,</span><span class="variable">%eax</span></span><br><span class="line">  <span class="number">20</span>:   <span class="number">5</span>d                      pop    <span class="variable">%rbp</span></span><br><span class="line">  <span class="number">21</span>:   <span class="keyword">c</span><span class="number">3</span>                      retq   </span><br></pre></td></tr></table></figure>
<p>結果是用 <code>-fPIC</code> compile 出來跟沒有用的 object file 不一樣<del>（好像廢話）</del>，而且沒有 <code>-fPIC</code> 無法 link 成 shared object。</p>
<figure class="highlight nim"><table><tr><td class="code"><pre><span class="line">$ gcc -<span class="literal">shared</span> foo.o -o foo.so</span><br><span class="line">/usr/bin/ld: foo.o: relocation <span class="type">R_X86_64_32S</span> against `sum&#x27; can <span class="keyword">not</span> be used <span class="keyword">when</span> making a <span class="literal">shared</span> <span class="keyword">object</span>; recompile <span class="keyword">with</span> -fPIC</span><br></pre></td></tr></table></figure>
<p>relocation table 如果有 <code>R_X86_64_32S</code> 定址無法變成 DSO。</p>
<figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">$ readelf -r foo.o</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rela.text&#x27; at <span class="built_in">offset</span> <span class="number">0</span>x240 contains <span class="number">2</span> entri<span class="symbol">es:</span></span><br><span class="line">  <span class="built_in">Offset</span>          <span class="built_in">Info</span>           <span class="built_in">Type</span>           Sym. <span class="built_in">Value</span>    Sym. Name + Addend</span><br><span class="line"><span class="number">00000000000</span>d  <span class="number">000300000002</span> R_X86_64_PC32     <span class="number">0000000000000000</span> .data - <span class="number">8</span></span><br><span class="line"><span class="number">000000000011</span>  <span class="number">000</span>a0000000b R_X86_64_32S      <span class="number">0000000000000000</span> <span class="built_in">sum</span> + <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rela.eh_frame&#x27; at <span class="built_in">offset</span> <span class="number">0</span>x270 contains <span class="number">1</span> entri<span class="symbol">es:</span></span><br><span class="line">  <span class="built_in">Offset</span>          <span class="built_in">Info</span>           <span class="built_in">Type</span>           Sym. <span class="built_in">Value</span>    Sym. Name + Addend</span><br><span class="line"><span class="number">000000000020</span>  <span class="number">000200000002</span> R_X86_64_PC32     <span class="number">0000000000000000</span> .<span class="built_in">text</span> + <span class="number">0</span></span><br><span class="line"></span><br><span class="line">$ readelf -r foo.o.pic</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rela.text&#x27; at <span class="built_in">offset</span> <span class="number">0</span>x278 contains <span class="number">2</span> entri<span class="symbol">es:</span></span><br><span class="line">  <span class="built_in">Offset</span>          <span class="built_in">Info</span>           <span class="built_in">Type</span>           Sym. <span class="built_in">Value</span>    Sym. Name + Addend</span><br><span class="line"><span class="number">00000000000</span>d  <span class="number">000</span>b00000009 R_X86_64_GOTPCREL <span class="number">0000000000000000</span> <span class="built_in">sum</span> - <span class="number">4</span></span><br><span class="line"><span class="number">000000000014</span>  <span class="number">000300000002</span> R_X86_64_PC32     <span class="number">0000000000000000</span> .data - <span class="number">4</span></span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rela.eh_frame&#x27; at <span class="built_in">offset</span> <span class="number">0</span>x2a8 contains <span class="number">1</span> entri<span class="symbol">es:</span></span><br><span class="line">  <span class="built_in">Offset</span>          <span class="built_in">Info</span>           <span class="built_in">Type</span>           Sym. <span class="built_in">Value</span>    Sym. Name + Addend</span><br><span class="line"><span class="number">000000000020</span>  <span class="number">000200000002</span> R_X86_64_PC32     <span class="number">0000000000000000</span> .<span class="built_in">text</span> + <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>再看看 shared library 的 section 們，只列出比較相關的部份。</p>
<figure class="highlight tap"><table><tr><td class="code"><pre><span class="line">$ gcc -fPIC -shared -o foo.so foo.c</span><br><span class="line">$ readelf -S foo.so</span><br><span class="line">There are<span class="number"> 27 </span>section headers, starting at offset 0x1170:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  ...</span><br><span class="line">  [ 3] .dynsym           DYNSYM           00000000000001f8  000001f8</span><br><span class="line">      <span class="number"> 0000000000000150 </span><span class="number"> 0000000000000018 </span>  A      <span class="number"> 4 </span>   <span class="number"> 2 </span>    8</span><br><span class="line">  [ 4] .dynstr           STRTAB          <span class="number"> 0000000000000348 </span> 00000348</span><br><span class="line">       00000000000000ab <span class="number"> 0000000000000000 </span>  A      <span class="number"> 0 </span>   <span class="number"> 0 </span>    1</span><br><span class="line">  ...</span><br><span class="line">  [ 7] .rela.dyn         RELA            <span class="number"> 0000000000000430 </span> 00000430</span><br><span class="line">       00000000000000d8 <span class="number"> 0000000000000018 </span>  A      <span class="number"> 3 </span>   <span class="number"> 0 </span>    8</span><br><span class="line">  [ 8] .rela.plt         RELA            <span class="number"> 0000000000000508 </span> 00000508</span><br><span class="line">      <span class="number"> 0000000000000030 </span><span class="number"> 0000000000000018 </span> AI      <span class="number"> 3 </span>  <span class="number"> 10 </span>    8</span><br><span class="line">  ...</span><br><span class="line">  [10] .plt              PROGBITS        <span class="number"> 0000000000000560 </span> 00000560</span><br><span class="line">      <span class="number"> 0000000000000030 </span><span class="number"> 0000000000000010 </span> AX      <span class="number"> 0 </span>   <span class="number"> 0 </span>    16</span><br><span class="line">  ...</span><br><span class="line">  [18] .dynamic          DYNAMIC         <span class="number"> 0000000000200760 </span> 00000760</span><br><span class="line">       00000000000001c0 <span class="number"> 0000000000000010 </span> WA      <span class="number"> 4 </span>   <span class="number"> 0 </span>    8</span><br><span class="line">  [19] .got              PROGBITS        <span class="number"> 0000000000200920 </span> 00000920</span><br><span class="line">      <span class="number"> 0000000000000030 </span><span class="number"> 0000000000000008 </span> WA      <span class="number"> 0 </span>   <span class="number"> 0 </span>    8</span><br><span class="line">  [20] .got.plt          PROGBITS        <span class="number"> 0000000000200950 </span> 00000950</span><br><span class="line">      <span class="number"> 0000000000000028 </span><span class="number"> 0000000000000008 </span> WA      <span class="number"> 0 </span>   <span class="number"> 0 </span>    8</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<h2 id="Lazy-Binding"><a href="#Lazy-Binding" class="headerlink" title="Lazy Binding"></a>Lazy Binding</h2><p>dynamic linking 以犧牲一點效能達到模組使用的靈活度。效能降低發生在兩個地方：程式開始執行時的 linking 工作以及 GOT 帶來的間接定址。</p>
<p>程式裡可能有很多 function 在執行過程中不會或很少被用到，例如錯誤處理跟少用的功能。一開始執行就 link 所有 library 裡的 function 顯然有點浪費，畢竟可能花時間 link 了卻沒用到。如果等到 function 第一次被使用時才 bind symbol（找 symbol、relocate 等等）可以加快程式啟動的速度，這個方法稱為 lazy binding。</p>
<p>ELF 用 Procedure Linkage Table（PLT）來實作 lazy binding。在沒有 lazy binding 前，會藉由 GOT 進行間接跳轉來 access 另一個模組的 function 。有了 lazy binding 表示一開始 load 模組時不會把 GOT 填完，所以使用 GOT 跳轉前要多一層 PLT 的處理：如果 GOT element 沒有值，會先由 dynamic linker 找到該 function 的 address，填入 GOT 後跳去該 function 執行。之後再使用到同一個 function，由於 GOT 裡已經有值，可以直接進行間接跳轉。</p>
<h2 id="Related-posts-amp-Ref"><a href="#Related-posts-amp-Ref" class="headerlink" title="Related posts &amp; Ref"></a>Related posts &amp; Ref</h2><ul>
<li><a href="/Dynamic-Linking-Basic/">Dynamic Linking Basic</a></li>
<li><a href="/Dynamic-Linking-Relocation/">Dynamic Linking Relocation</a></li>
<li><a href="/Shared-Library-Versioning/">Shared Library Versioning</a></li>
<li><a href="/Use-Shared-Library-in-Linux/">Use Shared Library in Linux</a></li>
<li><a href="/Explicit-Runtime-Linking/">Explicit Runtime Linking</a></li>
<li>《程式設計師的自我修養》ch7</li>
<li><a target="_blank" rel="noopener" href="https://www.bottomupcs.com/chapter08.xhtml">https://www.bottomupcs.com/chapter08.xhtml</a></li>
<li><a target="_blank" rel="noopener" href="https://hackmd.io/s/HkK7Uf4Ml">你所不知道的 C 語言：動態連結器篇</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cjwind</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  





<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://cjwind.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
